<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Suggestion Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #console-output {
            background: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>AI Suggestion Debug Test</h1>
    
    <div class="test-container">
        <h3>Test 1: Direct API Call</h3>
        <p>Test the AI suggestion API directly without any encoding/decoding:</p>
        <button onclick="testDirectAPI()">Test Direct API</button>
        <div id="test1-result" class="result"></div>
    </div>
    
    <div class="test-container">
        <h3>Test 2: Encoding/Decoding Test</h3>
        <p>Test the encoding and decoding process used in the main application:</p>
        <button onclick="testEncodingDecoding()">Test Encoding/Decoding</button>
        <div id="test2-result" class="result"></div>
    </div>
    
    <div class="test-container">
        <h3>Test 3: Simulate Button Click</h3>
        <p>Simulate exactly what happens when the AI icon is clicked:</p>
        <button class="ai-feedback-icon-test" 
                data-sentence-index="0" 
                data-feedback="Long%20sentence%20detected%20(29%20words).%20Consider%20breaking%20this%20into%20shorter%20sentences%20for%20better%20readability." 
                data-sentence="Modbus%20TCP%20tags%20are%20made%20available%20in%20the%20Databus%20after%20you%20have%20selected%20the%20corresponding%20option%20for%20selected%20tags."
                onclick="testButtonClick(this)">
            Simulate AI Icon Click
        </button>
        <div id="test3-result" class="result"></div>
    </div>
    
    <div class="test-container">
        <h3>Console Output</h3>
        <div id="console-output"></div>
    </div>

    <script>
        // Capture console output
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const consoleOutput = document.getElementById('console-output');
        
        function addToConsole(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            consoleOutput.textContent += `[${timestamp}] ${type}: ${message}\n`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog(...args);
            addToConsole('LOG', args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(' '));
        };
        
        console.error = function(...args) {
            originalConsoleError(...args);
            addToConsole('ERROR', args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(' '));
        };
        
        // Test 1: Direct API call
        async function testDirectAPI() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.innerHTML = '<div class="info">Testing direct API call...</div>';
            
            try {
                const testData = {
                    feedback: "Long sentence detected (29 words). Consider breaking this into shorter sentences for better readability.",
                    sentence: "Modbus TCP tags are made available in the Databus after you have selected the corresponding option for selected tags.",
                    document_type: "technical",
                    writing_goals: ["clarity", "conciseness"]
                };
                
                console.log('Direct API test data:', testData);
                
                const response = await fetch('/ai_suggestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                console.log('Direct API response status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Direct API result:', result);
                    resultDiv.innerHTML = `<div class="success">✅ Direct API call successful!<br>Suggestion: ${result.suggestion.substring(0, 100)}...</div>`;
                } else {
                    const errorText = await response.text();
                    console.error('Direct API error:', errorText);
                    resultDiv.innerHTML = `<div class="error">❌ Direct API call failed: ${response.status} - ${errorText}</div>`;
                }
            } catch (error) {
                console.error('Direct API exception:', error);
                resultDiv.innerHTML = `<div class="error">❌ Exception during direct API call: ${error.message}</div>`;
            }
        }
        
        // Test 2: Encoding/Decoding
        function testEncodingDecoding() {
            const resultDiv = document.getElementById('test2-result');
            resultDiv.innerHTML = '<div class="info">Testing encoding/decoding...</div>';
            
            try {
                const originalFeedback = "Long sentence detected (29 words). Consider breaking this into shorter sentences for better readability.";
                const originalSentence = "Modbus TCP tags are made available in the Databus after you have selected the corresponding option for selected tags.";
                
                console.log('Original data:', { originalFeedback, originalSentence });
                
                // Encode (like the HTML does)
                const encodedFeedback = encodeURIComponent(originalFeedback);
                const encodedSentence = encodeURIComponent(originalSentence);
                
                console.log('Encoded data:', { encodedFeedback, encodedSentence });
                
                // Decode (like showAIFeedback does)
                const decodedFeedback = decodeURIComponent(encodedFeedback);
                const decodedSentence = decodeURIComponent(encodedSentence);
                
                console.log('Decoded data:', { decodedFeedback, decodedSentence });
                
                // Check if they match
                const feedbackMatch = originalFeedback === decodedFeedback;
                const sentenceMatch = originalSentence === decodedSentence;
                
                console.log('Match results:', { feedbackMatch, sentenceMatch });
                
                if (feedbackMatch && sentenceMatch) {
                    resultDiv.innerHTML = '<div class="success">✅ Encoding/Decoding works correctly!</div>';
                } else {
                    resultDiv.innerHTML = `<div class="error">❌ Encoding/Decoding mismatch!<br>Feedback match: ${feedbackMatch}<br>Sentence match: ${sentenceMatch}</div>`;
                }
            } catch (error) {
                console.error('Encoding/Decoding error:', error);
                resultDiv.innerHTML = `<div class="error">❌ Encoding/Decoding error: ${error.message}</div>`;
            }
        }
        
        // Test 3: Button click simulation
        async function testButtonClick(button) {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.innerHTML = '<div class="info">Testing button click simulation...</div>';
            
            try {
                const sentenceIndex = parseInt(button.getAttribute('data-sentence-index'));
                const feedback = button.getAttribute('data-feedback');
                const sentence = button.getAttribute('data-sentence');
                
                console.log('Button data:', { sentenceIndex, feedback, sentence });
                
                // Decode (like showAIFeedback does)
                const decodedFeedback = decodeURIComponent(feedback);
                const decodedSentence = decodeURIComponent(sentence);
                
                console.log('Decoded button data:', { decodedFeedback, decodedSentence });
                
                // Test the AI suggestion call
                const aiResult = await getAISuggestionTest(decodedFeedback, decodedSentence);
                
                if (aiResult) {
                    resultDiv.innerHTML = `<div class="success">✅ Button click simulation successful!<br>AI suggestion received: ${aiResult.suggestion.substring(0, 100)}...</div>`;
                } else {
                    resultDiv.innerHTML = '<div class="error">❌ Button click simulation failed - no AI suggestion returned</div>';
                }
                
            } catch (error) {
                console.error('Button click simulation error:', error);
                resultDiv.innerHTML = `<div class="error">❌ Button click simulation error: ${error.message}</div>`;
            }
        }
        
        // Test version of getAISuggestion with detailed logging
        async function getAISuggestionTest(feedback, sentence) {
            try {
                console.log('=== AI SUGGESTION TEST DEBUG ===');
                console.log('Raw inputs:', {
                    feedback: feedback,
                    sentence: sentence,
                    feedbackType: typeof feedback,
                    sentenceType: typeof sentence,
                    feedbackLength: feedback?.length,
                    sentenceLength: sentence?.length
                });
                
                // Clean and validate required parameters
                const cleanFeedback = feedback ? feedback.trim() : '';
                const cleanSentence = sentence ? sentence.trim() : '';
                
                console.log('Cleaned inputs:', {
                    cleanFeedback: cleanFeedback,
                    cleanSentence: cleanSentence,
                    cleanFeedbackLength: cleanFeedback.length,
                    cleanSentenceLength: cleanSentence.length
                });
                
                if (!cleanFeedback || !cleanSentence) {
                    console.error('❌ VALIDATION FAILED - Missing required parameters:', { 
                        feedback: cleanFeedback, 
                        sentence: cleanSentence,
                        feedbackEmpty: !cleanFeedback,
                        sentenceEmpty: !cleanSentence
                    });
                    return null;
                }
                
                // Extract just the core issue description from feedback if it contains structured data
                let coreIssue = cleanFeedback;
                if (cleanFeedback.includes('Issue:')) {
                    const issueMatch = cleanFeedback.match(/Issue:\s*([^\n]+)/);
                    if (issueMatch) {
                        coreIssue = issueMatch[1].trim();
                        console.log('Extracted core issue:', coreIssue);
                    }
                }
                
                const requestData = {
                    feedback: coreIssue,
                    sentence: cleanSentence,
                    document_type: 'technical',
                    writing_goals: ['clarity', 'conciseness']
                };
                
                console.log('Request payload:', requestData);
                
                const response = await fetch('/ai_suggestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ AI suggestion success:', result);
                    return result;
                } else {
                    console.error('❌ AI suggestion HTTP error:', response.status);
                    const errorText = await response.text();
                    console.error('Error response body:', errorText);
                    return null;
                }
            } catch (error) {
                console.error('❌ AI suggestion exception:', error);
                console.error('Error stack:', error.stack);
                return null;
            }
        }
        
        // Auto-run first test on page load
        window.addEventListener('load', function() {
            console.log('Debug page loaded, running initial tests...');
            setTimeout(testDirectAPI, 1000);
        });
    </script>
</body>
</html>
