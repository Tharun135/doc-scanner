<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doc Scanner – Advanced Analysis</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-color: #2A3B5A;
            --secondary-color: #2A9BAA;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --highlight-color: #FFD700;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-color), #3A4D7C, var(--secondary-color));
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .navbar {
            background: linear-gradient(135deg, #4A5D9A, var(--secondary-color));
            padding: 1rem;
        }

        .sidebar {
            background: rgba(40, 55, 85, 0.9);
            height: calc(100vh - 56px);
            overflow-y: auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .dropzone {
            position: relative;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            transition: all 0.3s ease;
            padding: 20px;
            text-align: center;
            cursor: pointer;
        }

        .dropzone:hover {
            border-color: var(--secondary-color);
            background: rgba(255, 255, 255, 0.1);
        }

        .dropzone.drag-over {
            border-color: #177E89;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .content-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .document-section, .feedback-section {
            overflow-y: auto;
            padding: 1rem;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.2);
        }

        .sentence {
            transition: background-color 0.3s ease;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 2px 0;
            display: inline-block;
            line-height: 1.6;
        }

        .sentence.highlight {
            background-color: var(--highlight-color);
            color: black;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        }

        .sentence.has-feedback {
            border-left: 3px solid #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
        }

        .feedback-item {
            background: #fffbe6 !important;      /* Light yellow background */
            color: #333 !important;              /* Dark text for contrast */
            border-left: 5px solid #ffc107;      /* Emphasize with a yellow border */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .feedback-item:hover {
            background: #fff3cd !important;
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .feedback-item.highlighted {
            background: #e7f3ff !important;
            border-left-color: #007bff !important;
            animation: pulse 1s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .original-content {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .sentence-container {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
        }

        .sentence-list {
            line-height: 1.8;
        }

        .sentence-highlight {
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 1px 0;
            position: relative;
            display: inline;
            line-height: 1.6;
        }

        .sentence-highlight.highlight {
            background-color: #ffeb3b;
            color: #333;
            font-weight: 500;
            border: 1px solid #fdd835;
        }

        .sentence-highlight.has-feedback {
            background-color: rgba(255, 193, 7, 0.2);
            border-bottom: 2px solid #ff9800;
        }

        .sentence-highlight.has-feedback:hover {
            background-color: rgba(255, 193, 7, 0.3);
            border-bottom-color: #f57c00;
        }

        .sentence-highlight.sentence-not-found {
            background-color: #ffcdd2;
            border: 1px solid #f44336;
            padding: 3px 6px;
            font-size: 0.85em;
            color: #d32f2f;
            font-weight: 500;
            border-radius: 4px;
        }

        .sentence-highlight.sentence-not-found:hover {
            background-color: #ef9a9a;
        }

        .document-section table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            background: #fff;
            color: #222;
        }
        .document-section th, .document-section td {
            border: 1px solid #ccc;
            padding: 8px 12px;
            text-align: left;
        }
        .document-section th {
            background: #f7f7f7;
            font-weight: bold;
        }

        .feedback-item:hover {
            background: #ffe066 !important;      /* Slightly brighter on hover */
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .toolbar button {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-primary);
            border-radius: 3px;
            cursor: pointer;
        }

        /* Dark mode styles */
        body.dark-mode {
            --primary-color: #000000;
            --text-primary: #ffffff;
            background: linear-gradient(135deg, #000000, #1a1a1a);
        }
        #loadingOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(18,28,58,0.85);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}
.spinner-container {
    text-align: center;
    color: #FFD700;
}

/* AI Enhancement Indicators */
.ai-enhancement-badge {
    background: linear-gradient(45deg, #6c5ce7, #a29bfe);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    margin-left: 0.5rem;
}

.confidence-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: 0.25rem;
}

.confidence-high { background-color: #00b894; }
.confidence-medium { background-color: #fdcb6e; }
.confidence-low { background-color: #e17055; }

.suggestion-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    margin-bottom: 1rem;
}

.feedback-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.feedback-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.feedback-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}        .feedback-btn.active {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        /* Tab System Styles */
        .tab-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .tab-header {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .tab-button.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .tab-content {
            display: none;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .ai-feedback-icon {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 8px;
        }
        
        .ai-feedback-icon:hover {
            background: linear-gradient(45deg, #5a4fcf, #8b7ff7);
            transform: scale(1.1);
        }
        
        .ai-feedback-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;        }
        
        .performance-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    z-index: 1000;
}

        /* Enhanced AI Writing Assistant Dashboard */
        .metric-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.8rem;
    text-align: center;
    transition: all 0.3s ease;
}

.metric-card:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
}

.metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--highlight-color);
}

.metric-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 0.2rem;
}

.quality-score-container {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 0.8rem;
}

.quality-score {
    background: var(--secondary-color);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-weight: bold;
    font-size: 0.9rem;
}

.quality-progress .progress-bar {
    background: linear-gradient(90deg, #e74c3c, #f39c12, #27ae60);
    transition: width 1s ease;
}


.issues-progress {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 0.8rem;
}

.smart-insights {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 0.8rem;
}

.insight-item {
    background: rgba(255, 215, 0, 0.1);
    border-left: 3px solid var(--highlight-color);
    padding: 0.5rem;
    margin: 0.3rem 0;
    border-radius: 4px;
    font-size: 0.85rem;
}

.insight-item.active {
    background: rgba(255, 215, 0, 0.2);
    animation: pulse 2s ease-in-out infinite;
}

.quick-actions {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 0.8rem;
}

.quick-actions .btn {
    margin-bottom: 0.3rem;
    transition: all 0.3s ease;
}

.quick-actions .btn:hover:not(:disabled) {
    transform: translateX(3px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

.quick-actions .btn:disabled {
    opacity: 0.5;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

.file-list-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .file-list-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .file-list-item .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-list-item .file-size {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .file-list-item .remove-file {
            background: rgba(255, 0, 0, 0.2);
            border: none;
            color: #ff6b6b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-list-item .remove-file:hover {
            background: rgba(255, 0, 0, 0.4);
            transform: scale(1.1);
        }

        .batch-progress {
            margin-top: 1rem;
            display: none;
        }

        .batch-progress .progress-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .batch-progress .progress-item.processing {
            background: rgba(255, 193, 7, 0.2);
            border-left: 3px solid #ffc107;
        }

        .batch-progress .progress-item.completed {
            background: rgba(40, 167, 69, 0.2);
            border-left: 3px solid #28a745;
        }

        .batch-progress .progress-item.error {
            background: rgba(220, 53, 69, 0.2);
            border-left: 3px solid #dc3545;
        }

        .batch-results {
            margin-top: 1rem;
            display: none;
        }

        .batch-results .result-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .batch-results .result-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .batch-results .result-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(3px);
        }

        .batch-results .result-item.active {
            border-color: var(--secondary-color);
            background: rgba(42, 155, 170, 0.2);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-check-circle"></i> Doc Scanner</a>
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-light btn-sm me-2" id="historyBtn">
                    <i class="fas fa-history"></i> History
                </button>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="darkModeToggle">
                    <label class="form-check-label" for="darkModeToggle">Dark Mode</label>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar d-none d-md-block col-md-3 p-3">
            <!-- Upload Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-upload"></i> Upload Document</h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div id="dropzone" class="dropzone mb-3">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                            <p>Drag & Drop files here or</p>
                            <div class="d-flex justify-content-center gap-3 mt-2">
                                <button type="button" class="btn btn-outline-light btn-sm" id="browseBtn">Browse Files</button>
                                <button type="button" class="btn btn-outline-light btn-sm" id="browseBatchBtn">Browse Zip</button>
                            </div>
                            <input type="file" id="fileInput" accept=".pdf,.md,.adoc,.docx,.txt" style="display: none;">
                            <input type="file" id="batchFileInput" accept=".zip" style="display: none;">
                            <input type="file" id="multiFileInput" accept=".pdf,.md,.adoc,.docx,.txt" multiple style="display: none;">
                        </div>
                        <div id="fileList" class="mb-3" style="display: none;">
                            <h6>Selected Files:</h6>
                            <div id="fileListItems"></div>
                        </div>
                        <button class="btn btn-primary w-100" type="submit">
                            <i class="fas fa-upload"></i> <span id="uploadBtnText">Upload & Analyze</span>
                            <span class="ai-enhancement-badge">AI Enhanced</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- AI Writing Assistant Dashboard -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-brain"></i> AI Writing Assistant</h5>
                </div>
                <div class="card-body">
                    <!-- Document Metrics -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="metric-card">
                                <div class="metric-value" id="wordCount">0</div>
                                <div class="metric-label">Words</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-card">
                                <div class="metric-value" id="sentenceCount">0</div>
                                <div class="metric-label">Sentences</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Writing Quality Score -->
                    <div class="quality-score-container mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">Writing Quality</span>
                            <span class="quality-score" id="qualityScore">-</span>
                        </div>
                        <div class="progress quality-progress">
                            <div class="progress-bar" role="progressbar" id="qualityProgressBar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="qualityDescription">Upload text to see quality metrics</small>
                    </div>
                    

                    <!-- Issues Progress -->
                    <div class="issues-progress mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">Issues Detected</span>
                            <span class="badge bg-warning" id="issuesStats">0</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" role="progressbar" id="issuesProgressBar" style="width: 100%"></div>
                        </div>
                        <small class="text-muted" id="issuesDescription">No issues detected</small>
                    </div>
                    
                    <!-- Smart Insights -->
                    <div class="smart-insights mb-3">
                        <div class="fw-bold mb-2"><i class="fas fa-lightbulb"></i> Smart Insights</div>
                        <div id="smartInsightsList">
                            <div class="insight-item text-muted">
                                <i class="fas fa-info-circle"></i> Upload text to get personalized insights
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions">
                        <div class="fw-bold mb-2"><i class="fas fa-magic"></i> Quick Actions</div>
                        <div class="btn-group-vertical w-100" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" id="fixAllBtn" disabled>
                                <i class="fas fa-check-double"></i> Apply All Suggestions
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="readabilityBtn" disabled>
                                <i class="fas fa-eye"></i> Improve Readability
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" id="summaryBtn" disabled>
                                <i class="fas fa-file-alt"></i> Generate Summary
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Report -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Analysis Report</h5>
                </div>
                <div class="card-body">
                    <canvas id="analysisChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content col-md-9 p-3">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4>Document Content & Feedback</h4>
                        <div class="toolbar">
                            <button id="exportBtn"><i class="fas fa-download"></i> Export</button>
                            <button id="settingsBtn"><i class="fas fa-cog"></i> Settings</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="content-container">
                        <div class="document-section" id="documentContent">
                            <h4>Document Content</h4>
                        </div>
                        <div class="feedback-section">
                            <!-- Tab Container -->
                            <div class="tab-container">
                                <div class="tab-header">
                                    <button class="tab-button active" onclick="switchTab('feedback')">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Issues
                                    </button>
                                    <button class="tab-button" onclick="switchTab('ai-feedback')">
                                        <i class="fas fa-robot me-1"></i>
                                        AI Assistance
                                    </button>
                                </div>
                                <div class="tab-content active" id="feedbackContent">
                                    <h5 class="mb-3">Document Issues</h5>
                                    <!-- Feedback content will be populated here -->
                                </div>
                                <div class="tab-content" id="aiFeedbackContent">
                                    <h5 class="mb-3">AI-Powered Suggestions</h5>
                                    <div class="text-muted text-center py-4">
                                        <i class="fas fa-robot fa-2x mb-2"></i>
                                        <p>Click the AI icon next to any issue to get intelligent suggestions</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // File upload handling
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const batchFileInput = document.getElementById('batchFileInput');
        const multiFileInput = document.getElementById('multiFileInput');
        const browseBtn = document.getElementById('browseBtn');
        const browseBatchBtn = document.getElementById('browseBatchBtn');
        const uploadForm = document.getElementById('uploadForm');
        let analysisChart;
        let selectedFiles = [];
        let batchResults = [];

        // Handle browse button clicks
        browseBtn.addEventListener('click', () => {
            multiFileInput.click();
        });

        browseBatchBtn.addEventListener('click', () => {
            batchFileInput.click();
        });

        // Handle file input changes
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                selectedFiles = Array.from(files);
                updateFileList();
                // Clear the input to allow selecting more files
                e.target.value = '';
            }
        });

        multiFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                // Add new files to existing selection instead of replacing
                const newFiles = Array.from(files);
                
                // Filter out duplicates based on file name and size
                const filteredNewFiles = newFiles.filter(newFile => {
                    return !selectedFiles.some(existingFile => 
                        existingFile.name === newFile.name && existingFile.size === newFile.size
                    );
                });
                
                if (filteredNewFiles.length > 0) {
                    selectedFiles = [...selectedFiles, ...filteredNewFiles];
                    updateFileList();
                }
                
                // Clear the input to allow selecting the same files again if needed
                e.target.value = '';
            }
        });

        batchFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                selectedFiles = Array.from(files);
                updateFileList();
                // Clear the input to allow selecting more files
                e.target.value = '';
            }
        });

        // Drag and drop handlers
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('drag-over');
        });

        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const newFiles = Array.from(files);
                
                // Filter out duplicates based on file name and size
                const filteredNewFiles = newFiles.filter(newFile => {
                    return !selectedFiles.some(existingFile => 
                        existingFile.name === newFile.name && existingFile.size === newFile.size
                    );
                });
                
                if (filteredNewFiles.length > 0) {
                    selectedFiles = [...selectedFiles, ...filteredNewFiles];
                    updateFileList();
                }
            }
        });

        // Update file list display
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const fileListItems = document.getElementById('fileListItems');
            const uploadBtnText = document.getElementById('uploadBtnText');
            
            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                uploadBtnText.textContent = 'Upload & Analyze';
                resetDropzone();
                return;
            }

            fileList.style.display = 'block';
            fileListItems.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-list-item';
                
                const fileSize = formatFileSize(file.size);
                const fileIcon = getFileIcon(file.name);
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <i class="${fileIcon}"></i>
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">(${fileSize})</span>
                    </div>
                    <button type="button" class="remove-file" onclick="removeFile(${index})" title="Remove file">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                fileListItems.appendChild(fileItem);
            });

            // Update upload button text
            if (selectedFiles.length === 1) {
                uploadBtnText.textContent = 'Upload & Analyze 1 File';
            } else {
                uploadBtnText.textContent = `Upload & Analyze ${selectedFiles.length} Files`;
            }

            // Update dropzone display
            const isZip = selectedFiles.some(file => file.name.toLowerCase().endsWith('.zip'));
            dropzone.innerHTML = `
                <i class="fas fa-${isZip ? 'file-archive' : 'files'} fa-2x mb-2"></i>
                <p>${selectedFiles.length} file${selectedFiles.length > 1 ? 's' : ''} selected</p>
                <div class="d-flex justify-content-center gap-3 mt-2">
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="selectMoreFiles()">Add More</button>
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="clearFiles()">Clear All</button>
                </div>
            `;
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        }

        function selectMoreFiles() {
            multiFileInput.click();
        }

        function clearFiles() {
            selectedFiles = [];
            updateFileList();
        }

        function resetDropzone() {
            dropzone.innerHTML = `
                <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                <p>Drag & Drop files here or</p>
                <div class="d-flex justify-content-center gap-3 mt-2">
                    <button type="button" class="btn btn-outline-light btn-sm" id="browseBtn">Browse Files</button>
                    <button type="button" class="btn btn-outline-light btn-sm" id="browseBatchBtn">Browse Zip</button>
                </div>
            `;
            
            // Re-attach event listeners
            document.getElementById('browseBtn').addEventListener('click', () => multiFileInput.click());
            document.getElementById('browseBatchBtn').addEventListener('click', () => batchFileInput.click());
        }

        function getFileIcon(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const iconMap = {
                'pdf': 'fas fa-file-pdf text-danger',
                'md': 'fab fa-markdown text-primary',
                'adoc': 'fas fa-file-alt text-success',
                'docx': 'fas fa-file-word text-primary',
                'doc': 'fas fa-file-word text-primary',
                'txt': 'fas fa-file-alt text-muted',
                'zip': 'fas fa-file-archive text-warning'
            };
            return iconMap[ext] || 'fas fa-file text-muted';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (selectedFiles.length === 0) {
                alert('Please select at least one file first.');
                return;
            }

            // Show spinner
            document.getElementById('loadingOverlay').style.display = 'flex';

            const submitBtn = uploadForm.querySelector('button[type="submit"]');
            const originalBtnContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            submitBtn.disabled = true;

            try {
                if (selectedFiles.length === 1) {
                    // Single file upload (existing logic)
                    await processSingleFile(selectedFiles[0]);
                } else {
                    // Batch upload
                    await processBatchFiles(selectedFiles);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('An error occurred during upload: ' + error.message);
            } finally {
                // Hide spinner
                document.getElementById('loadingOverlay').style.display = 'none';
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.disabled = false;
            }
        });

        async function processSingleFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Upload failed');

            const result = await response.json();
            renderChart(result.report || {}, result.sentences || []);
            renderContent(result.content || '', result.sentences || []);
        }

        async function processBatchFiles(files) {
            batchResults = [];
            showBatchProgress();

            // Check if there's a zip file
            const zipFile = files.find(file => file.name.toLowerCase().endsWith('.zip'));
            
            if (zipFile) {
                await processBatchZip(zipFile);
            } else {
                await processBatchIndividual(files);
            }

            showBatchResults();
            
            // Automatically display the first successful file's content
            const firstSuccessfulResult = batchResults.find(result => result.success);
            if (firstSuccessfulResult) {
                renderChart(firstSuccessfulResult.report || {}, firstSuccessfulResult.sentences || []);
                renderContent(firstSuccessfulResult.content || '', firstSuccessfulResult.sentences || []);
                
                // Add indicator showing which file is currently displayed
                const fileInfo = document.createElement('div');
                fileInfo.className = 'alert alert-info';
                fileInfo.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    Currently viewing: <strong>${firstSuccessfulResult.filename}</strong> 
                    <small class="text-muted">(Click on other files in the batch results to view them)</small>
                `;
                
                const documentContent = document.getElementById('documentContent');
                const existingInfo = documentContent.querySelector('.alert.alert-info');
                if (existingInfo) existingInfo.remove();
                documentContent.insertBefore(fileInfo, documentContent.firstChild.nextSibling);
                
                // Highlight the first result as active
                setTimeout(() => {
                    const firstResultIndex = batchResults.findIndex(result => result.success);
                    if (firstResultIndex >= 0) {
                        const resultItems = document.querySelectorAll('.result-item');
                        if (resultItems[firstResultIndex]) {
                            resultItems[firstResultIndex].classList.add('active');
                        }
                    }
                }, 100);
            }
        }

        async function processBatchZip(zipFile) {
            updateProgressItem(zipFile.name, 'processing', 'Extracting zip file...');

            const formData = new FormData();
            formData.append('file', zipFile);
            formData.append('batch_mode', 'true');

            try {
                const response = await fetch('/upload_batch', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Batch upload failed');

                const result = await response.json();
                
                if (result.success && result.results) {
                    batchResults = result.results;
                    updateProgressItem(zipFile.name, 'completed', `Processed ${result.results.length} files`);
                } else {
                    throw new Error(result.error || 'Batch processing failed');
                }
            } catch (error) {
                updateProgressItem(zipFile.name, 'error', `Error: ${error.message}`);
                throw error;
            }
        }

        async function processBatchIndividual(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateProgressItem(file.name, 'processing', 'Analyzing...');

                try {
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error(`Upload failed for ${file.name}`);

                    const result = await response.json();
                    
                    batchResults.push({
                        filename: file.name,
                        success: true,
                        content: result.content,
                        sentences: result.sentences,
                        report: result.report,
                        summary: {
                            totalSentences: result.sentences.length,
                            totalIssues: result.sentences.reduce((count, s) => count + (s.feedback ? s.feedback.length : 0), 0),
                            qualityScore: calculateQualityScore(result.sentences)
                        }
                    });

                    updateProgressItem(file.name, 'completed', 'Analysis complete');
                } catch (error) {
                    batchResults.push({
                        filename: file.name,
                        success: false,
                        error: error.message
                    });
                    updateProgressItem(file.name, 'error', `Error: ${error.message}`);
                }
            }
        }

        function calculateQualityScore(sentences) {
            if (sentences.length === 0) return 0;
            const issues = sentences.reduce((count, s) => count + (s.feedback ? s.feedback.length : 0), 0);
            return Math.max(0, Math.round((1 - issues / sentences.length) * 100));
        }

        function showBatchProgress() {
            const progressDiv = document.createElement('div');
            progressDiv.id = 'batchProgress';
            progressDiv.className = 'batch-progress';
            progressDiv.innerHTML = `
                <h6><i class="fas fa-tasks"></i> Processing Files</h6>
                <div id="progressItems"></div>
            `;
            
            // Insert after file list
            const fileList = document.getElementById('fileList');
            fileList.parentNode.insertBefore(progressDiv, fileList.nextSibling);
            progressDiv.style.display = 'block';

            // Add progress items
            const progressItems = document.getElementById('progressItems');
            selectedFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'progress-item';
                item.id = `progress-${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
                item.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock me-2"></i>
                        <span class="file-name">${file.name}</span>
                    </div>
                    <span class="status">Waiting...</span>
                `;
                progressItems.appendChild(item);
            });
        }

        function updateProgressItem(filename, status, message) {
            const safeId = `progress-${filename.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const item = document.getElementById(safeId);
            if (item) {
                item.className = `progress-item ${status}`;
                const icon = status === 'processing' ? 'fa-spinner fa-spin' : 
                           status === 'completed' ? 'fa-check' : 'fa-times';
                item.querySelector('i').className = `fas ${icon} me-2`;
                item.querySelector('.status').textContent = message;
            }
        }

        function showBatchResults() {
            const resultsDiv = document.createElement('div');
            resultsDiv.id = 'batchResults';
            resultsDiv.className = 'batch-results';
            
            const successCount = batchResults.filter(r => r.success).length;
            const totalIssues = batchResults.reduce((sum, r) => 
                r.success ? sum + (r.summary?.totalIssues || 0) : sum, 0);
            const avgQuality = batchResults.filter(r => r.success).reduce((sum, r) => 
                sum + (r.summary?.qualityScore || 0), 0) / successCount;

            resultsDiv.innerHTML = `
                <div class="result-summary">
                    <h6><i class="fas fa-chart-bar"></i> Batch Analysis Summary</h6>
                    <div class="row">
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-success">${successCount}</div>
                                <small>Files Processed</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-warning">${totalIssues}</div>
                                <small>Total Issues</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-info">${Math.round(avgQuality || 0)}%</div>
                                <small>Avg Quality</small>
                            </div>
                        </div>
                    </div>
                </div>
                <h6>Individual Results</h6>
                <div id="batchResultItems"></div>
            `;

            const progressDiv = document.getElementById('batchProgress');
            progressDiv.parentNode.insertBefore(resultsDiv, progressDiv.nextSibling);
            resultsDiv.style.display = 'block';

            // Add individual result items
            const resultItems = document.getElementById('batchResultItems');
            batchResults.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.addEventListener('click', () => showBatchResult(index));
                
                if (result.success) {
                    const issues = result.summary?.totalIssues || 0;
                    const quality = result.summary?.qualityScore || 0;
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-alt text-success me-2"></i>
                                <div>
                                    <div class="fw-bold">${result.filename}</div>
                                    <small class="text-muted">${result.summary?.totalSentences || 0} sentences, ${issues} issues</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="badge bg-${quality >= 80 ? 'success' : quality >= 60 ? 'warning' : 'danger'}">${quality}%</div>
                            </div>
                        </div>
                    `;
                } else {
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                <div>
                                    <div class="fw-bold">${result.filename}</div>
                                    <small class="text-muted text-danger">${result.error}</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                resultItems.appendChild(item);
            });
        }

        function showBatchResult(index) {
            const result = batchResults[index];
            if (!result.success) {
                alert(`Error processing ${result.filename}: ${result.error}`);
                return;
            }

            // Highlight selected result
            document.querySelectorAll('.result-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.result-item')[index].classList.add('active');

            // Render the selected file's content
            renderChart(result.report || {}, result.sentences || []);
            renderContent(result.content || '', result.sentences || []);

            // Update dashboard to show current file info
            const fileInfo = document.createElement('div');
            fileInfo.className = 'alert alert-info';
            fileInfo.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                Currently viewing: <strong>${result.filename}</strong>
            `;
            
            const documentContent = document.getElementById('documentContent');
            const existingInfo = documentContent.querySelector('.alert.alert-info');
            if (existingInfo) existingInfo.remove();
            documentContent.insertBefore(fileInfo, documentContent.firstChild.nextSibling);
        }

        // Chart rendering
        function renderChart(report, sentences) {
    const ctx = document.getElementById('analysisChart').getContext('2d');

    if (analysisChart) {
        analysisChart.destroy();
    }

    let totalErrors = sentences.reduce((count, sentence) => count + (sentence.feedback ? sentence.feedback.length : 0), 0);
    let totalSentences = sentences.length;
    // Calculate quality index if not provided by backend
    let qualityIndex = report.avgQualityScore !== undefined
        ? report.avgQualityScore
        : (totalSentences === 0 ? 0 : Math.max(0, Math.round(100 * (1 - (totalErrors / totalSentences)))));

    analysisChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Errors', 'Quality Index', 'Total Sentences'],
            datasets: [{
                data: [totalErrors, qualityIndex, totalSentences],
                backgroundColor: ['#ff4d4d', '#007bff', '#17a2b8']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'bottom' }
            }
        }
    });
}

        // Enhanced AI functionality
        let currentSuggestionId = null;
        let selectedWritingGoals = ['clarity', 'conciseness']; // Default goals (UI removed but backend may still use)
        let aiFeedbackData = {}; // Store AI feedback data by sentence index and feedback type
        
        // Add event delegation for AI feedback icons
        document.addEventListener('click', function(e) {
            if (e.target.closest('.ai-feedback-icon')) {
                const button = e.target.closest('.ai-feedback-icon');
                const sentenceIndex = parseInt(button.getAttribute('data-sentence-index'));
                const feedback = button.getAttribute('data-feedback');
                const sentence = button.getAttribute('data-sentence');
                const fullSuggestion = button.getAttribute('data-full-suggestion');
                
                console.log('=== AI ICON CLICKED ===');
                console.log('Button element:', button);
                console.log('Raw attributes:', {
                    sentenceIndex: sentenceIndex,
                    feedback: feedback,
                    sentence: sentence,
                    fullSuggestion: fullSuggestion
                });
                console.log('Data attributes from DOM:', {
                    'data-sentence-index': button.getAttribute('data-sentence-index'),
                    'data-feedback': button.getAttribute('data-feedback'),
                    'data-sentence': button.getAttribute('data-sentence'),
                    'data-full-suggestion': button.getAttribute('data-full-suggestion')
                });
                
                showAIFeedback(sentenceIndex, feedback, sentence, fullSuggestion);
            }
        });
        
        // Tab switching functionality
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'feedback') {
                document.getElementById('feedbackContent').classList.add('active');
            } else if (tabName === 'ai-feedback') {
                document.getElementById('aiFeedbackContent').classList.add('active');
            }
        }
        
        // Function to add AI feedback to the AI tab
        function addToAITab(sentenceIndex, feedback, sentence, aiSuggestion, feedbackKey) {
            const aiFeedbackContainer = document.getElementById('aiFeedbackContent');
            
            // Remove the placeholder if it exists
            const placeholder = aiFeedbackContainer.querySelector('.text-muted.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Create AI feedback item with unique identifier
            const aiDiv = document.createElement('div');
            aiDiv.className = 'ai-feedback-content';
            aiDiv.setAttribute('data-sentence-index', sentenceIndex);
            aiDiv.setAttribute('data-feedback-key', feedbackKey);
            aiDiv.setAttribute('data-feedback-type', feedback);
            
            aiDiv.innerHTML = `
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-robot me-2"></i>
                    <strong>Sentence ${sentenceIndex + 1} Analysis</strong>
                    <span class="confidence-indicator confidence-${aiSuggestion.confidence} ms-2"></span>
                    <span class="ai-enhancement-badge ms-2">${aiSuggestion.method}</span>
                </div>
                
                <div class="mb-3">
                    <div class="text-light mb-2"><strong>Writing Problem:</strong></div>
                    <div class="bg-dark bg-opacity-25 p-2 rounded">${feedback}</div>
                </div>
                
                <div class="mb-3">
                    <div class="text-light mb-2"><strong>Original sentence:</strong></div>
                    <div class="bg-dark bg-opacity-25 p-2 rounded font-italic">"${sentence}"</div>
                </div>
                
                <div class="mb-3">
                    <div class="text-light mb-2"><strong>AI Suggestion:</strong></div>
                    <div class="suggestion-text bg-light text-dark p-3 rounded">
                        ${formatAISuggestion(aiSuggestion.suggestion)}
                    </div>
                </div>
                
                <div class="feedback-buttons">
                    <button class="feedback-btn" onclick="rateSuggestion('${aiSuggestion.suggestion_id}', 'helpful')">
                        <i class="fas fa-thumbs-up"></i> Helpful
                    </button>
                    <button class="feedback-btn" onclick="rateSuggestion('${aiSuggestion.suggestion_id}', 'not-helpful')">
                        <i class="fas fa-thumbs-down"></i> Not Helpful
                    </button>
                    <button class="feedback-btn" onclick="implementSuggestion('${aiSuggestion.suggestion_id}')">
                        <i class="fas fa-check"></i> Implemented
                    </button>
                    <button class="feedback-btn" onclick="scrollToSentence(${sentenceIndex})">
                        <i class="fas fa-search"></i> View Text
                    </button>
                </div>
            `;
            
            // Insert in order by sentence index, then by feedback type
            const existingItems = Array.from(aiFeedbackContainer.querySelectorAll('.ai-feedback-content[data-sentence-index]'));
            let inserted = false;
            
            for (let existingItem of existingItems) {
                const existingIndex = parseInt(existingItem.getAttribute('data-sentence-index'));
                
                if (sentenceIndex < existingIndex) {
                    aiFeedbackContainer.insertBefore(aiDiv, existingItem);
                    inserted = true;
                    break;
                } else if (sentenceIndex === existingIndex) {
                    // Same sentence - insert after existing items for the same sentence
                    let nextItem = existingItem.nextElementSibling;
                    while (nextItem && nextItem.classList.contains('ai-feedback-content')) {
                        const nextIndex = parseInt(nextItem.getAttribute('data-sentence-index'));
                        if (nextIndex !== sentenceIndex) {
                            break;
                        }
                        nextItem = nextItem.nextElementSibling;
                    }
                    if (nextItem) {
                        aiFeedbackContainer.insertBefore(aiDiv, nextItem);
                    } else {
                        aiFeedbackContainer.appendChild(aiDiv);
                    }
                    inserted = true;
                    break;
                }
            }
            
            if (!inserted) {
                aiFeedbackContainer.appendChild(aiDiv);
            }
            
            // Store the AI feedback data with unique key
            aiFeedbackData[feedbackKey] = {
                feedback: feedback,
                sentence: sentence,
                aiSuggestion: aiSuggestion,
                sentenceIndex: sentenceIndex
            };
        }
        
        // Function to handle AI feedback icon click
        async function showAIFeedback(sentenceIndex, feedback, sentence, fullSuggestion = '') {
            try {
                console.log('=== SHOW AI FEEDBACK DEBUG ===');
                console.log('Raw parameters:', {
                    sentenceIndex: sentenceIndex,
                    feedback: feedback,
                    sentence: sentence,
                    fullSuggestion: fullSuggestion,
                    feedbackType: typeof feedback,
                    sentenceType: typeof sentence
                });
                
                // Decode the parameters since they were encoded in the HTML
                const decodedFeedback = decodeURIComponent(feedback);
                const decodedSentence = decodeURIComponent(sentence);
                const decodedFullSuggestion = decodeURIComponent(fullSuggestion);
                
                console.log('Decoded parameters:', {
                    decodedFeedback: decodedFeedback,
                    decodedSentence: decodedSentence,
                    decodedFullSuggestion: decodedFullSuggestion
                });
                
                // Create a unique key for this specific feedback type and sentence combination
                const feedbackKey = `${sentenceIndex}_${btoa(decodedFeedback).replace(/[^a-zA-Z0-9]/g, '')}`;
                console.log('Generated feedback key:', feedbackKey);
                
                // Check if we already have AI feedback for this specific sentence and feedback type
                if (aiFeedbackData[feedbackKey]) {
                    console.log('Found existing AI feedback, switching to tab');
                    // Switch to AI tab and highlight the existing feedback
                    switchTabProgrammatically('ai-feedback');
                    highlightAIFeedback(sentenceIndex, decodedFeedback);
                    return;
                }
                
                // Always get a fresh AI suggestion when the AI icon is clicked
                // Show loading state
                console.log('Getting fresh AI suggestion...');
                const loadingToast = showLoadingToast('Getting AI suggestions...');
                
                // Get AI suggestion
                console.log('About to call getAISuggestion with:', {
                    feedback: decodedFeedback,
                    sentence: decodedSentence
                });
                
                const aiSuggestion = await getAISuggestion(decodedFeedback, decodedSentence);
                console.log('getAISuggestion returned:', aiSuggestion);
                
                // Hide loading
                hideLoadingToast(loadingToast);
                
                if (aiSuggestion && typeof aiSuggestion === 'object' && aiSuggestion.suggestion) {
                    console.log('✅ AI suggestion success, adding to tab');
                    console.log('AI suggestion object:', aiSuggestion);
                    // Add to AI tab
                    addToAITab(sentenceIndex, decodedFeedback, decodedSentence, aiSuggestion, feedbackKey);
                    
                    // Switch to AI tab
                    switchTabProgrammatically('ai-feedback');
                    
                    // Highlight the new feedback
                    highlightAIFeedback(sentenceIndex, decodedFeedback);
                } else {
                    console.error('❌ AI suggestion failed - invalid response:', {
                        aiSuggestion: aiSuggestion,
                        type: typeof aiSuggestion,
                        hasProperty: aiSuggestion && aiSuggestion.hasOwnProperty('suggestion'),
                        suggestionValue: aiSuggestion ? aiSuggestion.suggestion : 'N/A',
                        feedback: decodedFeedback,
                        sentence: decodedSentence,
                        feedbackKey: feedbackKey
                    });
                    showErrorToast('AI suggestion not available. Check console for details - invalid response structure.');
                }
                
            } catch (error) {
                console.error('❌ Error in showAIFeedback:', error);
                console.error('Error stack:', error.stack);
                showErrorToast('Error getting AI suggestion: ' + error.message);
            }
        }
        
        // Function to switch tab programmatically
        function switchTabProgrammatically(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'feedback') {
                document.querySelector('.tab-button:first-child').classList.add('active');
                document.getElementById('feedbackContent').classList.add('active');
            } else if (tabName === 'ai-feedback') {
                document.querySelector('.tab-button:last-child').classList.add('active');
                document.getElementById('aiFeedbackContent').classList.add('active');
            }
        }
        
        // Function to highlight AI feedback item
        function highlightAIFeedback(sentenceIndex, feedbackType = null) {
            // Remove existing highlights
            document.querySelectorAll('.ai-feedback-content').forEach(item => {
                item.style.transform = '';
                item.style.boxShadow = '';
            });
            
            // Find the target item - if feedbackType is provided, find the specific feedback
            let targetItem;
            if (feedbackType) {
                const items = document.querySelectorAll(`#aiFeedbackContent [data-sentence-index="${sentenceIndex}"]`);
                for (let item of items) {
                    if (item.getAttribute('data-feedback-type') === feedbackType) {
                        targetItem = item;
                        break;
                    }
                }
            } else {
                // If no specific feedback type, just get the first item for this sentence
                targetItem = document.querySelector(`#aiFeedbackContent [data-sentence-index="${sentenceIndex}"]`);
            }
            
            if (targetItem) {
                targetItem.style.transform = 'scale(1.02)';
                targetItem.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.4)';
                targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Remove highlight after a few seconds
                setTimeout(() => {
                    targetItem.style.transform = '';
                    targetItem.style.boxShadow = '';
                }, 3000);
            }
        }
        
        // Toast notification functions
        function showLoadingToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification loading';
            toast.innerHTML = `
                <i class="fas fa-spinner fa-spin me-2"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            
            // Add styles if not already present
            if (!document.querySelector('#toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    .toast-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        z-index: 10000;
                        animation: slideIn 0.3s ease;
                    }
                    .toast-notification.loading {
                        background: linear-gradient(45deg, #6c5ce7, #a29bfe);
                    }
                    .toast-notification.error {
                        background: #e74c3c;
                    }
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            return toast;
        }
        
        function hideLoadingToast(toast) {
            if (toast && toast.parentNode) {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        }
        
        function showErrorToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification error';
            toast.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                hideLoadingToast(toast);
            }, 3000);
        }
        
        // Writing Goals Analytics (simplified - goals now hardcoded)
        function updateWritingGoalsAnalytics() {
            console.log('Selected writing goals:', selectedWritingGoals);
            
            // Update dashboard insights based on selected goals
            updateSmartInsights();
        }

        function updateDocumentMetrics(content, sentences) {
            // Update word and sentence counts
            const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;
            const sentenceCount = sentences.length;
            
            document.getElementById('wordCount').textContent = wordCount;
            document.getElementById('sentenceCount').textContent = sentenceCount;
            
            // Calculate and update quality score
            const issues = sentences.reduce((count, s) => count + (s.feedback ? s.feedback.length : 0), 0);
            const qualityScore = sentenceCount > 0 ? Math.max(0, Math.round((1 - issues / sentenceCount) * 100)) : 0;
            
            document.getElementById('qualityScore').textContent = `${qualityScore}%`;
            document.getElementById('qualityProgressBar').style.width = `${qualityScore}%`;
            
            // Update quality description
            let description = '';
            if (qualityScore >= 90) description = 'Excellent writing quality';
            else if (qualityScore >= 75) description = 'Good writing quality';
            else if (qualityScore >= 60) description = 'Fair writing quality - room for improvement';
            else description = 'Needs improvement';
            
            document.getElementById('qualityDescription').textContent = description;
            
            // Update issues progress
            document.getElementById('issuesStats').textContent = issues;
            document.getElementById('issuesProgressBar').style.width = issues === 0 ? '100%' : `${Math.max(10, 100 - (issues * 10))}%`;
            document.getElementById('issuesDescription').textContent = 
                issues === 0 ? 'No issues detected' : `${issues} issue${issues > 1 ? 's' : ''} found`;
            
            // Enable quick action buttons
            if (issues > 0) {
                document.getElementById('fixAllBtn').disabled = false;
                document.getElementById('readabilityBtn').disabled = false;
            }
            if (wordCount > 50) {
                document.getElementById('summaryBtn').disabled = false;
            }
        }

        function updateSmartInsights() {
            const insights = [];
            const container = document.getElementById('smartInsightsList');
            
            // Generate insights based on selected goals and document state
            if (selectedWritingGoals.includes('clarity')) {
                insights.push({
                    icon: 'fas fa-eye',
                    text: 'Focus on clear, simple language',
                    priority: 'high'
                });
            }
            
            if (selectedWritingGoals.includes('conciseness')) {
                insights.push({
                    icon: 'fas fa-compress-alt',
                    text: 'Look for opportunities to reduce word count',
                    priority: 'medium'
                });
            }
            
            if (selectedWritingGoals.includes('engagement')) {
                insights.push({
                    icon: 'fas fa-heart',
                    text: 'Consider adding more engaging examples',
                    priority: 'medium'
                });
            }
            
            // Clear and populate insights
            container.innerHTML = '';
            insights.forEach(insight => {
                const div = document.createElement('div');
                div.className = `insight-item ${insight.priority === 'high' ? 'active' : ''}`;
                div.innerHTML = `<i class="${insight.icon}"></i> ${insight.text}`;
                container.appendChild(div);
            });
            
            if (insights.length === 0) {
                container.innerHTML = '<div class="insight-item text-muted"><i class="fas fa-info-circle"></i> Select writing goals to see personalized insights</div>';
            }
        }

        // Function to update smart insights based on document analysis
        function updateSmartInsightsFromDocument(sentences) {
            const insights = [];
            const container = document.getElementById('smartInsightsList');
            
            // Analyze document patterns
            const totalIssues = sentences.reduce((count, s) => count + (s.feedback ? s.feedback.length : 0), 0);
            const longSentences = sentences.filter(s => s.feedback && s.feedback.some(f => f.message && typeof f.message === 'string' && f.message.includes('Long sentence'))).length;
            const grammarIssues = sentences.filter(s => s.feedback && s.feedback.some(f => f.message && typeof f.message === 'string' && (f.message.includes('grammar') || f.message.includes('verb')))).length;
            const repeatedWords = sentences.filter(s => s.feedback && s.feedback.some(f => f.message && typeof f.message === 'string' && f.message.includes('repeated'))).length;
            
            // Generate targeted insights
            if (longSentences > 0 && selectedWritingGoals.includes('conciseness')) {
                insights.push({
                    icon: 'fas fa-scissors',
                    text: `Break down ${longSentences} long sentence${longSentences > 1 ? 's' : ''} for better readability`,
                    priority: 'high'
                });
            }
            
            if (grammarIssues > 0 && selectedWritingGoals.includes('professionalism')) {
                insights.push({
                    icon: 'fas fa-check-circle',
                    text: `Fix ${grammarIssues} grammar issue${grammarIssues > 1 ? 's' : ''} to improve professionalism`,
                    priority: 'high'
                });
            }
            
            if (repeatedWords > 0 && selectedWritingGoals.includes('clarity')) {
                insights.push({
                    icon: 'fas fa-sync-alt',
                    text: `Reduce word repetition in ${repeatedWords} sentence${repeatedWords > 1 ? 's' : ''}`,
                    priority: 'medium'
                });
            }
            
            if (selectedWritingGoals.includes('engagement') && totalIssues < 3) {
                insights.push({
                    icon: 'fas fa-heart',
                    text: 'Consider adding more vivid examples or storytelling elements',
                    priority: 'low'
                });
            }
            
            if (selectedWritingGoals.includes('accessibility') && longSentences > 2) {
                insights.push({
                    icon: 'fas fa-universal-access',
                    text: 'Simplify complex sentences for better accessibility',
                    priority: 'medium'
                });
            }
            
            // Clear and populate insights
            container.innerHTML = '';
            insights.sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            });
            
            insights.forEach(insight => {
                const div = document.createElement('div');
                div.className = `insight-item ${insight.priority === 'high' ? 'active' : ''}`;
                div.innerHTML = `<i class="${insight.icon}"></i> ${insight.text}`;
                container.appendChild(div);
            });
            
            if (insights.length === 0) {
                container.innerHTML = '<div class="insight-item text-muted"><i class="fas fa-star"></i> Excellent! Your document aligns well with your writing goals</div>';
            }
        }

        // Quick Actions Implementation
        document.getElementById('fixAllBtn').addEventListener('click', function() {
            if (confirm('Apply all AI suggestions to improve your document?')) {
                // Implement bulk fix functionality
                console.log('Applying all suggestions...');
                showSuccessToast('All suggestions applied successfully!');
            }
        });

        document.getElementById('readabilityBtn').addEventListener('click', function() {
            // Implement readability improvement
            console.log('Improving readability...');
            showSuccessToast('Readability analysis complete!');
        });

        document.getElementById('summaryBtn').addEventListener('click', function() {
            // Implement summary generation
            console.log('Generating summary...');
            showSuccessToast('Document summary generated!');
        });

        function showSuccessToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification success';
            toast.innerHTML = `<i class="fas fa-check me-2"></i>${message}`;
            document.body.appendChild(toast);
            
            // Add success style if not present
            if (!document.querySelector('#success-toast-style')) {
                const style = document.createElement('style');
                style.id = 'success-toast-style';
                style.textContent = `.toast-notification.success { background: #27ae60; }`;
                document.head.appendChild(style);
            }
            
            setTimeout(() => hideLoadingToast(toast), 3000);
        }

        // Sentence highlighting and navigation functions
        function highlightSentence(sentenceIndex) {
            // Remove any existing highlights
            unhighlightAllSentences();
            
            // Highlight the target sentence in the content
            const contentSentence = document.getElementById(`content-sentence-${sentenceIndex}`);
            if (contentSentence) {
                contentSentence.classList.add('highlight');
                
                // Auto-scroll to center the sentence in the Document Content section
                const documentSection = document.querySelector('.document-section');
                if (documentSection) {
                    const sentenceRect = contentSentence.getBoundingClientRect();
                    const sectionRect = documentSection.getBoundingClientRect();
                    
                    // Calculate the scroll position to center the sentence
                    const sectionCenter = sectionRect.height / 2;
                    const sentenceRelativeTop = sentenceRect.top - sectionRect.top;
                    const scrollTarget = documentSection.scrollTop + sentenceRelativeTop - sectionCenter;
                    
                    // Smooth scroll to the target position
                    documentSection.scrollTo({
                        top: scrollTarget,
                        behavior: 'smooth'
                    });
                }
            }
            
            // Also highlight in interactive section if it exists
            const interactiveSentence = document.getElementById(`sentence-${sentenceIndex}`);
            if (interactiveSentence) {
                interactiveSentence.classList.add('highlight');
            }
        }
        
        function unhighlightAllSentences() {
            // Remove highlights from content sentences
            document.querySelectorAll('.sentence-highlight.highlight').forEach(sentence => {
                sentence.classList.remove('highlight');
            });
            
            // Remove highlights from interactive sentences
            document.querySelectorAll('.sentence.highlight').forEach(sentence => {
                sentence.classList.remove('highlight');
            });
        }
        
        function highlightFeedbackForSentence(sentenceIndex) {
            // Remove any existing feedback highlights
            document.querySelectorAll('.feedback-item.highlighted').forEach(item => {
                item.classList.remove('highlighted');
            });
            
            // Highlight corresponding feedback items
            document.querySelectorAll(`.feedback-item[data-sentence-index="${sentenceIndex}"]`).forEach(item => {
                item.classList.add('highlighted');
            });
        }
        
        function scrollToSentence(sentenceIndex) {
            // Try content sentence first, then interactive sentence
            let sentenceElement = document.getElementById(`content-sentence-${sentenceIndex}`);
            if (!sentenceElement) {
                sentenceElement = document.getElementById(`sentence-${sentenceIndex}`);
            }
            
            if (sentenceElement) {
                sentenceElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Temporarily highlight the sentence
                highlightSentence(sentenceIndex);
                setTimeout(() => {
                    unhighlightAllSentences();
                }, 2000);
            }
        }

        // Add click handlers to content sentences after they're created
        function addContentSentenceHandlers() {
            document.querySelectorAll('.sentence-highlight').forEach((sentence, index) => {
                sentence.addEventListener('click', () => {
                    const sentenceIndex = parseInt(sentence.getAttribute('data-sentence-index'));
                    highlightFeedbackForSentence(sentenceIndex);
                });
            });
        }

        // Function to add sentence highlighting to HTML content
        function addSentenceHighlighting(htmlContent, sentences) {
            let processedContent = htmlContent;
            
            console.log('Processing sentences for highlighting:', sentences.length);
            console.log('Original HTML content:', htmlContent);
            
            // First, try to get plain text equivalent of HTML for better matching
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const plainTextContent = tempDiv.textContent || tempDiv.innerText || '';
            console.log('Plain text content:', plainTextContent);
            
            sentences.forEach((sentenceData, index) => {
                const sentence = sentenceData.sentence.trim();
                if (sentence) {
                    console.log(`Processing sentence ${index}:`, sentence);
                    
                    let found = false;
                    const hasFeedback = sentenceData.feedback && sentenceData.feedback.length > 0;
                    const feedbackClass = hasFeedback ? ' has-feedback' : '';
                    
                    // Approach 1: Direct HTML match (works for simple cases)
                    if (processedContent.includes(sentence)) {
                        const replacement = `<span class="sentence-highlight${feedbackClass}" id="content-sentence-${index}" data-sentence-index="${index}">${sentence}</span>`;
                        processedContent = processedContent.replace(sentence, replacement);
                        found = true;
                        console.log(`✓ Direct HTML match for sentence ${index}`);
                    }
                    
                    // Approach 2: Try to find sentence in plain text and map back to HTML
                    if (!found && plainTextContent.includes(sentence)) {
                        // Find all words in the sentence
                        const words = sentence.split(/\s+/).filter(word => word.length > 2);
                        
                        if (words.length > 0) {
                            // Create a regex that finds the sentence allowing for HTML tags between words
                            const wordPattern = words.map(word => 
                                word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
                            ).join('(?:[^>]*>.*?<[^>]*)*\\s*');
                            
                            const regex = new RegExp(`(${wordPattern})`, 'gi');
                            
                            const match = processedContent.match(regex);
                            if (match) {
                                const matchedText = match[0];
                                const replacement = `<span class="sentence-highlight${feedbackClass}" id="content-sentence-${index}" data-sentence-index="${index}">${matchedText}</span>`;
                                processedContent = processedContent.replace(matchedText, replacement);
                                found = true;
                                console.log(`✓ Word-based match for sentence ${index}`);
                            }
                        }
                    }
                    
                    // Approach 3: Fuzzy text-only match (last resort)
                    if (!found) {
                        // Try to find just the key parts of the sentence
                        const significantWords = sentence.split(/\s+/).filter(word => 
                            word.length > 3 && !['the', 'and', 'for', 'are', 'but', 'not', 'you', 'all', 'can', 'had', 'was', 'one', 'our', 'out', 'day', 'get', 'use', 'man', 'new', 'now', 'old', 'see', 'him', 'two', 'how', 'its', 'who', 'oil', 'sit', 'set'].includes(word.toLowerCase())
                        );
                        
                        if (significantWords.length >= 2) {
                            let bestMatch = null;
                            let bestMatchLength = 0;
                            
                            // Look for the longest substring that contains significant words
                            const tempDiv2 = document.createElement('div');
                            tempDiv2.innerHTML = processedContent;
                            const textContent = tempDiv2.textContent;
                            
                            significantWords.forEach(word => {
                                const wordRegex = new RegExp(`[^.!?]*${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}[^.!?]*[.!?]`, 'gi');
                                const matches = textContent.match(wordRegex);
                                if (matches) {
                                    matches.forEach(match => {
                                        if (match.length > bestMatchLength) {
                                            bestMatch = match.trim();
                                            bestMatchLength = match.length;
                                        }
                                    });
                                }
                            });
                            
                            if (bestMatch && processedContent.includes(bestMatch)) {
                                const replacement = `<span class="sentence-highlight${feedbackClass}" id="content-sentence-${index}" data-sentence-index="${index}">${bestMatch}</span>`;
                                processedContent = processedContent.replace(bestMatch, replacement);
                                found = true;
                                console.log(`✓ Fuzzy match for sentence ${index}: "${bestMatch}"`);
                            }
                        }
                    }
                    
                    if (!found) {
                        console.warn(`✗ Could not find sentence ${index} in content:`, sentence);
                        
                        // As absolute last resort, just add a marker
                        const marker = `<span class="sentence-highlight${feedbackClass} sentence-not-found" id="content-sentence-${index}" data-sentence-index="${index}" title="Sentence: ${sentence.replace(/"/g, '&quot;')}">[Sentence ${index + 1}]</span>`;
                        
                        // Try to insert the marker near related content
                        const firstWords = sentence.split(' ').slice(0, 3).join(' ');
                        if (processedContent.includes(firstWords)) {
                            processedContent = processedContent.replace(firstWords, marker + ' ' + firstWords);
                            console.log(`Added fallback marker for sentence ${index}`);
                        }
                    }
                }
            });
            
            console.log('Final processed content length:', processedContent.length);
            return processedContent;
        }

        // Format AI suggestion (structured output)
        function formatAISuggestion(suggestionText) {
            // Try to parse and format structured AI output
            if (!suggestionText) return '';
            // Split by newlines and look for KEY: value pairs
            const lines = suggestionText.split(/\n|<br\s*\/?>(?=\w+:)/g);
            let html = '';
            lines.forEach(line => {
                const match = line.match(/^([A-Z][A-Z_ \-]+):\s*(.*)$/i);
                if (match) {
                    const key = match[1].replace(/_/g, ' ').replace(/\b([a-z])/g, c => c.toUpperCase());
                    const value = match[2];
                    html += `<div style="margin-bottom:4px;"><strong>${key}:</strong> <span style="color:#333;background:rgba(255,255,255,0.7);padding:2px 4px;border-radius:3px;">${value}</span></div>`;
                } else if (line.trim()) {
                    html += `<div style="margin-bottom:4px;">${line}</div>`;
                }
            });
            return html || suggestionText;
        }

        // Enhanced feedback rendering with AI suggestions and hover highlighting
        async function renderFeedbackWithAI(feedback, sentence, sentenceIndex) {
            const feedbackContainer = document.getElementById('feedbackContent');
            
            console.log('renderFeedbackWithAI called with:', feedback, sentence, sentenceIndex);
            
            for (const item of feedback) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback-item p-3 mb-2 border-start';
                feedbackDiv.setAttribute('data-sentence-index', sentenceIndex);
                feedbackDiv.setAttribute('data-order', sentenceIndex); // For sorting
                
                // Add hover functionality to highlight corresponding sentence
                feedbackDiv.addEventListener('mouseenter', () => {
                    highlightSentence(sentenceIndex);
                });
                
                feedbackDiv.addEventListener('mouseleave', () => {
                    unhighlightAllSentences();
                });
                
                // Add click functionality to scroll to sentence
                feedbackDiv.addEventListener('click', (e) => {
                    // Don't trigger if clicking on AI icon
                    if (!e.target.closest('.ai-feedback-icon')) {
                        scrollToSentence(sentenceIndex);
                    }
                });
                
                console.log('Processing feedback item:', item);
                
                feedbackDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="mb-2">
                                <small class="text-muted">Sentence ${sentenceIndex + 1}</small>
                                <i class="fas fa-link ms-2" style="cursor: pointer;" title="Click to view sentence"></i>
                            </div>
                            <strong>Issue:</strong> ${item.message}
                        </div>
                        <button class="ai-feedback-icon" 
                                data-sentence-index="${sentenceIndex}" 
                                data-feedback="${encodeURIComponent(item.message)}" 
                                data-sentence="${encodeURIComponent(sentence)}"
                                data-full-suggestion="${encodeURIComponent(item.full_suggestion || '')}" 
                                title="Get AI suggestions">
                            <i class="fas fa-robot"></i>
                        </button>
                    </div>
                `;
                
                // Insert in the correct order
                const existingItems = Array.from(feedbackContainer.querySelectorAll('.feedback-item[data-order]'));
                let inserted = false;
                
                for (let existingItem of existingItems) {
                    const existingOrder = parseInt(existingItem.getAttribute('data-order'));
                    if (sentenceIndex < existingOrder) {
                        feedbackContainer.insertBefore(feedbackDiv, existingItem);
                        inserted = true;
                        break;
                    }
                }
                
                if (!inserted) {
                    feedbackContainer.appendChild(feedbackDiv);
                }
            }
        }

        async function getAISuggestion(feedback, sentence) {
            try {
                // Safe document type retrieval - fallback to 'technical' if element doesn't exist
                let documentType = 'technical';
                const documentTypeElement = document.getElementById('documentType');
                if (documentTypeElement && documentTypeElement.value) {
                    documentType = documentTypeElement.value;
                }
                
                console.log('=== AI SUGGESTION DEBUG ===');
                console.log('Document type used:', documentType);
                console.log('Raw inputs:', {
                    feedback: feedback,
                    sentence: sentence,
                    feedbackType: typeof feedback,
                    sentenceType: typeof sentence,
                    feedbackLength: feedback?.length,
                    sentenceLength: sentence?.length
                });
                
                // Clean and validate required parameters
                const cleanFeedback = feedback ? feedback.trim() : '';
                const cleanSentence = sentence ? sentence.trim() : '';
                
                console.log('Cleaned inputs:', {
                    cleanFeedback: cleanFeedback,
                    cleanSentence: cleanSentence,
                    cleanFeedbackLength: cleanFeedback.length,
                    cleanSentenceLength: cleanSentence.length
                });
                
                if (!cleanFeedback || !cleanSentence) {
                    console.error('❌ VALIDATION FAILED - Missing required parameters:', { 
                        feedback: cleanFeedback, 
                        sentence: cleanSentence,
                        feedbackEmpty: !cleanFeedback,
                        sentenceEmpty: !cleanSentence
                    });
                    return null;
                }
                
                // Extract just the core issue description from feedback if it contains structured data
                let coreIssue = cleanFeedback;
                if (cleanFeedback.includes('Issue:')) {
                    const issueMatch = cleanFeedback.match(/Issue:\s*([^\n]+)/);
                    if (issueMatch) {
                        coreIssue = issueMatch[1].trim();
                        console.log('Extracted core issue:', coreIssue);
                    }
                }
                
                const requestData = {
                    feedback: coreIssue,
                    sentence: cleanSentence,
                    document_type: documentType,
                    writing_goals: selectedWritingGoals || ['clarity', 'conciseness']
                };
                
                console.log('Request payload:', requestData);
                
                const response = await fetch('/ai_suggestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ AI suggestion HTTP success - analyzing response...');
                    console.log('Response type:', typeof result);
                    console.log('Response keys:', Object.keys(result || {}));
                    console.log('Full response object:', result);
                    console.log('Suggestion property exists:', 'suggestion' in result);
                    console.log('Suggestion property value:', result.suggestion);
                    console.log('Suggestion property type:', typeof result.suggestion);
                    console.log('Suggestion property length:', result.suggestion?.length);
                    console.log('Suggestion is truthy:', !!result.suggestion);
                    
                    // Extra validation to ensure we have a valid result
                    if (result && typeof result === 'object' && result.suggestion) {
                        console.log('✅ Valid AI suggestion object confirmed - validation passed');
                        return result;
                    } else {
                        console.error('❌ Invalid AI suggestion response structure - validation failed:');
                        console.error('  - result exists:', !!result);
                        console.error('  - result is object:', typeof result === 'object');
                        console.error('  - suggestion exists:', !!result.suggestion);
                        console.error('  - suggestion value:', result.suggestion);
                        return null;
                    }
                } else {
                    console.error('❌ AI suggestion HTTP error:', response.status);
                    const errorText = await response.text();
                    console.error('Error response body:', errorText);
                    return null;
                }
            } catch (error) {
                console.error('❌ AI suggestion exception:', error);
                console.error('Error stack:', error.stack);
                return null;
            }
        }

        function updateAIPerformance(suggestion) {
            const confidenceMap = {
                'high': '★★★',
                'medium': '★★☆',
                'low': '★☆☆'
            };
            
            document.getElementById('qualityScore').textContent = confidenceMap[suggestion.confidence] || '-';
            document.getElementById('aiMethod').textContent = suggestion.method || '-';
            
            // Show performance indicator
            const indicator = document.createElement('div');
            indicator.className = 'performance-indicator';
            indicator.textContent = `AI Response: ${suggestion.confidence} confidence`;
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.remove();
            }, 3000);
        }

        async function rateSuggestion(suggestionId, rating) {
            try {
                const response = await fetch('/suggestion_feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        suggestion_id: suggestionId,
                        was_helpful: rating === 'helpful'
                    })
                });

                if (response.ok) {
                    // Visual feedback
                    event.target.classList.add('active');
                    event.target.innerHTML = rating === 'helpful' ? 
                        '<i class="fas fa-check"></i> Thanks!' : 
                        '<i class="fas fa-check"></i> Noted';
                }
            } catch (error) {
                console.error('Feedback error:', error);
            }
        }

        async function implementSuggestion(suggestionId) {
            try {
                const response = await fetch('/suggestion_feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        suggestion_id: suggestionId,
                        was_implemented: true
                    })
                });

                if (response.ok) {
                    event.target.classList.add('active');
                    event.target.innerHTML = '<i class="fas fa-check"></i> Implemented';
                }
            } catch (error) {
                console.error('Implementation feedback error:', error);
            }
        }        // Enhanced content rendering with sentence highlighting
        function renderContent(content, sentences) {
            const documentContent = document.getElementById('documentContent');
            const feedbackContent = document.getElementById('feedbackContent');
            const aiFeedbackContent = document.getElementById('aiFeedbackContent');
            
            // Update dashboard metrics
            updateDocumentMetrics(content, sentences);
            
            // Clear previous content
            documentContent.innerHTML = '<h4>Document Content</h4>';
            feedbackContent.innerHTML = '<h5 class="mb-3">Document Issues</h5>';
            
            // Reset AI feedback tab
            aiFeedbackContent.innerHTML = `
                <h5 class="mb-3">AI-Powered Suggestions</h5>
                <div class="text-muted text-center py-4">
                    <i class="fas fa-robot fa-2x mb-2"></i>
                    <p>Click the AI icon next to any issue to get intelligent suggestions</p>
                </div>
            `;
            
            // Clear AI feedback data
            aiFeedbackData = {};
            
            console.log('Processing sentences:', sentences.length);
            console.log('Sentences data:', sentences);
            
            // Create enhanced HTML content with highlighted sentences
            const originalContentDiv = document.createElement('div');
            originalContentDiv.className = 'original-content mt-3';
            
            // Process the HTML content to add sentence highlighting
            const enhancedContent = addSentenceHighlighting(content, sentences);
            originalContentDiv.innerHTML = enhancedContent;
            
            // Store sentences for reference
            window.currentSentences = sentences;
            
            // Add the enhanced content to document
            documentContent.appendChild(originalContentDiv);
            
            // Add click handlers to the newly created sentence spans
            setTimeout(() => {
                addContentSentenceHandlers();
            }, 100);
            
            // Process sentences with AI enhancement - in document order
            let feedbackCount = 0;
            const feedbackPromises = [];
            
            // Collect all feedback rendering promises to maintain order
            sentences.forEach((sentenceData, index) => {
                console.log(`Sentence ${index}:`, sentenceData);
                if (sentenceData.feedback && sentenceData.feedback.length > 0) {
                    feedbackCount++;
                    console.log(`Rendering feedback for sentence ${index}:`, sentenceData.feedback);
                    // Store the promise with the index to maintain order
                    feedbackPromises.push({
                        index: index,
                        promise: renderFeedbackWithAI(sentenceData.feedback, sentenceData.sentence, index)
                    });
                }
            });
            
            // Wait for all feedback to be rendered in order
            if (feedbackPromises.length > 0) {
                // Process feedback in sequential order
                feedbackPromises.sort((a, b) => a.index - b.index);
                
                // Execute promises sequentially to maintain order
                feedbackPromises.reduce((prevPromise, current) => {
                    return prevPromise.then(() => current.promise);
                }, Promise.resolve());
            }
            
            // If no feedback found, show a message
            if (feedbackCount === 0) {
                const noIssuesDiv = document.createElement('div');
                noIssuesDiv.className = 'alert alert-success mt-3';
                noIssuesDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-2"></i>
                        <div>
                            <strong>Great work!</strong> No issues detected in your document.
                            <br><small>The AI analysis found your writing to be clear and well-structured.</small>
                        </div>
                    </div>
                `;
                feedbackContent.appendChild(noIssuesDiv);
                
                // Show document quality summary
                const qualitySummary = document.createElement('div');
                qualitySummary.className = 'card mt-3';
                qualitySummary.style.background = 'rgba(255, 255, 255, 0.1)';
                qualitySummary.innerHTML = `
                    <div class="card-header">
                        <h6><i class="fas fa-chart-line"></i> Document Quality Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <small>Total Sentences:</small>
                                <div class="h5">${sentences.length}</div>
                            </div>
                            <div class="col-6">
                                <small>Quality Score:</small>
                                <div class="h5">✅ Excellent</div>
                            </div>
                        </div>
                    </div>
                `;
                feedbackContent.appendChild(qualitySummary);
            }
            
            // Update smart insights based on document analysis
            updateSmartInsightsFromDocument(sentences);
        }
        // Clean feedback text
        function cleanFeedback(feedback) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = feedback;
            let cleanText = tempDiv.textContent || tempDiv.innerText || '';

           
            const fileExtensions = ['csv', 'pdf', 'docx', 'txt', 'md', 'adoc', 'png', 'jpg', 'jpeg', 'gif'];
            const regex = new RegExp(`[^.!?]*(?<!\\b(?:${fileExtensions.join('|')})\\b)[.!?]`, 'g');
            const match = cleanText.match(regex);
            if (match) {
                cleanText = match[0];
            }

            return cleanText;
        }

        // Dark mode toggle
        document.getElementById('darkModeToggle').addEventListener('change', (e) => {
            document.body.classList.toggle('dark-mode', e.target.checked);
        });

        // AI Suggestion Modal logic
        document.body.addEventListener('click', async function(e) {
            // Removed deprecated ai-suggest-btn handler - now using ai-feedback-icon
            if (e.target.id === 'closeSuggestionModal') {
                document.getElementById('suggestionModal').style.display = 'none';
            }
        });

        // Export functionality
        document.getElementById('exportBtn').addEventListener('click', () => {
    // Gather feedback data
    let csvContent = "Sentence,Feedback\n";
    document.querySelectorAll('.sentence').forEach((sentenceSpan) => {
        const idx = sentenceSpan.dataset.index;
        // Find all feedback for this sentence
        const feedbacks = [];
        document.querySelectorAll(`.feedback-item[data-index="${idx}"]`).forEach(fb => {
            feedbacks.push(fb.innerText.replace(/"/g, '""'));
        });
        if (feedbacks.length) {
            csvContent += `"${sentenceSpan.innerText.replace(/"/g, '""')}","${feedbacks.join('; ')}"\n`;
        }
    });

    // Download as CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'feedback_export.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

        // History functionality
        document.getElementById('historyBtn').addEventListener('click', () => {
            showHistoryModal();
        });

        // Settings functionality
        document.getElementById('settingsBtn').addEventListener('click', () => {
            showSettingsModal();
        });

        // Initialize modal event handlers when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeModalHandlers();
        });

        // If DOM is already loaded, initialize immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeModalHandlers);
        } else {
            initializeModalHandlers();
        }

        function initializeModalHandlers() {
            // Modal close handlers using event delegation
            document.addEventListener('click', function(e) {
                // Close history modal
                if (e.target.id === 'closeHistoryBottomBtn' || e.target.closest('#closeHistoryBottomBtn')) {
                    console.log('Closing history modal');
                    document.getElementById('historyModal').style.display = 'none';
                }
                
                // Close settings modal
                if (e.target.id === 'closeSettingsBottomBtn' || e.target.closest('#closeSettingsBottomBtn')) {
                    console.log('Closing settings modal');
                    document.getElementById('settingsModal').style.display = 'none';
                }
                
                // Close modals when clicking outside
                if (e.target.id === 'historyModal') {
                    document.getElementById('historyModal').style.display = 'none';
                }
                
                if (e.target.id === 'settingsModal') {
                    document.getElementById('settingsModal').style.display = 'none';
                }
                
                // Settings save handlers
                if (e.target.id === 'saveSettingsBtn' || e.target.closest('#saveSettingsBtn')) {
                    saveSettings();
                }
                
                if (e.target.id === 'resetSettingsBtn' || e.target.closest('#resetSettingsBtn')) {
                    resetSettings();
                }
            });
            
            // Also add ESC key support
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const historyModal = document.getElementById('historyModal');
                    const settingsModal = document.getElementById('settingsModal');
                    
                    if (historyModal && historyModal.style.display === 'flex') {
                        historyModal.style.display = 'none';
                    }
                    
                    if (settingsModal && settingsModal.style.display === 'flex') {
                        settingsModal.style.display = 'none';
                    }
                }
            });
        }

        // History Modal Functions
        function showHistoryModal() {
            const modal = document.getElementById('historyModal');
            const loading = document.getElementById('historyLoading');
            const content = document.getElementById('historyContent');
            
            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.innerHTML = '';
            
            // Fetch history data
            fetch('/performance_dashboard')
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    renderHistoryContent(data);
                })
                .catch(error => {
                    loading.style.display = 'none';
                    content.innerHTML = '<div style="color:#e74c3c; text-align:center; padding:2rem;"><i class="fas fa-exclamation-triangle"></i> Failed to load history data.</div>';
                    console.error('Error loading history:', error);
                });
        }

        function renderHistoryContent(data) {
            const content = document.getElementById('historyContent');
            
            if (!data || !data.recent_suggestions || data.recent_suggestions.length === 0) {
                content.innerHTML = `
                    <div style="text-align:center; padding:3rem; color:#666;">
                        <i class="fas fa-history" style="font-size:3rem; margin-bottom:1rem; opacity:0.3;"></i>
                        <h4>No History Yet</h4>
                        <p>Start analyzing documents to see your suggestion history here.</p>
                    </div>
                `;
                return;
            }

            // Overview stats
            const stats = data.overall_stats || {};
            let overviewHtml = `
                <div style="margin-bottom:2rem; padding:1rem; background:#f8f9fa; border-radius:8px;">
                    <h5 style="margin-bottom:1rem; color:#2c3e50;">Overview (Last 30 Days)</h5>
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:1rem;">
                        <div style="text-align:center;">
                            <div style="font-size:1.5rem; font-weight:bold; color:#3498db;">${stats.total_suggestions || 0}</div>
                            <div style="font-size:0.9rem; color:#666;">Total Suggestions</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:1.5rem; font-weight:bold; color:#27ae60;">${stats.avg_rating ? stats.avg_rating.toFixed(1) : 'N/A'}/5</div>
                            <div style="font-size:0.9rem; color:#666;">Avg Rating</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:1.5rem; font-weight:bold; color:#e67e22;">${stats.helpful_percentage ? stats.helpful_percentage.toFixed(0) : 0}%</div>
                            <div style="font-size:0.9rem; color:#666;">Helpful</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:1.5rem; font-weight:bold; color:#9b59b6;">${stats.implementation_percentage ? stats.implementation_percentage.toFixed(0) : 0}%</div>
                            <div style="font-size:0.9rem; color:#666;">Implemented</div>
                        </div>
                    </div>
                </div>
            `;

            // Recent suggestions
            let historyHtml = `
                <h5 style="margin-bottom:1rem; color:#2c3e50;">Recent Suggestions</h5>
                <div style="max-height:400px; overflow-y:auto;">
            `;

            data.recent_suggestions.slice(0, 20).forEach((suggestion, index) => {
                const date = new Date(suggestion.timestamp).toLocaleDateString();
                const time = new Date(suggestion.timestamp).toLocaleTimeString();
                const rating = suggestion.user_rating ? '★'.repeat(suggestion.user_rating) + '☆'.repeat(5 - suggestion.user_rating) : 'Not rated';
                
                historyHtml += `
                    <div style="border:1px solid #ddd; border-radius:8px; padding:1rem; margin-bottom:1rem; background:white;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem;">
                            <div style="font-weight:bold; color:#2c3e50;">${suggestion.suggestion_method || 'AI'} Suggestion</div>
                            <div style="font-size:0.9rem; color:#666;">${date} ${time}</div>
                        </div>
                        <div style="margin-bottom:0.5rem; color:#666; font-size:0.9rem;">
                            <strong>Context:</strong> "${(suggestion.sentence_context || '').substring(0, 100)}${suggestion.sentence_context && suggestion.sentence_context.length > 100 ? '...' : ''}"
                        </div>
                        <div style="margin-bottom:0.5rem; padding:0.5rem; background:#f8f9fa; border-radius:4px; font-size:0.9rem;">
                            ${suggestion.feedback_text || 'No suggestion text available'}
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.9rem;">
                            <div style="color:#666;">
                                <span style="margin-right:1rem;">📄 ${suggestion.document_type || 'Unknown'}</span>
                                <span>⏱️ ${suggestion.response_time ? (suggestion.response_time * 1000).toFixed(0) + 'ms' : 'N/A'}</span>
                            </div>
                            <div style="color:#f39c12;">${rating}</div>
                        </div>
                        ${suggestion.user_feedback ? `<div style="margin-top:0.5rem; padding:0.5rem; background:#e8f5e8; border-radius:4px; font-size:0.9rem;"><strong>Your feedback:</strong> ${suggestion.user_feedback}</div>` : ''}
                    </div>
                `;
            });

            historyHtml += '</div>';
            content.innerHTML = overviewHtml + historyHtml;
        }

        // Settings Modal Functions
        function showSettingsModal() {
            const modal = document.getElementById('settingsModal');
            const loading = document.getElementById('settingsLoading');
            const content = document.getElementById('settingsContent');
            
            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.innerHTML = '';
            
            // Fetch settings data
            fetch('/ai_config')
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    renderSettingsContent(data);
                })
                .catch(error => {
                    loading.style.display = 'none';
                    content.innerHTML = '<div style="color:#e74c3c; text-align:center; padding:2rem;"><i class="fas fa-exclamation-triangle"></i> Failed to load settings.</div>';
                    console.error('Error loading settings:', error);
                });
        }

        function renderSettingsContent(data) {
            const content = document.getElementById('settingsContent');
            const config = data.suggestion_config || {};
            const flags = data.feature_flags || {};
            
            content.innerHTML = `
                <div style="margin-bottom:2rem;">
                    <h5 style="color:#2c3e50; margin-bottom:1rem;">
                        <i class="fas fa-brain" style="margin-right:8px; color:#3498db;"></i>
                        AI Suggestion Behavior
                    </h5>
                    <div style="display:grid; gap:1rem;">
                        <div>
                            <label style="display:block; margin-bottom:0.5rem; font-weight:500;">Confidence Threshold</label>
                            <input type="range" id="confidenceThreshold" min="0.1" max="1.0" step="0.05" value="${config.min_confidence_threshold || 0.7}" 
                                   style="width:100%;" onchange="updateConfidenceDisplay(this.value)">
                            <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#666;">
                                <span>More suggestions (0.1)</span>
                                <span id="confidenceValue">${((config.min_confidence_threshold || 0.7) * 100).toFixed(0)}%</span>
                                <span>Fewer, higher quality (1.0)</span>
                            </div>
                        </div>
                        
                        <div>
                            <label style="display:block; margin-bottom:0.5rem; font-weight:500;">Max Suggestions per Issue</label>
                            <select id="maxSuggestions" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:4px;">
                                <option value="1" ${config.max_suggestions_per_issue === 1 ? 'selected' : ''}>1 suggestion</option>
                                <option value="2" ${config.max_suggestions_per_issue === 2 ? 'selected' : ''}>2 suggestions</option>
                                <option value="3" ${config.max_suggestions_per_issue === 3 ? 'selected' : ''}>3 suggestions</option>
                                <option value="5" ${config.max_suggestions_per_issue === 5 ? 'selected' : ''}>5 suggestions</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom:2rem;">
                    <h5 style="color:#2c3e50; margin-bottom:1rem;">
                        <i class="fas fa-toggle-on" style="margin-right:8px; color:#27ae60;"></i>
                        Feature Settings
                    </h5>
                    <div style="display:grid; gap:1rem;">
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="includeAlternatives" ${config.include_alternatives ? 'checked' : ''} style="margin-right:0.5rem;">
                            <span>Include alternative suggestions</span>
                            <div style="margin-left:auto; font-size:0.8rem; color:#666;">Provides multiple options for each issue</div>
                        </label>
                        
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="includeExplanations" ${config.include_explanations ? 'checked' : ''} style="margin-right:0.5rem;">
                            <span>Include explanations</span>
                            <div style="margin-left:auto; font-size:0.8rem; color:#666;">Explains why changes are suggested</div>
                        </label>
                        
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="personalizeToUser" ${config.personalize_to_user ? 'checked' : ''} style="margin-right:0.5rem;">
                            <span>Personalize suggestions</span>
                            <div style="margin-left:auto; font-size:0.8rem; color:#666;">Learn from your feedback and preferences</div>
                        </label>
                    </div>
                </div>

                <div>
                    <h5 style="color:#2c3e50; margin-bottom:1rem;">
                        <i class="fas fa-flask" style="margin-right:8px; color:#e67e22;"></i>
                        Advanced Features
                    </h5>
                    <div style="display:grid; gap:1rem;">
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="aiPoweredSuggestions" ${flags.ai_powered_suggestions !== false ? 'checked' : ''} style="margin-right:0.5rem;">
                            <span>AI-Powered Suggestions</span>
                            <div style="margin-left:auto; font-size:0.8rem; color:#666;">Use AI for complex grammar improvements</div>
                        </label>
                        
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="contextAwareAnalysis" ${flags.context_aware_analysis !== false ? 'checked' : ''} style="margin-right:0.5rem;">
                            <span>Context-Aware Analysis</span>
                            <div style="margin-left:auto; font-size:0.8rem; color:#666;">Consider document context for better suggestions</div>
                        </label>
                        
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="learningFromFeedback" ${flags.learning_from_feedback !== false ? 'checked' : ''} style="margin-right:0.5rem;">
                            <span>Learning from Feedback</span>
                            <div style="margin-left:auto; font-size:0.8rem; color:#666;">Improve suggestions based on your feedback</div>
                        </label>
                    </div>
                </div>
            `;
        }

        function updateConfidenceDisplay(value) {
            document.getElementById('confidenceValue').textContent = (value * 100).toFixed(0) + '%';
        }

        function saveSettings() {
            const saveBtn = document.getElementById('saveSettingsBtn');
            const originalText = saveBtn.innerHTML;
            
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
            saveBtn.disabled = true;
            
            const settings = {
                suggestion_config: {
                    min_confidence_threshold: parseFloat(document.getElementById('confidenceThreshold').value),
                    max_suggestions_per_issue: parseInt(document.getElementById('maxSuggestions').value),
                    include_alternatives: document.getElementById('includeAlternatives').checked,
                    include_explanations: document.getElementById('includeExplanations').checked,
                    personalize_to_user: document.getElementById('personalizeToUser').checked
                },
                feature_flags: {
                    ai_powered_suggestions: document.getElementById('aiPoweredSuggestions').checked,
                    context_aware_analysis: document.getElementById('contextAwareAnalysis').checked,
                    learning_from_feedback: document.getElementById('learningFromFeedback').checked
                }
            };
            
            fetch('/ai_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                saveBtn.style.background = '#27ae60';
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }, 2000);
            })
            .catch(error => {
                saveBtn.innerHTML = '<i class="fas fa-times"></i> Error';
                saveBtn.style.background = '#e74c3c';
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }, 2000);
                console.error('Error saving settings:', error);
            });
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
                const settings = {
                    suggestion_config: {
                        min_confidence_threshold: 0.7,
                        max_suggestions_per_issue: 3,
                        include_alternatives: true,
                        include_explanations: true,
                        personalize_to_user: false
                    },
                    feature_flags: {
                        ai_powered_suggestions: true,
                        context_aware_analysis: true,
                        learning_from_feedback: true
                    }
                };
                
                fetch('/ai_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                })
                .then(() => {
                    showSettingsModal(); // Reload the modal with new values
                })
                .catch(error => {
                    console.error('Error resetting settings:', error);
                });
            }
        }
    </script>
    <div id="loadingOverlay" style="display:none;">
      <div class="spinner-container">
        <i class="fas fa-spinner fa-spin fa-5x"></i>
        <div style="margin-top:20px;font-size:1.5rem;">Analyzing, please wait...</div>
      </div>
    </div>
    <div id="suggestionModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; color:#222; padding:2rem; border-radius:8px; min-width:300px; max-width:90vw; max-height:80vh; overflow:auto; position:relative;">
        <button id="closeSuggestionModal" style="position:absolute; top:10px; right:10px;" class="btn btn-sm btn-secondary">&times;</button>
        <div id="suggestionLoading" style="display:none;">
        <span class="spinner-border spinner-border-sm"></span> Generating suggestion...
        </div>
        <div id="suggestionText"></div>
    </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; color:#222; padding:2rem; border-radius:12px; min-width:800px; max-width:90vw; max-height:80vh; overflow:auto; position:relative;">
            <h3 style="margin-top:0; color:#2c3e50; display:flex; align-items:center;">
                <i class="fas fa-history" style="margin-right:10px; color:#3498db;"></i>
                Suggestion History
            </h3>
            <div id="historyLoading" style="display:none; text-align:center; padding:2rem;">
                <span class="spinner-border spinner-border-sm"></span> Loading history...
            </div>
            <div id="historyContent"></div>
            <div style="margin-top:2rem; padding-top:1rem; border-top:1px solid #eee; text-align:right;">
                <button id="closeHistoryBottomBtn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; color:#222; padding:2rem; border-radius:12px; min-width:700px; max-width:90vw; max-height:80vh; overflow:auto; position:relative;">
            <h3 style="margin-top:0; color:#2c3e50; display:flex; align-items:center;">
                <i class="fas fa-cog" style="margin-right:10px; color:#e74c3c;"></i>
                AI Assistant Settings
            </h3>
            <div id="settingsLoading" style="display:none; text-align:center; padding:2rem;">
                <span class="spinner-border spinner-border-sm"></span> Loading settings...
            </div>
            <div id="settingsContent"></div>
            <div style="margin-top:2rem; padding-top:1rem; border-top:1px solid #eee; text-align:right;">
                <button id="saveSettingsBtn" class="btn btn-primary" style="margin-right:10px;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button id="resetSettingsBtn" class="btn btn-outline-secondary" style="margin-right:10px;">
                    <i class="fas fa-undo"></i> Reset to Defaults
                </button>
                <button id="closeSettingsBottomBtn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
</body>
</html>