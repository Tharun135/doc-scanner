<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doc Scanner â€“ Advanced Analysis</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-color: #121C3A;
            --secondary-color: #177E89;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --highlight-color: #FFD700;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-color), #1E2D5C, var(--secondary-color));
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .navbar {
            background: linear-gradient(135deg, #233D80, var(--secondary-color));
            padding: 1rem;
        }

        .sidebar {
            background: rgba(20, 30, 60, 0.9);
            height: calc(100vh - 56px);
            overflow-y: auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .dropzone {
            position: relative;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            transition: all 0.3s ease;
            padding: 20px;
            text-align: center;
            cursor: pointer;
        }

        .dropzone:hover {
            border-color: var(--secondary-color);
            background: rgba(255, 255, 255, 0.1);
        }

        .dropzone.drag-over {
            border-color: #177E89;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .content-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .document-section, .feedback-section {
            overflow-y: auto;
            padding: 1rem;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.2);
        }

        .sentence {
            transition: background-color 0.3s ease;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 2px 0;
            display: inline-block;
            line-height: 1.6;
        }

        .sentence.highlight {
            background-color: var(--highlight-color);
            color: black;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        }

        .sentence.has-feedback {
            border-left: 3px solid #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
        }

        .feedback-item {
            background: #fffbe6 !important;      /* Light yellow background */
            color: #333 !important;              /* Dark text for contrast */
            border-left: 5px solid #ffc107;      /* Emphasize with a yellow border */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .feedback-item:hover {
            background: #fff3cd !important;
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .feedback-item.highlighted {
            background: #e7f3ff !important;
            border-left-color: #007bff !important;
            animation: pulse 1s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .original-content {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .sentence-container {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
        }

        .sentence-list {
            line-height: 1.8;
        }

        .sentence-highlight {
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 1px 0;
            position: relative;
            display: inline;
            line-height: 1.6;
        }

        .sentence-highlight.highlight {
            background-color: #ffeb3b;
            color: #333;
            font-weight: 500;
            border: 1px solid #fdd835;
        }

        .sentence-highlight.has-feedback {
            background-color: rgba(255, 193, 7, 0.2);
            border-bottom: 2px solid #ff9800;
        }

        .sentence-highlight.has-feedback:hover {
            background-color: rgba(255, 193, 7, 0.3);
            border-bottom-color: #f57c00;
        }

        .sentence-highlight.sentence-not-found {
            background-color: #ffcdd2;
            border: 1px solid #f44336;
            padding: 3px 6px;
            font-size: 0.85em;
            color: #d32f2f;
            font-weight: 500;
            border-radius: 4px;
        }

        .sentence-highlight.sentence-not-found:hover {
            background-color: #ef9a9a;
        }

        .document-section table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            background: #fff;
            color: #222;
        }
        .document-section th, .document-section td {
            border: 1px solid #ccc;
            padding: 8px 12px;
            text-align: left;
        }
        .document-section th {
            background: #f7f7f7;
            font-weight: bold;
        }

        .feedback-item:hover {
            background: #ffe066 !important;      /* Slightly brighter on hover */
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .toolbar button {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-primary);
            border-radius: 3px;
            cursor: pointer;
        }

        /* Dark mode styles */
        body.dark-mode {
            --primary-color: #000000;
            --text-primary: #ffffff;
            background: linear-gradient(135deg, #000000, #1a1a1a);
        }
        #loadingOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(18,28,58,0.85);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}
.spinner-container {
    text-align: center;
    color: #FFD700;
}

/* AI Enhancement Indicators */
.ai-enhancement-badge {
    background: linear-gradient(45deg, #6c5ce7, #a29bfe);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    margin-left: 0.5rem;
}

.confidence-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: 0.25rem;
}

.confidence-high { background-color: #00b894; }
.confidence-medium { background-color: #fdcb6e; }
.confidence-low { background-color: #e17055; }

.suggestion-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    margin-bottom: 1rem;
}

.feedback-buttons {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.feedback-btn {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.feedback-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}        .feedback-btn.active {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
        }
        
        /* Tab System Styles */
        .tab-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .tab-header {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .tab-button.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .tab-content {
            display: none;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .ai-feedback-icon {
            background: linear-gradient(45deg, #6c5ce7, #a29bfe);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 8px;
        }
        
        .ai-feedback-icon:hover {
            background: linear-gradient(45deg, #5a4fcf, #8b7ff7);
            transform: scale(1.1);
        }
        
        .ai-feedback-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .document-type-selector {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #333;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .document-type-selector option {
            background: #fff;
            color: #333;
            padding: 0.5rem;
        }

.writing-goals {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.goal-tag {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.goal-tag.selected {
    background: var(--secondary-color);
}

.performance-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    z-index: 1000;
}
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-check-circle"></i> Doc Scanner</a>
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-light btn-sm me-2" id="historyBtn">
                    <i class="fas fa-history"></i> History
                </button>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="darkModeToggle">
                    <label class="form-check-label" for="darkModeToggle">Dark Mode</label>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar d-none d-md-block col-md-3 p-3">
            <!-- Upload Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-upload"></i> Upload Document</h5>
                </div>
                <div class="card-body">
                    <!-- Document Type Selector -->
                    <div class="mb-3">
                        <label for="documentType" class="form-label">Document Type:</label>
                        <select id="documentType" class="document-type-selector w-100">
                            <option value="general">General</option>
                            <option value="technical">Technical Documentation</option>
                            <option value="academic">Academic Writing</option>
                            <option value="business">Business Communication</option>
                            <option value="marketing">Marketing Content</option>
                            <option value="creative">Creative Writing</option>
                        </select>
                    </div>

                    <!-- Writing Goals -->
                    <div class="mb-3">
                        <label class="form-label">Writing Goals:</label>
                        <div class="writing-goals">
                            <span class="goal-tag selected" data-goal="clarity">Clarity</span>
                            <span class="goal-tag selected" data-goal="conciseness">Conciseness</span>
                            <span class="goal-tag" data-goal="engagement">Engagement</span>
                            <span class="goal-tag" data-goal="professionalism">Professional</span>
                            <span class="goal-tag" data-goal="accessibility">Accessible</span>
                        </div>
                    </div>

                    <form id="uploadForm" enctype="multipart/form-data">
                        <div id="dropzone" class="dropzone mb-3">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                            <p>Drag & Drop files here or</p>
                            <button type="button" class="btn btn-outline-light btn-sm" id="browseBtn">Browse</button>
                            <input type="file" id="fileInput" accept=".pdf,.md,.adoc,.docx,.txt" style="display: none;">
                        </div>
                        <button class="btn btn-primary w-100" type="submit">
                            <i class="fas fa-upload"></i> Upload & Analyze
                            <span class="ai-enhancement-badge">AI Enhanced</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- AI Performance -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-brain"></i> AI Performance</h5>
                </div>
                <div class="card-body">
                    <div id="aiPerformance">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Response Quality:</span>
                            <span id="qualityScore">-</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Response Time:</span>
                            <span id="responseTime">-</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Method Used:</span>
                            <span id="aiMethod">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Report -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Analysis Report</h5>
                </div>
                <div class="card-body">
                    <canvas id="analysisChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content col-md-9 p-3">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4>Document Content & Feedback</h4>
                        <div class="toolbar">
                            <button id="exportBtn"><i class="fas fa-download"></i> Export</button>
                            <button id="settingsBtn"><i class="fas fa-cog"></i> Settings</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="content-container">
                        <div class="document-section" id="documentContent">
                            <h4>Document Content</h4>
                        </div>
                        <div class="feedback-section">
                            <!-- Tab Container -->
                            <div class="tab-container">
                                <div class="tab-header">
                                    <button class="tab-button active" onclick="switchTab('feedback')">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Issues
                                    </button>
                                    <button class="tab-button" onclick="switchTab('ai-feedback')">
                                        <i class="fas fa-robot me-1"></i>
                                        AI Assistance
                                    </button>
                                </div>
                                <div class="tab-content active" id="feedbackContent">
                                    <h5 class="mb-3">Document Issues</h5>
                                    <!-- Feedback content will be populated here -->
                                </div>
                                <div class="tab-content" id="aiFeedbackContent">
                                    <h5 class="mb-3">AI-Powered Suggestions</h5>
                                    <div class="text-muted text-center py-4">
                                        <i class="fas fa-robot fa-2x mb-2"></i>
                                        <p>Click the AI icon next to any issue to get intelligent suggestions</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // File upload handling
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const uploadForm = document.getElementById('uploadForm');
        let analysisChart;

        // Handle browse button click
        browseBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // Handle file input change
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                handleFiles(files);
            }
        });

        // Drag and drop handlers
dropzone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropzone.classList.add('drag-over');
});

dropzone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropzone.classList.remove('drag-over');
});

dropzone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropzone.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        // Set the file input's files property so the form can use it
        fileInput.files = files;
        handleFiles(files);
    }
});

        // Handle files function
        function handleFiles(files) {
            const file = files[0];
            const allowedTypes = ['.pdf', '.md', '.adoc', '.docx', '.txt'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();

            if (allowedTypes.includes(fileExtension)) {
                dropzone.innerHTML = `
                    <i class="fas fa-file-alt fa-2x mb-2"></i>
                    <p>${file.name}</p>
                    <button type="button" class="btn btn-outline-light btn-sm" id="changeFileBtn">Change File</button>
                `;

                document.getElementById('changeFileBtn').addEventListener('click', () => {
                    fileInput.click();
                });
            } else {
                alert('Invalid file type. Please upload a PDF, MD, ADOC, DOCX, or TXT file.');
                fileInput.value = '';
            }
        }

        // Form submission
        uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!fileInput.files.length) {
        alert('Please select a file first.');
        return;
    }

    // Show spinner
    document.getElementById('loadingOverlay').style.display = 'flex';

    const formData = new FormData();
    formData.append('file', fileInput.files[0]);

    try {
        const submitBtn = uploadForm.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        submitBtn.disabled = true;

        const response = await fetch('/upload', {
            method: 'POST',
            body: formData
        });

        if (!response.ok) throw new Error('Upload failed');

        const result = await response.json();

        renderChart(result.report || {}, result.sentences || []);
        renderContent(result.content || '', result.sentences || []);

        submitBtn.innerHTML = '<i class="fas fa-upload"></i> Upload & Analyze';
        submitBtn.disabled = false;
    } catch (error) {
        console.error('Upload error:', error);
        alert('An error occurred during upload: ' + error.message);

        const submitBtn = uploadForm.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-upload"></i> Upload & Analyze';
        submitBtn.disabled = false;
    } finally {
        // Hide spinner
        document.getElementById('loadingOverlay').style.display = 'none';
    }
});

        // Chart rendering
        function renderChart(report, sentences) {
    const ctx = document.getElementById('analysisChart').getContext('2d');

    if (analysisChart) {
        analysisChart.destroy();
    }

    let totalErrors = sentences.reduce((count, sentence) => count + sentence.feedback.length, 0);
    let totalSentences = sentences.length;
    // Calculate quality index if not provided by backend
    let qualityIndex = report.avgQualityScore !== undefined
        ? report.avgQualityScore
        : (totalSentences === 0 ? 0 : Math.max(0, Math.round(100 * (1 - (totalErrors / totalSentences)))));

    analysisChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Errors', 'Quality Index', 'Total Sentences'],
            datasets: [{
                data: [totalErrors, qualityIndex, totalSentences],
                backgroundColor: ['#ff4d4d', '#007bff', '#17a2b8']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'bottom' }
            }
        }
    });
}

        // Enhanced AI functionality
        let currentSuggestionId = null;
        let selectedWritingGoals = ['clarity', 'conciseness'];
        let aiFeedbackData = {}; // Store AI feedback data by sentence index
        
        // Add event delegation for AI feedback icons
        document.addEventListener('click', function(e) {
            if (e.target.closest('.ai-feedback-icon')) {
                const button = e.target.closest('.ai-feedback-icon');
                const sentenceIndex = parseInt(button.getAttribute('data-sentence-index'));
                const feedback = button.getAttribute('data-feedback');
                const sentence = button.getAttribute('data-sentence');
                
                console.log('AI feedback icon clicked:', { sentenceIndex, feedback, sentence });
                showAIFeedback(sentenceIndex, feedback, sentence);
            }
        });
        
        // Tab switching functionality
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'feedback') {
                document.getElementById('feedbackContent').classList.add('active');
            } else if (tabName === 'ai-feedback') {
                document.getElementById('aiFeedbackContent').classList.add('active');
            }
        }
        
        // Function to add AI feedback to the AI tab
        function addToAITab(sentenceIndex, feedback, sentence, aiSuggestion) {
            const aiFeedbackContainer = document.getElementById('aiFeedbackContent');
            
            // Remove the placeholder if it exists
            const placeholder = aiFeedbackContainer.querySelector('.text-muted.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Create AI feedback item
            const aiDiv = document.createElement('div');
            aiDiv.className = 'ai-feedback-content';
            aiDiv.setAttribute('data-sentence-index', sentenceIndex);
            
            aiDiv.innerHTML = `
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-robot me-2"></i>
                    <strong>Sentence ${sentenceIndex + 1} Analysis</strong>
                    <span class="confidence-indicator confidence-${aiSuggestion.confidence} ms-2"></span>
                    <span class="ai-enhancement-badge ms-2">${aiSuggestion.method}</span>
                </div>
                
                <div class="mb-3">
                    <div class="text-light mb-2"><strong>Issue:</strong></div>
                    <div class="bg-dark bg-opacity-25 p-2 rounded">${feedback}</div>
                </div>
                
                <div class="mb-3">
                    <div class="text-light mb-2"><strong>Original Text:</strong></div>
                    <div class="bg-dark bg-opacity-25 p-2 rounded font-italic">"${sentence}"</div>
                </div>
                
                <div class="mb-3">
                    <div class="text-light mb-2"><strong>AI Suggestion:</strong></div>
                    <div class="suggestion-text bg-light text-dark p-3 rounded">
                        ${formatAISuggestion(aiSuggestion.suggestion)}
                    </div>
                </div>
                
                <div class="feedback-buttons">
                    <button class="feedback-btn" onclick="rateSuggestion('${aiSuggestion.suggestion_id}', 'helpful')">
                        <i class="fas fa-thumbs-up"></i> Helpful
                    </button>
                    <button class="feedback-btn" onclick="rateSuggestion('${aiSuggestion.suggestion_id}', 'not-helpful')">
                        <i class="fas fa-thumbs-down"></i> Not Helpful
                    </button>
                    <button class="feedback-btn" onclick="implementSuggestion('${aiSuggestion.suggestion_id}')">
                        <i class="fas fa-check"></i> Implemented
                    </button>
                    <button class="feedback-btn" onclick="scrollToSentence(${sentenceIndex})">
                        <i class="fas fa-search"></i> View Text
                    </button>
                </div>
            `;
            
            // Insert in order by sentence index
            const existingItems = Array.from(aiFeedbackContainer.querySelectorAll('.ai-feedback-content[data-sentence-index]'));
            let inserted = false;
            
            for (let existingItem of existingItems) {
                const existingIndex = parseInt(existingItem.getAttribute('data-sentence-index'));
                if (sentenceIndex < existingIndex) {
                    aiFeedbackContainer.insertBefore(aiDiv, existingItem);
                    inserted = true;
                    break;
                }
            }
            
            if (!inserted) {
                aiFeedbackContainer.appendChild(aiDiv);
            }
            
            // Store the AI feedback data
            aiFeedbackData[sentenceIndex] = {
                feedback: feedback,
                sentence: sentence,
                aiSuggestion: aiSuggestion
            };
        }
        
        // Function to handle AI feedback icon click
        async function showAIFeedback(sentenceIndex, feedback, sentence) {
            try {
                // Decode the parameters since they were encoded in the HTML
                const decodedFeedback = decodeURIComponent(feedback);
                const decodedSentence = decodeURIComponent(sentence);
                
                console.log('showAIFeedback called:', { sentenceIndex, decodedFeedback, decodedSentence });
                
                // Check if we already have AI feedback for this sentence
                if (aiFeedbackData[sentenceIndex]) {
                    // Switch to AI tab and highlight the existing feedback
                    switchTabProgrammatically('ai-feedback');
                    highlightAIFeedback(sentenceIndex);
                    return;
                }
                
                // Show loading state
                const loadingToast = showLoadingToast('Getting AI suggestions...');
                
                // Get AI suggestion
                const aiSuggestion = await getAISuggestion(decodedFeedback, decodedSentence);
                
                // Hide loading
                hideLoadingToast(loadingToast);
                
                if (aiSuggestion) {
                    // Add to AI tab
                    addToAITab(sentenceIndex, decodedFeedback, decodedSentence, aiSuggestion);
                    
                    // Switch to AI tab
                    switchTabProgrammatically('ai-feedback');
                    
                    // Highlight the new feedback
                    highlightAIFeedback(sentenceIndex);
                } else {
                    showErrorToast('AI suggestion not available');
                }
                
            } catch (error) {
                console.error('Error getting AI feedback:', error);
                showErrorToast('Error getting AI suggestion');
            }
        }
        
        // Function to switch tab programmatically
        function switchTabProgrammatically(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'feedback') {
                document.querySelector('.tab-button:first-child').classList.add('active');
                document.getElementById('feedbackContent').classList.add('active');
            } else if (tabName === 'ai-feedback') {
                document.querySelector('.tab-button:last-child').classList.add('active');
                document.getElementById('aiFeedbackContent').classList.add('active');
            }
        }
        
        // Function to highlight AI feedback item
        function highlightAIFeedback(sentenceIndex) {
            // Remove existing highlights
            document.querySelectorAll('.ai-feedback-content').forEach(item => {
                item.style.transform = '';
                item.style.boxShadow = '';
            });
            
            // Highlight the target item
            const targetItem = document.querySelector(`#aiFeedbackContent [data-sentence-index="${sentenceIndex}"]`);
            if (targetItem) {
                targetItem.style.transform = 'scale(1.02)';
                targetItem.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.4)';
                targetItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                // Remove highlight after a few seconds
                setTimeout(() => {
                    targetItem.style.transform = '';
                    targetItem.style.boxShadow = '';
                }, 3000);
            }
        }
        
        // Toast notification functions
        function showLoadingToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification loading';
            toast.innerHTML = `
                <i class="fas fa-spinner fa-spin me-2"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            
            // Add styles if not already present
            if (!document.querySelector('#toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    .toast-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        z-index: 10000;
                        animation: slideIn 0.3s ease;
                    }
                    .toast-notification.loading {
                        background: linear-gradient(45deg, #6c5ce7, #a29bfe);
                    }
                    .toast-notification.error {
                        background: #e74c3c;
                    }
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            return toast;
        }
        
        function hideLoadingToast(toast) {
            if (toast && toast.parentNode) {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        }
        
        function showErrorToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification error';
            toast.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                hideLoadingToast(toast);
            }, 3000);
        }
        
        // Goal tag selection
        document.querySelectorAll('.goal-tag').forEach(tag => {
            tag.addEventListener('click', () => {
                const goal = tag.dataset.goal;
                tag.classList.toggle('selected');
                
                if (tag.classList.contains('selected')) {
                    if (!selectedWritingGoals.includes(goal)) {
                        selectedWritingGoals.push(goal);
                    }
                } else {
                    selectedWritingGoals = selectedWritingGoals.filter(g => g !== goal);
                }
            });
        });

        // Sentence highlighting and navigation functions
        function highlightSentence(sentenceIndex) {
            // Remove any existing highlights
            unhighlightAllSentences();
            
            // Highlight the target sentence in the content
            const contentSentence = document.getElementById(`content-sentence-${sentenceIndex}`);
            if (contentSentence) {
                contentSentence.classList.add('highlight');
                
                // Auto-scroll to center the sentence in the Document Content section
                const documentSection = document.querySelector('.document-section');
                if (documentSection) {
                    const sentenceRect = contentSentence.getBoundingClientRect();
                    const sectionRect = documentSection.getBoundingClientRect();
                    
                    // Calculate the scroll position to center the sentence
                    const sectionCenter = sectionRect.height / 2;
                    const sentenceRelativeTop = sentenceRect.top - sectionRect.top;
                    const scrollTarget = documentSection.scrollTop + sentenceRelativeTop - sectionCenter;
                    
                    // Smooth scroll to the target position
                    documentSection.scrollTo({
                        top: scrollTarget,
                        behavior: 'smooth'
                    });
                }
            }
            
            // Also highlight in interactive section if it exists
            const interactiveSentence = document.getElementById(`sentence-${sentenceIndex}`);
            if (interactiveSentence) {
                interactiveSentence.classList.add('highlight');
            }
        }
        
        function unhighlightAllSentences() {
            // Remove highlights from content sentences
            document.querySelectorAll('.sentence-highlight.highlight').forEach(sentence => {
                sentence.classList.remove('highlight');
            });
            
            // Remove highlights from interactive sentences
            document.querySelectorAll('.sentence.highlight').forEach(sentence => {
                sentence.classList.remove('highlight');
            });
        }
        
        function highlightFeedbackForSentence(sentenceIndex) {
            // Remove any existing feedback highlights
            document.querySelectorAll('.feedback-item.highlighted').forEach(item => {
                item.classList.remove('highlighted');
            });
            
            // Highlight corresponding feedback items
            document.querySelectorAll(`.feedback-item[data-sentence-index="${sentenceIndex}"]`).forEach(item => {
                item.classList.add('highlighted');
            });
        }
        
        function scrollToSentence(sentenceIndex) {
            // Try content sentence first, then interactive sentence
            let sentenceElement = document.getElementById(`content-sentence-${sentenceIndex}`);
            if (!sentenceElement) {
                sentenceElement = document.getElementById(`sentence-${sentenceIndex}`);
            }
            
            if (sentenceElement) {
                sentenceElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Temporarily highlight the sentence
                highlightSentence(sentenceIndex);
                setTimeout(() => {
                    unhighlightAllSentences();
                }, 2000);
            }
        }

        // Add click handlers to content sentences after they're created
        function addContentSentenceHandlers() {
            document.querySelectorAll('.sentence-highlight').forEach((sentence, index) => {
                sentence.addEventListener('click', () => {
                    const sentenceIndex = parseInt(sentence.getAttribute('data-sentence-index'));
                    highlightFeedbackForSentence(sentenceIndex);
                });
            });
        }

        // Function to add sentence highlighting to HTML content
        function addSentenceHighlighting(htmlContent, sentences) {
            let processedContent = htmlContent;
            
            console.log('Processing sentences for highlighting:', sentences.length);
            console.log('Original HTML content:', htmlContent);
            
            // First, try to get plain text equivalent of HTML for better matching
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            const plainTextContent = tempDiv.textContent || tempDiv.innerText || '';
            console.log('Plain text content:', plainTextContent);
            
            sentences.forEach((sentenceData, index) => {
                const sentence = sentenceData.sentence.trim();
                if (sentence) {
                    console.log(`Processing sentence ${index}:`, sentence);
                    
                    let found = false;
                    const hasFeedback = sentenceData.feedback && sentenceData.feedback.length > 0;
                    const feedbackClass = hasFeedback ? ' has-feedback' : '';
                    
                    // Approach 1: Direct HTML match (works for simple cases)
                    if (processedContent.includes(sentence)) {
                        const replacement = `<span class="sentence-highlight${feedbackClass}" id="content-sentence-${index}" data-sentence-index="${index}">${sentence}</span>`;
                        processedContent = processedContent.replace(sentence, replacement);
                        found = true;
                        console.log(`âœ“ Direct HTML match for sentence ${index}`);
                    }
                    
                    // Approach 2: Try to find sentence in plain text and map back to HTML
                    if (!found && plainTextContent.includes(sentence)) {
                        // Find all words in the sentence
                        const words = sentence.split(/\s+/).filter(word => word.length > 2);
                        
                        if (words.length > 0) {
                            // Create a regex that finds the sentence allowing for HTML tags between words
                            const wordPattern = words.map(word => 
                                word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
                            ).join('(?:[^>]*>.*?<[^>]*)*\\s*');
                            
                            const regex = new RegExp(`(${wordPattern})`, 'gi');
                            
                            const match = processedContent.match(regex);
                            if (match) {
                                const matchedText = match[0];
                                const replacement = `<span class="sentence-highlight${feedbackClass}" id="content-sentence-${index}" data-sentence-index="${index}">${matchedText}</span>`;
                                processedContent = processedContent.replace(matchedText, replacement);
                                found = true;
                                console.log(`âœ“ Word-based match for sentence ${index}`);
                            }
                        }
                    }
                    
                    // Approach 3: Fuzzy text-only match (last resort)
                    if (!found) {
                        // Try to find just the key parts of the sentence
                        const significantWords = sentence.split(/\s+/).filter(word => 
                            word.length > 3 && !['the', 'and', 'for', 'are', 'but', 'not', 'you', 'all', 'can', 'had', 'was', 'one', 'our', 'out', 'day', 'get', 'use', 'man', 'new', 'now', 'old', 'see', 'him', 'two', 'how', 'its', 'who', 'oil', 'sit', 'set'].includes(word.toLowerCase())
                        );
                        
                        if (significantWords.length >= 2) {
                            let bestMatch = null;
                            let bestMatchLength = 0;
                            
                            // Look for the longest substring that contains significant words
                            const tempDiv2 = document.createElement('div');
                            tempDiv2.innerHTML = processedContent;
                            const textContent = tempDiv2.textContent;
                            
                            significantWords.forEach(word => {
                                const wordRegex = new RegExp(`[^.!?]*${word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}[^.!?]*[.!?]`, 'gi');
                                const matches = textContent.match(wordRegex);
                                if (matches) {
                                    matches.forEach(match => {
                                        if (match.length > bestMatchLength) {
                                            bestMatch = match.trim();
                                            bestMatchLength = match.length;
                                        }
                                    });
                                }
                            });
                            
                            if (bestMatch && processedContent.includes(bestMatch)) {
                                const replacement = `<span class="sentence-highlight${feedbackClass}" id="content-sentence-${index}" data-sentence-index="${index}">${bestMatch}</span>`;
                                processedContent = processedContent.replace(bestMatch, replacement);
                                found = true;
                                console.log(`âœ“ Fuzzy match for sentence ${index}: "${bestMatch}"`);
                            }
                        }
                    }
                    
                    if (!found) {
                        console.warn(`âœ— Could not find sentence ${index} in content:`, sentence);
                        
                        // As absolute last resort, just add a marker
                        const marker = `<span class="sentence-highlight${feedbackClass} sentence-not-found" id="content-sentence-${index}" data-sentence-index="${index}" title="Sentence: ${sentence.replace(/"/g, '&quot;')}">[Sentence ${index + 1}]</span>`;
                        
                        // Try to insert the marker near related content
                        const firstWords = sentence.split(' ').slice(0, 3).join(' ');
                        if (processedContent.includes(firstWords)) {
                            processedContent = processedContent.replace(firstWords, marker + ' ' + firstWords);
                            console.log(`Added fallback marker for sentence ${index}`);
                        }
                    }
                }
            });
            
            console.log('Final processed content length:', processedContent.length);
            return processedContent;
        }

        // Format AI suggestion (structured output)
        function formatAISuggestion(suggestionText) {
            // Try to parse and format structured AI output
            if (!suggestionText) return '';
            // Split by newlines and look for KEY: value pairs
            const lines = suggestionText.split(/\n|<br\s*\/?>(?=\w+:)/g);
            let html = '';
            lines.forEach(line => {
                const match = line.match(/^([A-Z][A-Z_ \-]+):\s*(.*)$/i);
                if (match) {
                    const key = match[1].replace(/_/g, ' ').replace(/\b([a-z])/g, c => c.toUpperCase());
                    const value = match[2];
                    html += `<div style="margin-bottom:4px;"><strong>${key}:</strong> <span style="color:#333;background:rgba(255,255,255,0.7);padding:2px 4px;border-radius:3px;">${value}</span></div>`;
                } else if (line.trim()) {
                    html += `<div style="margin-bottom:4px;">${line}</div>`;
                }
            });
            return html || suggestionText;
        }

        // Enhanced feedback rendering with AI suggestions and hover highlighting
        async function renderFeedbackWithAI(feedback, sentence, sentenceIndex) {
            const feedbackContainer = document.getElementById('feedbackContent');
            
            console.log('renderFeedbackWithAI called with:', feedback, sentence, sentenceIndex);
            
            for (const item of feedback) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback-item p-3 mb-2 border-start';
                feedbackDiv.setAttribute('data-sentence-index', sentenceIndex);
                feedbackDiv.setAttribute('data-order', sentenceIndex); // For sorting
                
                // Add hover functionality to highlight corresponding sentence
                feedbackDiv.addEventListener('mouseenter', () => {
                    highlightSentence(sentenceIndex);
                });
                
                feedbackDiv.addEventListener('mouseleave', () => {
                    unhighlightAllSentences();
                });
                
                // Add click functionality to scroll to sentence
                feedbackDiv.addEventListener('click', (e) => {
                    // Don't trigger if clicking on AI icon
                    if (!e.target.closest('.ai-feedback-icon')) {
                        scrollToSentence(sentenceIndex);
                    }
                });
                
                console.log('Processing feedback item:', item);
                
                feedbackDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="mb-2">
                                <small class="text-muted">Sentence ${sentenceIndex + 1}</small>
                                <i class="fas fa-link ms-2" style="cursor: pointer;" title="Click to view sentence"></i>
                            </div>
                            <strong>Issue:</strong> ${item.message}
                        </div>
                        <button class="ai-feedback-icon" data-sentence-index="${sentenceIndex}" data-feedback="${encodeURIComponent(item.message)}" data-sentence="${encodeURIComponent(sentence)}" title="Get AI suggestions">
                            <i class="fas fa-robot"></i>
                        </button>
                    </div>
                `;
                
                // Insert in the correct order
                const existingItems = Array.from(feedbackContainer.querySelectorAll('.feedback-item[data-order]'));
                let inserted = false;
                
                for (let existingItem of existingItems) {
                    const existingOrder = parseInt(existingItem.getAttribute('data-order'));
                    if (sentenceIndex < existingOrder) {
                        feedbackContainer.insertBefore(feedbackDiv, existingItem);
                        inserted = true;
                        break;
                    }
                }
                
                if (!inserted) {
                    feedbackContainer.appendChild(feedbackDiv);
                }
            }
        }

        async function getAISuggestion(feedback, sentence) {
            try {
                const documentType = document.getElementById('documentType').value;
                
                console.log('getAISuggestion called with:', {
                    feedback: feedback,
                    sentence: sentence,
                    document_type: documentType,
                    writing_goals: selectedWritingGoals
                });
                
                // Validate required parameters
                if (!feedback || !sentence) {
                    console.error('Missing required parameters:', { feedback, sentence });
                    return null;
                }
                
                const response = await fetch('/ai_suggestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        feedback: feedback,
                        sentence: sentence,
                        document_type: documentType,
                        writing_goals: selectedWritingGoals
                    })
                });

                console.log('AI suggestion response status:', response.status);
                console.log('AI suggestion response headers:', response.headers);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('AI suggestion result:', result);
                    return result;
                } else {
                    console.error('AI suggestion failed with status:', response.status);
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    return null;
                }
            } catch (error) {
                console.error('AI suggestion error:', error);
                return null;
            }
        }

        function updateAIPerformance(suggestion) {
            const confidenceMap = {
                'high': 'â˜…â˜…â˜…',
                'medium': 'â˜…â˜…â˜†',
                'low': 'â˜…â˜†â˜†'
            };
            
            document.getElementById('qualityScore').textContent = confidenceMap[suggestion.confidence] || '-';
            document.getElementById('aiMethod').textContent = suggestion.method || '-';
            
            // Show performance indicator
            const indicator = document.createElement('div');
            indicator.className = 'performance-indicator';
            indicator.textContent = `AI Response: ${suggestion.confidence} confidence`;
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.remove();
            }, 3000);
        }

        async function rateSuggestion(suggestionId, rating) {
            try {
                const response = await fetch('/suggestion_feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        suggestion_id: suggestionId,
                        was_helpful: rating === 'helpful'
                    })
                });

                if (response.ok) {
                    // Visual feedback
                    event.target.classList.add('active');
                    event.target.innerHTML = rating === 'helpful' ? 
                        '<i class="fas fa-check"></i> Thanks!' : 
                        '<i class="fas fa-check"></i> Noted';
                }
            } catch (error) {
                console.error('Feedback error:', error);
            }
        }

        async function implementSuggestion(suggestionId) {
            try {
                const response = await fetch('/suggestion_feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        suggestion_id: suggestionId,
                        was_implemented: true
                    })
                });

                if (response.ok) {
                    event.target.classList.add('active');
                    event.target.innerHTML = '<i class="fas fa-check"></i> Implemented';
                }
            } catch (error) {
                console.error('Implementation feedback error:', error);
            }
        }

        // Enhanced content rendering with sentence highlighting
        function renderContent(content, sentences) {
            const documentContent = document.getElementById('documentContent');
            const feedbackContent = document.getElementById('feedbackContent');
            const aiFeedbackContent = document.getElementById('aiFeedbackContent');
            
            // Clear previous content
            documentContent.innerHTML = '<h4>Document Content</h4>';
            feedbackContent.innerHTML = '<h5 class="mb-3">Document Issues</h5>';
            
            // Reset AI feedback tab
            aiFeedbackContent.innerHTML = `
                <h5 class="mb-3">AI-Powered Suggestions</h5>
                <div class="text-muted text-center py-4">
                    <i class="fas fa-robot fa-2x mb-2"></i>
                    <p>Click the AI icon next to any issue to get intelligent suggestions</p>
                </div>
            `;
            
            // Clear AI feedback data
            aiFeedbackData = {};
            
            console.log('Processing sentences:', sentences.length);
            console.log('Sentences data:', sentences);
            
            // Create enhanced HTML content with highlighted sentences
            const originalContentDiv = document.createElement('div');
            originalContentDiv.className = 'original-content mt-3';
            
            // Process the HTML content to add sentence highlighting
            const enhancedContent = addSentenceHighlighting(content, sentences);
            originalContentDiv.innerHTML = enhancedContent;
            
            // Store sentences for reference
            window.currentSentences = sentences;
            
            // Add the enhanced content to document
            documentContent.appendChild(originalContentDiv);
            
            // Add click handlers to the newly created sentence spans
            setTimeout(() => {
                addContentSentenceHandlers();
            }, 100);
            
            // Process sentences with AI enhancement - in document order
            let feedbackCount = 0;
            const feedbackPromises = [];
            
            // Collect all feedback rendering promises to maintain order
            sentences.forEach((sentenceData, index) => {
                console.log(`Sentence ${index}:`, sentenceData);
                if (sentenceData.feedback && sentenceData.feedback.length > 0) {
                    feedbackCount++;
                    console.log(`Rendering feedback for sentence ${index}:`, sentenceData.feedback);
                    // Store the promise with the index to maintain order
                    feedbackPromises.push({
                        index: index,
                        promise: renderFeedbackWithAI(sentenceData.feedback, sentenceData.sentence, index)
                    });
                }
            });
            
            // Wait for all feedback to be rendered in order
            if (feedbackPromises.length > 0) {
                // Process feedback in sequential order
                feedbackPromises.sort((a, b) => a.index - b.index);
                
                // Execute promises sequentially to maintain order
                feedbackPromises.reduce((prevPromise, current) => {
                    return prevPromise.then(() => current.promise);
                }, Promise.resolve());
            }
            
            // If no feedback found, show a message
            if (feedbackCount === 0) {
                const noIssuesDiv = document.createElement('div');
                noIssuesDiv.className = 'alert alert-success mt-3';
                noIssuesDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-2"></i>
                        <div>
                            <strong>Great work!</strong> No issues detected in your document.
                            <br><small>The AI analysis found your writing to be clear and well-structured.</small>
                        </div>
                    </div>
                `;
                feedbackContent.appendChild(noIssuesDiv);
                
                // Show document quality summary
                const qualitySummary = document.createElement('div');
                qualitySummary.className = 'card mt-3';
                qualitySummary.style.background = 'rgba(255, 255, 255, 0.1)';
                qualitySummary.innerHTML = `
                    <div class="card-header">
                        <h6><i class="fas fa-chart-line"></i> Document Quality Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <small>Total Sentences:</small>
                                <div class="h5">${sentences.length}</div>
                            </div>
                            <div class="col-6">
                                <small>Quality Score:</small>
                                <div class="h5">âœ… Excellent</div>
                            </div>
                        </div>
                    </div>
                `;
                feedbackContent.appendChild(qualitySummary);
            }
        }
        // Clean feedback text
        function cleanFeedback(feedback) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = feedback;
            let cleanText = tempDiv.textContent || tempDiv.innerText || '';

            const fileExtensions = ['csv', 'pdf', 'docx', 'txt', 'md', 'adoc', 'png', 'jpg', 'jpeg', 'gif'];
            const regex = new RegExp(`[^.!?]*(?<!\\b(?:${fileExtensions.join('|')})\\b)[.!?]`, 'g');
            const match = cleanText.match(regex);
            if (match) {
                cleanText = match[0];
            }

            return cleanText;
        }

        // Dark mode toggle
        document.getElementById('darkModeToggle').addEventListener('change', (e) => {
            document.body.classList.toggle('dark-mode', e.target.checked);
        });

        // AI Suggestion Modal logic
        document.body.addEventListener('click', async function(e) {
            if (e.target.closest('.ai-suggest-btn')) {
                const btn = e.target.closest('.ai-suggest-btn');
                const feedback = decodeURIComponent(btn.dataset.feedback);

                // Show modal and loading
                document.getElementById('suggestionModal').style.display = 'flex';
                document.getElementById('suggestionLoading').style.display = 'block';
                document.getElementById('suggestionText').innerHTML = '';

                // Fetch AI suggestion
                try {
                    const res = await fetch('/ai_suggestion', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ feedback })
                    });
                    const data = await res.json();
                    document.getElementById('suggestionLoading').style.display = 'none';
                    if (data.suggestion) {
                        document.getElementById('suggestionText').innerText = data.suggestion;
                    } else {
                        document.getElementById('suggestionText').innerText = 'No suggestion available.';
                    }
                } catch (err) {
                    document.getElementById('suggestionLoading').style.display = 'none';
                    document.getElementById('suggestionText').innerText = 'Error fetching suggestion.';
                }
            }
            if (e.target.id === 'closeSuggestionModal') {
                document.getElementById('suggestionModal').style.display = 'none';
            }
        });

        // Export functionality
        document.getElementById('exportBtn').addEventListener('click', () => {
    // Gather feedback data
    let csvContent = "Sentence,Feedback\n";
    document.querySelectorAll('.sentence').forEach((sentenceSpan) => {
        const idx = sentenceSpan.dataset.index;
        // Find all feedback for this sentence
        const feedbacks = [];
        document.querySelectorAll(`.feedback-item[data-index="${idx}"]`).forEach(fb => {
            feedbacks.push(fb.innerText.replace(/"/g, '""'));
        });
        if (feedbacks.length) {
            csvContent += `"${sentenceSpan.innerText.replace(/"/g, '""')}","${feedbacks.join('; ')}"\n`;
        }
    });

    // Download as CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'feedback_export.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

        // Settings functionality
        document.getElementById('settingsBtn').addEventListener('click', () => {
            alert('Settings feature coming soon!');
        });
    </script>
    <div id="loadingOverlay" style="display:none;">
      <div class="spinner-container">
        <i class="fas fa-spinner fa-spin fa-5x"></i>
        <div style="margin-top:20px;font-size:1.5rem;">Analyzing, please wait...</div>
      </div>
    </div>
    <div id="suggestionModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; color:#222; padding:2rem; border-radius:8px; min-width:300px; max-width:90vw; max-height:80vh; overflow:auto; position:relative;">
        <button id="closeSuggestionModal" style="position:absolute; top:10px; right:10px;" class="btn btn-sm btn-secondary">&times;</button>
        <div id="suggestionLoading" style="display:none;">
        <span class="spinner-border spinner-border-sm"></span> Generating suggestion...
        </div>
        <div id="suggestionText"></div>
    </div>
    </div>
</body>
</html>