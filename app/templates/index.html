<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Doc Scanner – Advanced Analysis</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary-color: #2A3B5A;
            --secondary-color: #2A9BAA;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --highlight-color: #FFD700;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-color), #3A4D7C, var(--secondary-color));
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .navbar {
            background: linear-gradient(135deg, #4A5D9A, var(--secondary-color));
            padding: 1rem;
        }

        .sidebar {
            background: rgba(40, 55, 85, 0.9);
            height: calc(100vh - 56px);
            overflow-y: auto;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .dropzone {
            position: relative;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            transition: all 0.3s ease;
            padding: 20px;
            text-align: center;
            cursor: pointer;
        }

        .dropzone:hover {
            border-color: var(--secondary-color);
            background: rgba(255, 255, 255, 0.1);
        }

        .dropzone.drag-over {
            border-color: #177E89;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .content-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 200px);
        }

        .document-section, .feedback-section {
            overflow: auto;  /* Enable both horizontal and vertical scrolling */
            padding: 1rem;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.2);
        }

        .sentence {
            transition: background-color 0.3s ease;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 2px 0;
            display: inline-block;
            line-height: 1.6;
        }

        .sentence.highlight {
            background-color: var(--highlight-color);
            color: black;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        }

        .sentence.has-feedback {
            border-left: 3px solid #ffc107;
            background-color: rgba(255, 193, 7, 0.1);
        }

        .feedback-item {
            background: #fffbe6 !important;      /* Light yellow background */
            color: #333 !important;              /* Dark text for contrast */
            border-left: 5px solid #ffc107;      /* Emphasize with a yellow border */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .feedback-item:hover {
            background: #fff3cd !important;
            transform: translateX(5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .feedback-item.highlighted {
            background: #e7f3ff !important;
            border-left-color: #007bff !important;
            animation: pulse 1s ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        .original-content {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .sentence-container {
            background: rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
        }

        .sentence-list {
            line-height: 1.8;
        }

        .sentence-highlight {
            transition: all 0.2s ease;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            margin: 1px 0;
            position: relative;
            display: inline;
            line-height: 1.6;
        }

        .sentence-highlight.highlight {
            background-color: #ffeb3b;
            color: #333;
            font-weight: 500;
            border: 1px solid #fdd835;
        }

        .sentence-highlight.has-feedback {
            background-color: rgba(255, 193, 7, 0.2);
            border-bottom: 2px solid #ff9800;
        }

        .sentence-highlight.has-feedback:hover {
            background-color: rgba(255, 193, 7, 0.3);
            border-bottom-color: #f57c00;
        }

        .sentence-highlight.sentence-not-found {
            background-color: #ffcdd2;
            border: 1px solid #f44336;
            padding: 3px 6px;
            font-size: 0.85em;
            color: #d32f2f;
            font-weight: 500;
            border-radius: 4px;
        }

        .sentence-highlight.sentence-not-found:hover {
            background-color: #ef9a9a;
        }

        .document-section table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            background: #fff;
            color: #222;
        }
        .document-section th, .document-section td {
            border: 1px solid #ccc;
            padding: 8px 12px;
            text-align: left;
        }
        .document-section th {
            background: #f7f7f7;
            font-weight: bold;
        }

        .feedback-item:hover {
            background: #ffe066 !important;      /* Slightly brighter on hover */
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
        }

        .toolbar button {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-primary);
            border-radius: 3px;
            cursor: pointer;
        }

        /* Dark mode styles */
        body.dark-mode {
            --primary-color: #000000;
            --text-primary: #ffffff;
            background: linear-gradient(135deg, #000000, #1a1a1a);
        }
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(42, 59, 90, 0.95), rgba(42, 155, 170, 0.95));
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .progress-container {
            text-align: center;
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            min-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.8);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .progress-title {
            font-size: 20px;
            margin-bottom: 30px;
            color: #ffffff;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* Circular Progress Indicator */
        .circular-progress {
            position: relative;
            width: 150px;
            height: 150px;
            margin: 0 auto 30px;
        }
        
        .circular-progress svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
            filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
        }
        
        .circular-progress .track {
            fill: none;
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 8;
        }
        
        .circular-progress .progress-ring {
            fill: none;
            stroke: url(#gradient);
            stroke-width: 8;
            stroke-linecap: round;
            stroke-dasharray: 440;
            stroke-dashoffset: 440;
            transition: stroke-dashoffset 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            animation: pulse 2s ease-in-out infinite alternate;
        }
        
        @keyframes pulse {
            0% {
                stroke-width: 8;
                filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
            }
            100% {
                stroke-width: 10;
                filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8));
            }
        }
        
        /* Particle effect around circular progress */
        .circular-progress::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 215, 0, 0.2), transparent, rgba(255, 165, 0, 0.3), transparent);
            animation: rotate 3s linear infinite;
            z-index: -1;
        }
        
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        .progress-percentage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 28px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from {
                text-shadow: 0 0 5px #FFD700, 0 0 10px #FFD700;
                transform: translate(-50%, -50%) scale(1);
            }
            to {
                text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700, 0 0 30px #FFD700;
                transform: translate(-50%, -50%) scale(1.05);
            }
        }
        
        /* Linear Progress Bar */
        .progress-bar-container {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            height: 8px;
            margin: 25px 0;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar-fill {
            background: linear-gradient(90deg, #FFD700, #FFA500, #FF6B6B);
            height: 100%;
            width: 0%;
            border-radius: 15px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }
        
        .progress-message {
            font-size: 16px;
            color: #ffffff;
            margin-top: 15px;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            min-height: 24px;
        }
        
        .progress-stage {
            font-size: 14px;
            color: #cccccc;
            margin-top: 8px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .progress-icon {
            font-size: 16px;
            margin-right: 8px;
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Stage indicators */
        .stage-indicators {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .stage-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .stage-indicator.active {
            background: #FFD700;
            box-shadow: 0 0 10px #FFD700;
            animation: bounce 1s ease-in-out infinite;
        }
        
        .stage-indicator.completed {
            background: #00FF88;
            box-shadow: 0 0 10px #00FF88;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-8px);
            }
            60% {
                transform: translateY(-4px);
            }
        }
        
        @keyframes celebration {
            0% {
                transform: scale(1) rotate(0deg);
            }
            25% {
                transform: scale(1.2) rotate(5deg);
            }
            50% {
                transform: scale(1.1) rotate(-5deg);
            }
            75% {
                transform: scale(1.15) rotate(3deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
            }
        }
        
        @keyframes completePulse {
            0% {
                stroke-width: 8;
                filter: drop-shadow(0 0 5px rgba(0, 255, 136, 0.5));
            }
            50% {
                stroke-width: 12;
                filter: drop-shadow(0 0 25px rgba(0, 255, 136, 1));
            }
            100% {
                stroke-width: 8;
                filter: drop-shadow(0 0 10px rgba(0, 255, 136, 0.7));
            }
        }
        
        @keyframes completeShimmer {
            0% {
                background-position: -100% 0;
            }
            100% {
                background-position: 100% 0;
            }
        }
        
        /* Celebration animations */
        @keyframes celebration {
            0% {
                transform: translate(-50%, -50%) scale(1);
            }
            25% {
                transform: translate(-50%, -50%) scale(1.2);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.1);
            }
            75% {
                transform: translate(-50%, -50%) scale(1.15);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
            }
        }
        
        @keyframes completePulse {
            0% {
                stroke-width: 8;
                filter: drop-shadow(0 0 5px rgba(0, 255, 136, 0.5));
            }
            50% {
                stroke-width: 12;
                filter: drop-shadow(0 0 25px rgba(0, 255, 136, 1));
            }
            100% {
                stroke-width: 8;
                filter: drop-shadow(0 0 15px rgba(0, 255, 136, 0.7));
            }
        }
        
        @keyframes completeShimmer {
            0% {
                background: linear-gradient(90deg, #FFD700, #FFA500, #FF6B6B);
            }
            50% {
                background: linear-gradient(90deg, #00FF88, #00D4AA, #0099CC);
            }
            100% {
                background: linear-gradient(90deg, #00FF88, #00D4AA, #0099CC);
            }
        }
.spinner-container {
    text-align: center;
    color: #FFD700;
}

.sources-container {
    max-height: 200px;
    overflow-y: auto;
}

.source-item {
    border-left: 3px solid #00b894;
    transition: all 0.3s ease;
}

.source-item:hover {
    border-left-color: #00cec9;
    background: rgba(0, 184, 148, 0.1) !important;
}

.source-content {
    font-size: 0.9rem;
    font-style: italic;
    margin-top: 0.25rem;
}

.confidence-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: 0.25rem;
}

.confidence-high { background-color: #00b894; }
.confidence-medium { background-color: #fdcb6e; }
.confidence-low { background-color: #e17055; }

.suggestion-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    margin-bottom: 1rem;
}
        
        /* Tab System Styles */
        .tab-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .tab-header {
            display: flex;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tab-button {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .tab-button.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border-bottom: 2px solid var(--secondary-color);
        }
        
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }
        
        .tab-content {
            display: none;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .ai-feedback-icon {
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 8px;
        }
        
        .ai-feedback-icon:hover {
            background: #5a6268;
            transform: scale(1.1);
        }
        
        .ai-feedback-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #212529;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .performance-indicator {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    z-index: 1000;
}

        /* Enhanced AI Writing Assistant Dashboard */
        .metric-card {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.8rem;
    text-align: center;
    transition: all 0.3s ease;
}

.metric-card:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateY(-2px);
}

.metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--highlight-color);
}

.metric-label {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-top: 0.2rem;
}

.quality-score-container {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 0.8rem;
}

.quality-score {
    background: var(--secondary-color);
    color: white;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-weight: bold;
    font-size: 0.9rem;
}

.quality-progress .progress-bar {
    background: #6c757d;
    transition: width 1s ease;
}


.issues-progress {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 0.8rem;
}

.smart-insights {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 0.8rem;
}

.insight-item {
    background: rgba(255, 215, 0, 0.1);
    border-left: 3px solid var(--highlight-color);
    padding: 0.5rem;
    margin: 0.3rem 0;
    border-radius: 4px;
    font-size: 0.85rem;
}

.insight-item.active {
    background: rgba(255, 215, 0, 0.2);
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

.file-list-item {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .file-list-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .file-list-item .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-list-item .file-size {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .file-list-item .remove-file {
            background: rgba(255, 0, 0, 0.2);
            border: none;
            color: #ff6b6b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-list-item .remove-file:hover {
            background: rgba(255, 0, 0, 0.4);
            transform: scale(1.1);
        }

        .batch-progress {
            margin-top: 1rem;
            display: none;
        }

        .batch-progress .progress-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .batch-progress .progress-item.processing {
            background: rgba(255, 193, 7, 0.2);
            border-left: 3px solid #ffc107;
        }

        .batch-progress .progress-item.completed {
            background: rgba(40, 167, 69, 0.2);
            border-left: 3px solid #28a745;
        }

        .batch-progress .progress-item.error {
            background: rgba(220, 53, 69, 0.2);
            border-left: 3px solid #dc3545;
        }

        .batch-results {
            margin-top: 1rem;
            display: none;
        }

        .batch-results .result-summary {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .batch-results .result-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .batch-results .result-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(3px);
        }

        .batch-results .result-item.active {
            border-color: var(--secondary-color);
            background: rgba(42, 155, 170, 0.2);
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="fas fa-check-circle"></i> Doc Scanner</a>
            <div class="d-flex align-items-center">
                <button class="btn btn-outline-light btn-sm me-2" id="historyBtn">
                    <i class="fas fa-history"></i> History
                </button>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="darkModeToggle">
                    <label class="form-check-label" for="darkModeToggle">Dark Mode</label>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="d-flex">
        <!-- Sidebar -->
        <div class="sidebar d-none d-md-block col-md-3 p-3">
            <!-- Upload Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-upload"></i> Upload Document</h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div id="dropzone" class="dropzone mb-3">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                            <p>Drag & Drop files here or</p>
                            <div class="d-flex justify-content-center gap-3 mt-2">
                                <button type="button" class="btn btn-outline-light btn-sm" id="browseBtn">Browse Files</button>
                                <button type="button" class="btn btn-outline-light btn-sm" id="browseBatchBtn">Browse Zip</button>
                            </div>
                            <input type="file" id="fileInput" accept=".pdf,.md,.adoc,.docx,.txt" style="display: none;">
                            <input type="file" id="batchFileInput" accept=".zip" style="display: none;">
                            <input type="file" id="multiFileInput" accept=".pdf,.md,.adoc,.docx,.txt" multiple style="display: none;">
                        </div>
                        <div id="fileList" class="mb-3" style="display: none;">
                            <h6>Selected Files:</h6>
                            <div id="fileListItems"></div>
                        </div>
                        <button class="btn btn-primary w-100" type="submit">
                            <i class="fas fa-upload"></i> <span id="uploadBtnText">Upload & Analyze</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- AI Writing Assistant Dashboard -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-brain"></i> AI Writing Assistant</h5>
                </div>
                <div class="card-body">
                    <!-- Document Metrics -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="metric-card">
                                <div class="metric-value" id="wordCount">0</div>
                                <div class="metric-label">Words</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-card">
                                <div class="metric-value" id="sentenceCount">0</div>
                                <div class="metric-label">Sentences</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Writing Quality Score -->
                    <div class="quality-score-container mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">Writing Quality</span>
                            <span class="quality-score" id="qualityScore">-</span>
                        </div>
                        <div class="progress quality-progress">
                            <div class="progress-bar" role="progressbar" id="qualityProgressBar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="qualityDescription">Upload text to see quality metrics</small>
                    </div>
                    

                    <!-- Issues Progress -->
                    <div class="issues-progress mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">Issues Detected</span>
                            <span class="badge bg-warning" id="issuesStats">0</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" role="progressbar" id="issuesProgressBar" style="width: 100%"></div>
                        </div>
                        <small class="text-muted" id="issuesDescription">No issues detected</small>
                    </div>
                    
                    <!-- Smart Insights -->
                    <div class="smart-insights mb-3">
                        <div class="fw-bold mb-2"><i class="fas fa-lightbulb"></i> Smart Insights</div>
                        <div id="smartInsightsList">
                            <div class="insight-item text-muted">
                                <i class="fas fa-info-circle"></i> Upload text to get personalized insights
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Report -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie"></i> Analysis Report</h5>
                </div>
                <div class="card-body">
                    <canvas id="analysisChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="content col-md-9 p-3">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4>Document Content & Feedback</h4>
                        <div class="toolbar">
                            <button id="exportBtn"><i class="fas fa-download"></i> Export</button>
                            <button id="settingsBtn"><i class="fas fa-cog"></i> Settings</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="content-container">
                        <div class="document-section" id="documentContent">
                            <h4>Document Content</h4>
                        </div>
                        <div class="feedback-section">
                            <!-- Tab Container -->
                            <div class="tab-container">
                                <div class="tab-header">
                                    <button class="tab-button active" onclick="switchTab('feedback')">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Issues
                                    </button>
                                    <button class="tab-button" onclick="switchTab('ai-feedback')">
                                        <i class="fas fa-robot me-1"></i>
                                        AI Assistance
                                    </button>
                                </div>
                                <div class="tab-content active" id="feedbackContent">
                                    <h5 class="mb-3">Document Issues</h5>
                                    <!-- Feedback content will be populated here -->
                                </div>
                                <div class="tab-content" id="aiFeedbackContent">
                                    <h5 class="mb-3">AI-Powered Suggestions</h5>
                                    <div class="text-muted text-center py-4">
                                        <i class="fas fa-robot fa-2x mb-2"></i>
                                        <p>Click the AI icon next to any issue to get intelligent suggestions</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // File upload handling
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const batchFileInput = document.getElementById('batchFileInput');
        const multiFileInput = document.getElementById('multiFileInput');
        const browseBtn = document.getElementById('browseBtn');
        const browseBatchBtn = document.getElementById('browseBatchBtn');
        const uploadForm = document.getElementById('uploadForm');
        let analysisChart;
        let selectedFiles = [];
        let batchResults = [];

        // Handle browse button clicks using event delegation
        document.addEventListener('click', (e) => {
            if (e.target.id === 'browseBtn') {
                e.preventDefault();
                console.log('Browse button clicked, triggering file input');
                multiFileInput.click();
            } else if (e.target.id === 'browseBatchBtn') {
                e.preventDefault();
                console.log('Browse batch button clicked, triggering batch file input');
                batchFileInput.click();
            }
        });

        // Handle file input changes
        fileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                selectedFiles = Array.from(files);
                updateFileList();
                // Clear the input to allow selecting more files
                e.target.value = '';
            }
        });

        multiFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                // Add new files to existing selection instead of replacing
                const newFiles = Array.from(files);
                
                // Filter out duplicates based on file name and size
                const filteredNewFiles = newFiles.filter(newFile => {
                    return !selectedFiles.some(existingFile => 
                        existingFile.name === newFile.name && existingFile.size === newFile.size
                    );
                });
                
                if (filteredNewFiles.length > 0) {
                    selectedFiles = [...selectedFiles, ...filteredNewFiles];
                    updateFileList();
                }
                
                // Clear the input to allow selecting the same files again if needed
                e.target.value = '';
            }
        });

        batchFileInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                selectedFiles = Array.from(files);
                updateFileList();
                // Clear the input to allow selecting more files
                e.target.value = '';
            }
        });

        // Drag and drop handlers
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('drag-over');
        });

        dropzone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const newFiles = Array.from(files);
                
                // Filter out duplicates based on file name and size
                const filteredNewFiles = newFiles.filter(newFile => {
                    return !selectedFiles.some(existingFile => 
                        existingFile.name === newFile.name && existingFile.size === newFile.size
                    );
                });
                
                if (filteredNewFiles.length > 0) {
                    selectedFiles = [...selectedFiles, ...filteredNewFiles];
                    updateFileList();
                }
            }
        });

        // Update file list display
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const fileListItems = document.getElementById('fileListItems');
            const uploadBtnText = document.getElementById('uploadBtnText');
            
            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                uploadBtnText.textContent = 'Upload & Analyze';
                resetDropzone();
                return;
            }

            fileList.style.display = 'block';
            fileListItems.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-list-item';
                
                const fileSize = formatFileSize(file.size);
                const fileIcon = getFileIcon(file.name);
                
                fileItem.innerHTML = `
                    <div class="file-info">
                        <i class="${fileIcon}"></i>
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">(${fileSize})</span>
                    </div>
                    <button type="button" class="remove-file" onclick="removeFile(${index})" title="Remove file">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                fileListItems.appendChild(fileItem);
            });

            // Update upload button text
            if (selectedFiles.length === 1) {
                uploadBtnText.textContent = 'Upload & Analyze 1 File';
            } else {
                uploadBtnText.textContent = `Upload & Analyze ${selectedFiles.length} Files`;
            }

            // Update dropzone display
            const isZip = selectedFiles.some(file => file.name.toLowerCase().endsWith('.zip'));
            dropzone.innerHTML = `
                <i class="fas fa-${isZip ? 'file-archive' : 'files'} fa-2x mb-2"></i>
                <p>${selectedFiles.length} file${selectedFiles.length > 1 ? 's' : ''} selected</p>
                <div class="d-flex justify-content-center gap-3 mt-2">
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="selectMoreFiles()">Add More</button>
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="clearFiles()">Clear All</button>
                </div>
            `;
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
        }

        function selectMoreFiles() {
            multiFileInput.click();
        }

        function clearFiles() {
            selectedFiles = [];
            updateFileList();
        }

        function resetDropzone() {
            dropzone.innerHTML = `
                <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                <p>Drag & Drop files here or</p>
                <div class="d-flex justify-content-center gap-3 mt-2">
                    <button type="button" class="btn btn-outline-light btn-sm" id="browseBtn">Browse Files</button>
                    <button type="button" class="btn btn-outline-light btn-sm" id="browseBatchBtn">Browse Zip</button>
                </div>
            `;
            
            // No need to re-attach event listeners since we're using event delegation
        }

        function getFileIcon(filename) {
            const ext = filename.toLowerCase().split('.').pop();
            const iconMap = {
                'pdf': 'fas fa-file-pdf text-danger',
                'md': 'fab fa-markdown text-primary',
                'adoc': 'fas fa-file-alt text-success',
                'docx': 'fas fa-file-word text-primary',
                'doc': 'fas fa-file-word text-primary',
                'txt': 'fas fa-file-alt text-muted',
                'zip': 'fas fa-file-archive text-warning'
            };
            return iconMap[ext] || 'fas fa-file text-muted';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Form submission
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('Form submitted! Selected files:', selectedFiles.length);
            // alert(`Form submitted with ${selectedFiles.length} files`); // Debug alert - removed

            if (selectedFiles.length === 0) {
                alert('Please select at least one file first.');
                return;
            }

            // Show progress overlay with debugging
            console.log('Showing loading overlay...');
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
                loadingOverlay.style.zIndex = '99999'; // Force to top
                console.log('Loading overlay should now be visible');
                console.log('Overlay display style:', loadingOverlay.style.display);
            } else {
                console.error('Loading overlay element not found!');
                alert('ERROR: Loading overlay element not found!');
            }

            // Initialize progress display immediately
            updateProgress(0, "Starting analysis...", "parsing");

            const submitBtn = uploadForm.querySelector('button[type="submit"]');
            const originalBtnContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            submitBtn.disabled = true;

            try {
                if (selectedFiles.length === 1) {
                    // Single file upload with progress
                    await processSingleFileWithProgress(selectedFiles[0]);
                } else {
                    // Batch upload
                    await processBatchFiles(selectedFiles);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('An error occurred during upload: ' + error.message);
            } finally {
                // Hide spinner with delay to show completion
                setTimeout(() => {
                    console.log('Hiding loading overlay...');
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                    submitBtn.innerHTML = originalBtnContent;
                    submitBtn.disabled = false;
                }, 1000); // 1 second delay to see completion
            }
        });

        async function processSingleFileWithProgress(file) {
            // Initialize progress
            updateProgress(0, "Starting analysis...", "parsing");
            
            try {
                const formData = new FormData();
                formData.append('file', file);

                console.log('Attempting progressive upload...');
                
                // Start progressive analysis
                const response = await fetch('/upload_progressive', {
                    method: 'POST',
                    body: formData
                });

                console.log('Progressive upload response:', response.status);

                if (!response.ok) {
                    // Show error but don't fallback immediately - let user see what happened
                    console.error('Progressive upload failed with status:', response.status);
                    updateProgress(0, `Progressive upload failed (${response.status}). Trying fallback...`, "error");
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Show error for 2 seconds
                    return await processSingleFile(file);
                }

                const initialResult = await response.json();
                console.log('Progressive upload result:', initialResult);
                
                if (!initialResult.success) {
                    console.error('Progressive analysis failed:', initialResult.error);
                    updateProgress(0, `Analysis failed: ${initialResult.error || 'Unknown error'}. Trying fallback...`, "error");
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Show error for 2 seconds
                    return await processSingleFile(file);
                }

                const analysisId = initialResult.analysis_id;
                console.log('Starting progress monitoring for ID:', analysisId);
                
                // Poll for progress updates
                return new Promise((resolve, reject) => {
                    const pollProgress = async () => {
                        try {
                            console.log('Polling progress for:', analysisId);
                            const progressResponse = await fetch(`/analysis_progress/${analysisId}`);
                            
                            if (!progressResponse.ok) {
                                throw new Error(`Progress fetch failed: ${progressResponse.status}`);
                            }
                            
                            const progress = await progressResponse.json();
                            console.log('Progress update:', progress);
                            
                            updateProgress(
                                progress.percentage || 0, 
                                progress.message || "Processing...", 
                                progress.stage || "working"
                            );
                            
                            if (progress.completed) {
                                if (progress.error) {
                                    console.error('Analysis completed with error:', progress.error);
                                    updateProgress(0, `Error: ${progress.error}. Trying fallback...`, "error");
                                    await new Promise(resolve => setTimeout(resolve, 2000));
                                    try {
                                        const fallbackResult = await processSingleFile(file);
                                        resolve(fallbackResult);
                                    } catch (fallbackError) {
                                        reject(new Error(progress.error));
                                    }
                                } else if (progress.result) {
                                    console.log('Analysis completed successfully:', progress.result);
                                    // Analysis complete, render results
                                    renderChart(progress.result.report || {}, progress.result.sentences || []);
                                    renderContent(progress.result.content || '', progress.result.sentences || []);
                                    resolve(progress.result);
                                } else {
                                    reject(new Error('Analysis completed but no result found'));
                                }
                            } else {
                                // Continue polling
                                setTimeout(pollProgress, 200);
                            }
                        } catch (error) {
                            console.error('Progress polling failed:', error);
                            updateProgress(0, `Progress polling failed: ${error.message}. Trying fallback...`, "error");
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            try {
                                const fallbackResult = await processSingleFile(file);
                                resolve(fallbackResult);
                            } catch (fallbackError) {
                                reject(error);
                            }
                        }
                    };
                    
                    pollProgress();
                });
            } catch (error) {
                console.error('Progressive upload completely failed:', error);
                updateProgress(0, `Upload failed: ${error.message}. Trying fallback...`, "error");
                await new Promise(resolve => setTimeout(resolve, 2000));
                return await processSingleFile(file);
            }
        }

        function updateProgress(percentage, message, stage) {
            console.log(`🎯 Progress Update: ${percentage}% - Stage: ${stage} - Message: ${message}`);
            
            const progressPercentage = document.getElementById('progressPercentage');
            const progressBarFill = document.getElementById('progressBarFill');
            const progressRing = document.getElementById('progressRing');
            const progressMessage = document.getElementById('progressMessage');
            const progressStage = document.getElementById('progressStage');
            const progressIcon = document.querySelector('.progress-icon');
            
            // Force progress display visibility
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
                loadingOverlay.style.zIndex = '99999';
                console.log('Progress overlay displayed');
            }
            
            // Update percentage display
            if (progressPercentage) {
                progressPercentage.textContent = `${Math.round(percentage)}%`;
                
                // Add celebration effect when reaching 100%
                if (percentage >= 100) {
                    progressPercentage.style.animation = 'celebration 0.8s ease-in-out';
                    setTimeout(() => {
                        if (progressPercentage.style) {
                            progressPercentage.style.animation = 'glow 2s ease-in-out infinite alternate';
                        }
                    }, 800);
                }
                
                console.log('Updated percentage display');
            } else {
                console.error('Progress percentage element not found');
            }
            
            // Update circular progress ring
            if (progressRing) {
                const circumference = 2 * Math.PI * 70; // radius = 70
                const offset = circumference - (percentage / 100) * circumference;
                progressRing.style.strokeDashoffset = offset;
                
                // Add completion effect
                if (percentage >= 100) {
                    progressRing.style.stroke = 'url(#completionGradient)';
                    progressRing.style.animation = 'completePulse 1s ease-in-out';
                }
                
                console.log(`Updated circular progress to ${percentage}%`);
            }
            
            // Update linear progress bar
            if (progressBarFill) {
                progressBarFill.style.width = `${percentage}%`;
                
                // Add completion effect
                if (percentage >= 100) {
                    progressBarFill.style.background = 'linear-gradient(90deg, #00FF88, #00D4AA, #0099CC)';
                    progressBarFill.style.animation = 'completeShimmer 1s ease-in-out';
                }
                
                console.log(`Updated progress bar width to ${percentage}%`);
            } else {
                console.error('Progress bar fill element not found');
            }
            
            if (progressMessage) {
                progressMessage.textContent = message;
                console.log('Updated progress message');
            } else {
                console.error('Progress message element not found');
            }
            
            // Update document title with progress
            if (percentage < 100) {
                document.title = `(${Math.round(percentage)}%) Analyzing - Doc Scanner`;
            } else {
                document.title = 'Doc Scanner - Analysis Complete';
            }
            
            // Update stage indicators
            updateStageIndicators(stage, percentage);
            
            if (progressStage) {
                const stageConfig = {
                    'parsing': { name: 'Parsing Document', icon: 'fas fa-file-alt' },
                    'segmentation': { name: 'Breaking into Sentences', icon: 'fas fa-cut' }, 
                    'analysis': { name: 'Analyzing Content Quality', icon: 'fas fa-search' },
                    'reporting': { name: 'Generating Report', icon: 'fas fa-chart-bar' },
                    'complete': { name: 'Analysis Complete', icon: 'fas fa-check-circle' },
                    'error': { name: 'Error Occurred', icon: 'fas fa-exclamation-triangle' }
                };
                
                const config = stageConfig[stage] || { name: stage, icon: 'fas fa-brain' };
                progressStage.textContent = config.name;
                console.log(`Updated stage to: ${config.name} (${percentage}%)`);
                
                if (progressIcon) {
                    progressIcon.className = `${config.icon} progress-icon`;
                    
                    // Add celebration icon effect when complete
                    if (stage === 'complete') {
                        progressIcon.style.animation = 'celebration 0.8s ease-in-out';
                    }
                    
                    console.log(`Updated icon to: ${config.icon}`);
                }
            }
        }
        
        function updateStageIndicators(stage, percentage) {
            const stages = ['stage1', 'stage2', 'stage3', 'stage4'];
            const stageMap = {
                'parsing': 0,
                'segmentation': 1,
                'analysis': 2,
                'reporting': 3,
                'complete': 4
            };
            
            const currentStageIndex = stageMap[stage] || 0;
            
            stages.forEach((stageId, index) => {
                const stageElement = document.getElementById(stageId);
                if (stageElement) {
                    stageElement.classList.remove('active', 'completed');
                    
                    // Mark stages as completed based on percentage and current stage
                    if (stage === 'complete' && percentage >= 100) {
                        // All stages completed
                        stageElement.classList.add('completed');
                    } else if (index < currentStageIndex) {
                        // Previous stages are completed
                        stageElement.classList.add('completed');
                    } else if (index === currentStageIndex) {
                        // Current stage is active
                        stageElement.classList.add('active');
                    }
                    // Future stages remain default (gray)
                }
            });
            
            // Update stage tooltips with better descriptions
            const stageDescriptions = [
                'Parsing Document Structure',
                'Segmenting into Sentences', 
                'Analyzing Content Quality',
                'Generating Final Report'
            ];
            
            stages.forEach((stageId, index) => {
                const stageElement = document.getElementById(stageId);
                if (stageElement && stageDescriptions[index]) {
                    stageElement.setAttribute('title', stageDescriptions[index]);
                }
            });
        }

        async function processSingleFile(file) {
            // Show progress even for fallback upload
            updateProgress(0, "Using standard upload method...", "parsing");
            
            const formData = new FormData();
            formData.append('file', file);

            // Simulate progress for standard upload
            updateProgress(20, "Uploading file...", "parsing");
            
            const response = await fetch('/upload', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Upload failed');

            updateProgress(80, "Processing results...", "reporting");
            
            const result = await response.json();
            
            updateProgress(100, "Analysis complete!", "complete");
            
            // Small delay to show completion
            await new Promise(resolve => setTimeout(resolve, 500));
            
            renderChart(result.report || {}, result.sentences || []);
            renderContent(result.content || '', result.sentences || []);
        }

        async function processSingleFileWithProgress(file) {
            // Initialize progress
            updateProgress(0, "Starting analysis...", "parsing");
            
            try {
                const formData = new FormData();
                formData.append('file', file);

                console.log('Attempting progressive upload...');
                
                // Start progressive analysis
                const response = await fetch('/upload_progressive', {
                    method: 'POST',
                    body: formData
                });

                console.log('Progressive upload response:', response.status);

                if (!response.ok) {
                    // Show error but don't fallback immediately - let user see what happened
                    console.error('Progressive upload failed with status:', response.status);
                    updateProgress(0, `Progressive upload failed (${response.status}). Trying fallback...`, "error");
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Show error for 2 seconds
                    return await processSingleFile(file);
                }

                const initialResult = await response.json();
                console.log('Progressive upload result:', initialResult);
                
                if (!initialResult.success) {
                    console.error('Progressive analysis failed:', initialResult.error);
                    updateProgress(0, `Analysis failed: ${initialResult.error || 'Unknown error'}. Trying fallback...`, "error");
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Show error for 2 seconds
                    return await processSingleFile(file);
                }

                const analysisId = initialResult.analysis_id;
                console.log('Starting progress monitoring for ID:', analysisId);
                
                // Poll for progress updates
                return new Promise((resolve, reject) => {
                    const pollProgress = async () => {
                        try {
                            console.log('Polling progress for:', analysisId);
                            const progressResponse = await fetch(`/analysis_progress/${analysisId}`);
                            
                            if (!progressResponse.ok) {
                                throw new Error(`Progress fetch failed: ${progressResponse.status}`);
                            }
                            
                            const progress = await progressResponse.json();
                            console.log('Progress update:', progress);
                            
                            updateProgress(
                                progress.percentage || 0, 
                                progress.message || "Processing...", 
                                progress.stage || "working"
                            );
                            
                            if (progress.completed) {
                                if (progress.error) {
                                    console.error('Analysis completed with error:', progress.error);
                                    updateProgress(0, `Error: ${progress.error}. Trying fallback...`, "error");
                                    await new Promise(resolve => setTimeout(resolve, 2000));
                                    try {
                                        const fallbackResult = await processSingleFile(file);
                                        resolve(fallbackResult);
                                    } catch (fallbackError) {
                                        reject(new Error(progress.error));
                                    }
                                } else if (progress.result) {
                                    console.log('Analysis completed successfully:', progress.result);
                                    // Analysis complete, render results
                                    renderChart(progress.result.report || {}, progress.result.sentences || []);
                                    renderContent(progress.result.content || '', progress.result.sentences || []);
                                    resolve(progress.result);
                                } else {
                                    reject(new Error('Analysis completed but no result found'));
                                }
                            } else {
                                // Continue polling
                                setTimeout(pollProgress, 200);
                            }
                        } catch (error) {
                            console.error('Progress polling failed:', error);
                            updateProgress(0, `Progress polling failed: ${error.message}. Trying fallback...`, "error");
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            try {
                                const fallbackResult = await processSingleFile(file);
                                resolve(fallbackResult);
                            } catch (fallbackError) {
                                reject(error);
                            }
                        }
                    };
                    
                    pollProgress();
                });
            } catch (error) {
                console.error('Progressive upload completely failed:', error);
                updateProgress(0, `Upload failed: ${error.message}. Trying fallback...`, "error");
                await new Promise(resolve => setTimeout(resolve, 2000));
                return await processSingleFile(file);
            }
        }

        async function processBatchFiles(files) {
            batchResults = [];
            showBatchProgress();

            // Check if there's a zip file
            const zipFile = files.find(file => file.name.toLowerCase().endsWith('.zip'));
            
            if (zipFile) {
                await processBatchZip(zipFile);
            } else {
                await processBatchIndividual(files);
            }

            showBatchResults();
            
            // Automatically display the first successful file's content
            const firstSuccessfulResult = batchResults.find(result => result.success);
            if (firstSuccessfulResult) {
                renderChart(firstSuccessfulResult.report || {}, firstSuccessfulResult.sentences || []);
                renderContent(firstSuccessfulResult.content || '', firstSuccessfulResult.sentences || []);
                
                // Add indicator showing which file is currently displayed
                const fileInfo = document.createElement('div');
                fileInfo.className = 'alert alert-info';
                fileInfo.innerHTML = `
                    <i class="fas fa-info-circle me-2"></i>
                    Currently viewing: <strong>${firstSuccessfulResult.filename}</strong> 
                    <small class="text-muted">(Click on other files in the batch results to view them)</small>
                `;
                
                const documentContent = document.getElementById('documentContent');
                const existingInfo = documentContent.querySelector('.alert.alert-info');
                if (existingInfo) existingInfo.remove();
                documentContent.insertBefore(fileInfo, documentContent.firstChild.nextSibling);
                
                // Highlight the first result as active
                setTimeout(() => {
                    const firstResultIndex = batchResults.findIndex(result => result.success);
                    if (firstResultIndex >= 0) {
                        const resultItems = document.querySelectorAll('.result-item');
                        if (resultItems[firstResultIndex]) {
                            resultItems[firstResultIndex].classList.add('active');
                        }
                    }
                }, 100);
            }
        }

        async function processBatchZip(zipFile) {
            updateProgressItem(zipFile.name, 'processing', 'Extracting zip file...');

            const formData = new FormData();
            formData.append('file', zipFile);
            formData.append('batch_mode', 'true');

            try {
                const response = await fetch('/upload_batch', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Batch upload failed');

                const result = await response.json();
                
                if (result.success && result.results) {
                    batchResults = result.results;
                    updateProgressItem(zipFile.name, 'completed', `Processed ${result.results.length} files`);
                } else {
                    throw new Error(result.error || 'Batch processing failed');
                }
            } catch (error) {
                updateProgressItem(zipFile.name, 'error', `Error: ${error.message}`);
                throw error;
            }
        }

        async function processBatchIndividual(files) {
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileProgress = Math.round((i / files.length) * 100);
                
                // Update overall progress in the loading overlay
                updateProgress(
                    fileProgress, 
                    `Processing file ${i + 1} of ${files.length}: ${file.name}`, 
                    'analysis'
                );
                
                updateProgressItem(file.name, 'processing', 'Analyzing...');

                try {
                    // Use progressive analysis for each file in batch too
                    const formData = new FormData();
                    formData.append('file', file);

                    const response = await fetch('/upload_progressive', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error(`Upload failed for ${file.name}`);

                    const initialResult = await response.json();
                    if (!initialResult.success) {
                        throw new Error(initialResult.error || 'Analysis failed');
                    }

                    const analysisId = initialResult.analysis_id;
                    
                    // Wait for this file to complete
                    const result = await new Promise((resolve, reject) => {
                        const pollProgress = async () => {
                            try {
                                const progressResponse = await fetch(`/analysis_progress/${analysisId}`);
                                const progress = await progressResponse.json();
                                
                                // Update individual file progress
                                if (progress.percentage > 0) {
                                    updateProgressItem(file.name, 'processing', `${Math.round(progress.percentage)}% - ${progress.message}`);
                                }
                                
                                if (progress.completed) {
                                    if (progress.error) {
                                        reject(new Error(progress.error));
                                    } else if (progress.result) {
                                        resolve(progress.result);
                                    } else {
                                        reject(new Error('Analysis completed but no result found'));
                                    }
                                } else {
                                    setTimeout(pollProgress, 200);
                                }
                            } catch (error) {
                                reject(error);
                            }
                        };
                        pollProgress();
                    });
                    
                    batchResults.push({
                        filename: file.name,
                        success: true,
                        content: result.content,
                        sentences: result.sentences,
                        report: result.report,
                        summary: {
                            totalSentences: result.sentences.length,
                            totalIssues: result.sentences.reduce((count, s) => count + (s.feedback ? s.feedback.length : 0), 0),
                            qualityScore: calculateQualityScore(result.sentences)
                        }
                    });

                    updateProgressItem(file.name, 'completed', 'Analysis complete');
                } catch (error) {
                    batchResults.push({
                        filename: file.name,
                        success: false,
                        error: error.message
                    });
                    updateProgressItem(file.name, 'error', `Error: ${error.message}`);
                }
            }
            
            // Update final progress
            updateProgress(100, `Completed processing ${files.length} files`, 'complete');
        }

        function calculateQualityScore(sentences) {
            if (sentences.length === 0) return 0;
            const issues = sentences.reduce((count, s) => count + (s.feedback ? s.feedback.length : 0), 0);
            return Math.max(0, Math.round((1 - issues / sentences.length) * 100));
        }

        function showBatchProgress() {
            const progressDiv = document.createElement('div');
            progressDiv.id = 'batchProgress';
            progressDiv.className = 'batch-progress';
            progressDiv.innerHTML = `
                <h6><i class="fas fa-tasks"></i> Processing Files</h6>
                <div id="progressItems"></div>
            `;
            
            // Insert after file list
            const fileList = document.getElementById('fileList');
            fileList.parentNode.insertBefore(progressDiv, fileList.nextSibling);
            progressDiv.style.display = 'block';

            // Add progress items
            const progressItems = document.getElementById('progressItems');
            selectedFiles.forEach(file => {
                const item = document.createElement('div');
                item.className = 'progress-item';
                item.id = `progress-${file.name.replace(/[^a-zA-Z0-9]/g, '_')}`;
                item.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock me-2"></i>
                        <span class="file-name">${file.name}</span>
                    </div>
                    <span class="status">Waiting...</span>
                `;
                progressItems.appendChild(item);
            });
        }

        function updateProgressItem(filename, status, message) {
            const safeId = `progress-${filename.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const item = document.getElementById(safeId);
            if (item) {
                item.className = `progress-item ${status}`;
                const icon = status === 'processing' ? 'fa-spinner fa-spin' : 
                           status === 'completed' ? 'fa-check' : 'fa-times';
                item.querySelector('i').className = `fas ${icon} me-2`;
                item.querySelector('.status').textContent = message;
            }
        }

        function showBatchResults() {
            const resultsDiv = document.createElement('div');
            resultsDiv.id = 'batchResults';
            resultsDiv.className = 'batch-results';
            
            const successCount = batchResults.filter(r => r.success).length;
            const totalIssues = batchResults.reduce((sum, r) => 
                r.success ? sum + (r.summary?.totalIssues || 0) : sum, 0);
            const avgQuality = batchResults.filter(r => r.success).reduce((sum, r) => 
                sum + (r.summary?.qualityScore || 0), 0) / successCount;

            resultsDiv.innerHTML = `
                <div class="result-summary">
                    <h6><i class="fas fa-chart-bar"></i> Batch Analysis Summary</h6>
                    <div class="row">
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-success">${successCount}</div>
                                <small>Files Processed</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-warning">${totalIssues}</div>
                                <small>Total Issues</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center">
                                <div class="h4 text-info">${Math.round(avgQuality || 0)}%</div>
                                <small>Avg Quality</small>
                            </div>
                        </div>
                    </div>
                </div>
                <h6>Individual Results</h6>
                <div id="batchResultItems"></div>
            `;

            const progressDiv = document.getElementById('batchProgress');
            progressDiv.parentNode.insertBefore(resultsDiv, progressDiv.nextSibling);
            resultsDiv.style.display = 'block';

            // Add individual result items
            const resultItems = document.getElementById('batchResultItems');
            batchResults.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.addEventListener('click', () => showBatchResult(index));
                
                if (result.success) {
                    const issues = result.summary?.totalIssues || 0;
                    const quality = result.summary?.qualityScore || 0;
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-file-alt text-success me-2"></i>
                                <div>
                                    <div class="fw-bold">${result.filename}</div>
                                    <small class="text-muted">${result.summary?.totalSentences || 0} sentences, ${issues} issues</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="badge bg-${quality >= 80 ? 'success' : quality >= 60 ? 'warning' : 'danger'}">${quality}%</div>
                            </div>
                        </div>
                    `;
                } else {
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                <div>
                                    <div class="fw-bold">${result.filename}</div>
                                    <small class="text-muted text-danger">${result.error}</small>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                resultItems.appendChild(item);
            });
        }

        function showBatchResult(index) {
            const result = batchResults[index];
            if (!result.success) {
                alert(`Error processing ${result.filename}: ${result.error}`);
                return;
            }

            // Highlight selected result
            document.querySelectorAll('.result-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.result-item')[index].classList.add('active');

            // Render the selected file's content
            renderChart(result.report || {}, result.sentences || []);
            renderContent(result.content || '', result.sentences || []);

            // Update dashboard to show current file info
            const fileInfo = document.createElement('div');
            fileInfo.className = 'alert alert-info';
            fileInfo.innerHTML = `
                <i class="fas fa-info-circle me-2"></i>
                Currently viewing: <strong>${result.filename}</strong>
            `;
            
            const documentContent = document.getElementById('documentContent');
            const existingInfo = documentContent.querySelector('.alert.alert-info');
            if (existingInfo) existingInfo.remove();
            documentContent.insertBefore(fileInfo, documentContent.firstChild.nextSibling);
        }

        // Chart rendering
        function renderChart(report, sentences) {
            console.log('🎯 CRITICAL DEBUG - renderChart called with:');
            console.log('📊 Report:', report);
            console.log('📝 Sentences:', sentences);
            console.log('📈 Sentences length:', sentences ? sentences.length : 'NULL');
            console.log('🔍 First sentence:', sentences && sentences[0] ? sentences[0] : 'NULL');
            
            if (!sentences || sentences.length === 0) {
                console.error('❌ CRITICAL: No sentences data received!');
                alert('CRITICAL ERROR: No analysis data received. Check console for details.');
                return;
            }
            
            const ctx = document.getElementById('analysisChart').getContext('2d');

    if (analysisChart) {
        analysisChart.destroy();
    }

    let totalErrors = sentences.reduce((count, sentence) => count + (sentence.feedback ? sentence.feedback.length : 0), 0);
    let totalSentences = sentences.length;
    // Calculate quality index if not provided by backend
    let qualityIndex = report.avgQualityScore !== undefined
        ? report.avgQualityScore
        : (totalSentences === 0 ? 0 : Math.max(0, Math.round(100 * (1 - (totalErrors / totalSentences)))));

    analysisChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Errors', 'Quality Index', 'Total Sentences'],
            datasets: [{
                data: [totalErrors, qualityIndex, totalSentences],
                backgroundColor: ['#ff4d4d', '#007bff', '#17a2b8']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'bottom' }
            }
        }
    });
}

        // Enhanced AI functionality
        let currentSuggestionId = null;
        let selectedWritingGoals = ['clarity', 'conciseness']; // Default goals (UI removed but backend may still use)
        let aiFeedbackData = {}; // Store AI feedback data by sentence index and feedback type
        
        // Add event delegation for AI feedback icons
        document.addEventListener('click', function(e) {
            if (e.target.closest('.ai-feedback-icon')) {
                const button = e.target.closest('.ai-feedback-icon');
                const sentenceIndex = parseInt(button.getAttribute('data-sentence-index'));
                const feedback = button.getAttribute('data-feedback');
                const sentence = button.getAttribute('data-sentence');
                const fullSuggestion = button.getAttribute('data-full-suggestion');
                
                console.log('=== AI ICON CLICKED ===');
                console.log('Button element:', button);
                console.log('Raw attributes:', {
                    sentenceIndex: sentenceIndex,
                    feedback: feedback,
                    sentence: sentence,
                    fullSuggestion: fullSuggestion
                });
                console.log('Data attributes from DOM:', {
                    'data-sentence-index': button.getAttribute('data-sentence-index'),
                    'data-feedback': button.getAttribute('data-feedback'),
                    'data-sentence': button.getAttribute('data-sentence'),
                    'data-full-suggestion': button.getAttribute('data-full-suggestion')
                });
                
                showAIFeedback(sentenceIndex, feedback, sentence, fullSuggestion);
            }
        });
        
        // Tab switching functionality
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'feedback') {
                document.getElementById('feedbackContent').classList.add('active');
            } else if (tabName === 'ai-feedback') {
                document.getElementById('aiFeedbackContent').classList.add('active');
            }
        }
        
        // Function to add AI feedback to the AI tab
        function addToAITab(sentenceIndex, feedback, sentence, aiSuggestion, feedbackKey) {
            const aiFeedbackContainer = document.getElementById('aiFeedbackContent');
            
            // Remove the placeholder if it exists
            const placeholder = aiFeedbackContainer.querySelector('.text-muted.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            // Create AI feedback item with unique identifier
            const aiDiv = document.createElement('div');
            aiDiv.className = 'ai-feedback-content';
            aiDiv.setAttribute('data-sentence-index', sentenceIndex);
            aiDiv.setAttribute('data-feedback-key', feedbackKey);
            aiDiv.setAttribute('data-feedback-type', feedback);
            
        aiDiv.innerHTML = `
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-robot me-2"></i>
                            <strong>Sentence ${sentenceIndex + 1} Analysis</strong>
                            <span class="confidence-indicator confidence-${aiSuggestion.confidence} ms-2"></span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="text-dark mb-2"><strong>📋 Issue:</strong></div>
                            <div class="bg-light border p-2 rounded">${feedback}</div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="text-dark mb-2"><strong>Original sentence:</strong></div>
                            <div class="bg-light border p-2 rounded font-italic">"${sentence}"</div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex align-items-center mb-2">
                                <strong class="text-dark">AI Suggestion:</strong>
                                <button class="btn btn-link p-0 ms-2" title="Get another AI suggestion" onclick="regenerateAISuggestion(${sentenceIndex}, '${feedback.replace(/'/g, "&#39;")}', '${sentence.replace(/'/g, "&#39;")}')">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="suggestion-text bg-primary bg-opacity-10 text-dark p-3 rounded border">
                                ${formatAISuggestion(aiSuggestion.suggestion)}
                            </div>
                        </div>
                        
                        ${aiSuggestion.sources && aiSuggestion.sources.length > 0 ? `
                        <div class="mb-3">
                            <div class="text-dark mb-2"><strong>📚 Knowledge Sources:</strong></div>
                            <div class="sources-container">
                                ${aiSuggestion.sources.map(source => `
                                    <div class="source-item bg-light border p-2 rounded mb-2">
                                        <small class="text-muted">${source.type === 'guideline' ? '📋 Writing Guidelines' : '📄 Document Context'}</small>
                                        <div class="source-content">${source.content}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    `;
            
            // Insert in order by sentence index, then by feedback type
            const existingItems = Array.from(aiFeedbackContainer.querySelectorAll('.ai-feedback-content[data-sentence-index]'));
            let inserted = false;
            
            for (let existingItem of existingItems) {
                const existingIndex = parseInt(existingItem.getAttribute('data-sentence-index'));
                
                if (sentenceIndex < existingIndex) {
                    aiFeedbackContainer.insertBefore(aiDiv, existingItem);
                    inserted = true;
                    break;
                } else if (sentenceIndex === existingIndex) {
                    // Same sentence - insert after existing items for the same sentence
                    let nextItem = existingItem.nextElementSibling;
                    while (nextItem && nextItem.classList.contains('ai-feedback-content')) {
                        const nextIndex = parseInt(nextItem.getAttribute('data-sentence-index'));
                        if (nextIndex !== sentenceIndex) {
                            break;
                        }
                        nextItem = nextItem.nextElementSibling;
                    }
                    if (nextItem) {
                        aiFeedbackContainer.insertBefore(aiDiv, nextItem);
                    } else {
                        aiFeedbackContainer.appendChild(aiDiv);
                    }
                    inserted = true;
                    break;
                }
            }
            
            if (!inserted) {
                aiFeedbackContainer.appendChild(aiDiv);
            }
            
            // Store the AI feedback data with unique key
            aiFeedbackData[feedbackKey] = {
                feedback: feedback,
                sentence: sentence,
                aiSuggestion: aiSuggestion,
                sentenceIndex: sentenceIndex
            };
        }
        
        // Function to handle AI feedback icon click
        async function showAIFeedback(sentenceIndex, feedback, sentence, fullSuggestion = '') {
            try {
                console.log('=== SHOW AI FEEDBACK DEBUG ===');
                console.log('Raw parameters:', {
                    sentenceIndex: sentenceIndex,
                    feedback: feedback,
                    sentence: sentence,
                    fullSuggestion: fullSuggestion,
                    feedbackType: typeof feedback,
                    sentenceType: typeof sentence
                });
                
                // Decode the parameters since they were encoded in the HTML
                const decodedFeedback = decodeURIComponent(feedback);
                const decodedSentence = decodeURIComponent(sentence);
                const decodedFullSuggestion = decodeURIComponent(fullSuggestion);
                
                console.log('Decoded parameters:', {
                    decodedFeedback: decodedFeedback,
                    decodedSentence: decodedSentence,
                    decodedFullSuggestion: decodedFullSuggestion
                });
                
                // Create a unique key for this specific feedback type and sentence combination
                // Use encodeURIComponent instead of btoa to handle Unicode characters safely
                const feedbackKey = `${sentenceIndex}_${encodeURIComponent(decodedFeedback).replace(/[^a-zA-Z0-9]/g, '')}`;
                console.log('Generated feedback key:', feedbackKey);
                
                // Check if we already have AI feedback for this specific sentence and feedback type
                if (aiFeedbackData[feedbackKey]) {
                    console.log('Found existing AI feedback, switching to tab');
                    // Switch to AI tab and highlight the existing feedback
                    switchTabProgrammatically('ai-feedback');
                    highlightAIFeedback(sentenceIndex, decodedFeedback);
                    return;
                }
                
                // Always get a fresh AI suggestion when the AI icon is clicked
                // Show loading state
                console.log('Getting fresh AI suggestion...');
                const loadingToast = showLoadingToast('Getting AI suggestions...');
                
                // Get AI suggestion
                console.log('About to call getAISuggestion with:', {
                    feedback: decodedFeedback,
                    sentence: decodedSentence
                });
                
                const aiSuggestion = await getAISuggestion(decodedFeedback, decodedSentence);
                console.log('getAISuggestion returned:', aiSuggestion);
                
                // Hide loading
                hideLoadingToast(loadingToast);
                
                if (aiSuggestion && typeof aiSuggestion === 'object' && aiSuggestion.suggestion && aiSuggestion.suggestion.trim()) {
                    console.log('✅ AI suggestion success, adding to tab');
                    console.log('AI suggestion object:', aiSuggestion);
                    // Add to AI tab
                    addToAITab(sentenceIndex, decodedFeedback, decodedSentence, aiSuggestion, feedbackKey);
                    
                    // Switch to AI tab
                    switchTabProgrammatically('ai-feedback');
                    
                    // Highlight the new feedback
                    highlightAIFeedback(sentenceIndex, decodedFeedback);
                } else {
                    console.error('❌ AI suggestion failed - invalid response:', {
                        aiSuggestion: aiSuggestion,
                        type: typeof aiSuggestion,
                        isObject: aiSuggestion && typeof aiSuggestion === 'object',
                        hasProperty: aiSuggestion && aiSuggestion.hasOwnProperty('suggestion'),
                        suggestionValue: aiSuggestion ? aiSuggestion.suggestion : 'N/A',
                        suggestionType: aiSuggestion && aiSuggestion.suggestion ? typeof aiSuggestion.suggestion : 'N/A',
                        suggestionTrimmed: aiSuggestion && aiSuggestion.suggestion ? aiSuggestion.suggestion.trim() : 'N/A',
                        suggestionLength: aiSuggestion && aiSuggestion.suggestion ? aiSuggestion.suggestion.length : 0,
                        suggestionTrimmedLength: aiSuggestion && aiSuggestion.suggestion ? aiSuggestion.suggestion.trim().length : 0,
                        feedback: decodedFeedback,
                        sentence: decodedSentence,
                        feedbackKey: feedbackKey
                    });
                    showErrorToast('AI suggestion not available. Check console for details - invalid response structure.');
                }
                
            } catch (error) {
                console.error('❌ Error in showAIFeedback:', error);
                console.error('Error stack:', error.stack);
                showErrorToast('Error getting AI suggestion: ' + error.message);
            }
        }
        
        // Function to switch tab programmatically
        function switchTabProgrammatically(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'feedback') {
                document.querySelector('.tab-button:first-child').classList.add('active');
                document.getElementById('feedbackContent').classList.add('active');
            } else if (tabName === 'ai-feedback') {
                document.querySelector('.tab-button:last-child').classList.add('active');
                document.getElementById('aiFeedbackContent').classList.add('active');
            }
        }
        
        // Function to highlight AI feedback item
        function highlightAIFeedback(sentenceIndex, feedbackType = null) {
            // Remove existing highlights
            document.querySelectorAll('.ai-feedback-content').forEach(item => {
                item.style.transform = '';
                item.style.boxShadow = '';
            });
            
            // Find the target item - if feedbackType is provided, find the specific feedback
            let targetItem;
            if (feedbackType) {
                const items = document.querySelectorAll(`#aiFeedbackContent [data-sentence-index="${sentenceIndex}"]`);
                for (let item of items) {
                    if (item.getAttribute('data-feedback-type') === feedbackType) {
                        targetItem = item;
                        break;
                    }
                }
            } else {
                // If no specific feedback type, just get the first item for this sentence
                targetItem = document.querySelector(`#aiFeedbackContent [data-sentence-index="${sentenceIndex}"]`);
            }
            
            if (targetItem) {
                targetItem.style.transform = 'scale(1.02)';
                targetItem.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.4)';
                targetItem.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                
                // Remove highlight after a few seconds
                setTimeout(() => {
                    targetItem.style.transform = '';
                    targetItem.style.boxShadow = '';
                }, 3000);
            }
        }
        // Function to regenerate AI suggestion when the icon is clicked
async function regenerateAISuggestion(sentenceIndex, feedback, sentence) {
    try {
        // Decode parameters if needed
        const decodedFeedback = decodeURIComponent(feedback);
        const decodedSentence = decodeURIComponent(sentence);
        // Show loading toast
        const loadingToast = showLoadingToast('Getting another AI suggestion...');
        // Get new AI suggestion
        const aiSuggestion = await getAISuggestion(decodedFeedback, decodedSentence);
        hideLoadingToast(loadingToast);
        if (aiSuggestion && typeof aiSuggestion === 'object' && aiSuggestion.suggestion && aiSuggestion.suggestion.trim()) {
            // Create a unique key for this feedback
            const feedbackKey = `${sentenceIndex}_${encodeURIComponent(decodedFeedback).replace(/[^a-zA-Z0-9]/g, '')}`;
            // Add to AI tab (replace previous suggestion for this feedback)
            addToAITab(sentenceIndex, decodedFeedback, decodedSentence, aiSuggestion, feedbackKey);
            switchTabProgrammatically('ai-feedback');
            highlightAIFeedback(sentenceIndex, decodedFeedback);
        } else {
            showErrorToast('AI suggestion not available.');
        }
    } catch (error) {
        showErrorToast('Error getting another AI suggestion: ' + error.message);
    }
}

// Toast notification functions
function showLoadingToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast-notification loading';
    toast.innerHTML = `
                <i class="fas fa-spinner fa-spin me-2"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            
            // Add styles if not already present
            if (!document.querySelector('#toast-styles')) {
                const style = document.createElement('style');
                style.id = 'toast-styles';
                style.textContent = `
                    .toast-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: rgba(0, 0, 0, 0.9);
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        z-index: 10000;
                        animation: slideIn 0.3s ease;
                    }
                    .toast-notification.loading {
                        background: #6c757d;
                    }
                    .toast-notification.error {
                        background: #e74c3c;
                    }
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            return toast;
        }
        
        function hideLoadingToast(toast) {
            if (toast && toast.parentNode) {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }
        }
        
        function showErrorToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification error';
            toast.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${message}
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                hideLoadingToast(toast);
            }, 3000);
        }
        
        // Writing Goals Analytics (simplified - goals now hardcoded)
        function updateWritingGoalsAnalytics() {
            console.log('Selected writing goals:', selectedWritingGoals);
            
            // Update dashboard insights based on selected goals
            updateSmartInsights();
        }

        function updateDocumentMetrics(content, sentences) {
            // Update word and sentence counts
            const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;
            const sentenceCount = sentences.length;
            
            document.getElementById('wordCount').textContent = wordCount;
            document.getElementById('sentenceCount').textContent = sentenceCount;
            
            // Calculate and update quality score
            const issues = sentences.reduce((count, s) => count + (s.feedback ? s.feedback.length : 0), 0);
            const qualityScore = sentenceCount > 0 ? Math.max(0, Math.round((1 - issues / sentenceCount) * 100)) : 0;
            
            document.getElementById('qualityScore').textContent = `${qualityScore}%`;
            document.getElementById('qualityProgressBar').style.width = `${qualityScore}%`;
            
            // Update quality description
            let description = '';
            if (qualityScore >= 90) description = 'Excellent writing quality';
            else if (qualityScore >= 75) description = 'Good writing quality';
            else if (qualityScore >= 60) description = 'Fair writing quality - room for improvement';
            else description = 'Needs improvement';
            
            document.getElementById('qualityDescription').textContent = description;
            
            // Update issues progress
            document.getElementById('issuesStats').textContent = issues;
            document.getElementById('issuesProgressBar').style.width = issues === 0 ? '100%' : `${Math.max(10, 100 - (issues * 10))}%`;
            document.getElementById('issuesDescription').textContent = 
                issues === 0 ? 'No issues detected' : `${issues} issue${issues > 1 ? 's' : ''} found`;
        }

        function updateSmartInsights() {
            const insights = [];
            const container = document.getElementById('smartInsightsList');
            
            // Generate insights based on selected goals and document state
            if (selectedWritingGoals.includes('clarity')) {
                insights.push({
                    icon: 'fas fa-eye',
                    text: 'Focus on clear, simple language',
                    priority: 'high'
                });
            }
            
            if (selectedWritingGoals.includes('conciseness')) {
                insights.push({
                    icon: 'fas fa-compress-alt',
                    text: 'Look for opportunities to reduce word count',
                    priority: 'medium'
                });
            }
            
            if (selectedWritingGoals.includes('engagement')) {
                insights.push({
                    icon: 'fas fa-heart',
                    text: 'Consider adding more engaging examples',
                    priority: 'medium'
                });
            }
            
            // Clear and populate insights
            container.innerHTML = '';
            insights.forEach(insight => {
                const div = document.createElement('div');
                div.className = `insight-item ${insight.priority === 'high' ? 'active' : ''}`;
                div.innerHTML = `<i class="${insight.icon}"></i> ${insight.text}`;
                container.appendChild(div);
            });
            
            if (insights.length === 0) {
                container.innerHTML = '<div class="insight-item text-muted"><i class="fas fa-info-circle"></i> Select writing goals to see personalized insights</div>';
            }
        }

        // Function to update smart insights based on document analysis
        function updateSmartInsightsFromDocument(sentences) {
            const insights = [];
            const container = document.getElementById('smartInsightsList');
            
            // Analyze document patterns
            const totalIssues = sentences.reduce((count, s) => count + (s.feedback ? s.feedback.length : 0), 0);
            const longSentences = sentences.filter(s => s.feedback && s.feedback.some(f => f.message && typeof f.message === 'string' && f.message.includes('Long sentence'))).length;
            const grammarIssues = sentences.filter(s => s.feedback && s.feedback.some(f => f.message && typeof f.message === 'string' && (f.message.includes('grammar') || f.message.includes('verb')))).length;
            const repeatedWords = sentences.filter(s => s.feedback && s.feedback.some(f => f.message && typeof f.message === 'string' && f.message.includes('repeated'))).length;
            
            // Calculate quality score to determine overall message
            const sentenceCount = sentences.length;
            const qualityScore = sentenceCount > 0 ? Math.max(0, Math.round((1 - totalIssues / sentenceCount) * 100)) : 0;
            
            // Generate targeted insights
            if (longSentences > 0 && selectedWritingGoals.includes('conciseness')) {
                insights.push({
                    icon: 'fas fa-scissors',
                    text: `Break down ${longSentences} long sentence${longSentences > 1 ? 's' : ''} for better readability`,
                    priority: 'high'
                });
            }
            
            if (grammarIssues > 0 && selectedWritingGoals.includes('professionalism')) {
                insights.push({
                    icon: 'fas fa-check-circle',
                    text: `Fix ${grammarIssues} grammar issue${grammarIssues > 1 ? 's' : ''} to improve professionalism`,
                    priority: 'high'
                });
            }
            
            if (repeatedWords > 0 && selectedWritingGoals.includes('clarity')) {
                insights.push({
                    icon: 'fas fa-sync-alt',
                    text: `Reduce word repetition in ${repeatedWords} sentence${repeatedWords > 1 ? 's' : ''}`,
                    priority: 'medium'
                });
            }
            
            if (selectedWritingGoals.includes('engagement') && totalIssues < 3) {
                insights.push({
                    icon: 'fas fa-heart',
                    text: 'Consider adding more vivid examples or storytelling elements',
                    priority: 'low'
                });
            }
            
            if (selectedWritingGoals.includes('accessibility') && longSentences > 2) {
                insights.push({
                    icon: 'fas fa-universal-access',
                    text: 'Simplify complex sentences for better accessibility',
                    priority: 'medium'
                });
            }
            
            // Clear and populate insights
            container.innerHTML = '';
            insights.sort((a, b) => {
                const priorityOrder = { high: 3, medium: 2, low: 1 };
                return priorityOrder[b.priority] - priorityOrder[a.priority];
            });
            
            insights.forEach(insight => {
                const div = document.createElement('div');
                div.className = `insight-item ${insight.priority === 'high' ? 'active' : ''}`;
                div.innerHTML = `<i class="${insight.icon}"></i> ${insight.text}`;
                container.appendChild(div);
            });
            
            // Show overall quality message when no specific insights are generated
            if (insights.length === 0) {
                if (qualityScore < 90) {
                    container.innerHTML = '<div class="insight-item text-warning"><i class="fas fa-chart-line"></i> To improve the writing standards, consider reviewing for clarity, conciseness, and grammatical accuracy</div>';
                } else {
                    container.innerHTML = '<div class="insight-item text-muted"><i class="fas fa-star"></i> Excellent! Your document aligns well with your writing goals</div>';
                }
            }
        }

        function showSuccessToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification success';
            toast.innerHTML = `<i class="fas fa-check me-2"></i>${message}`;
            document.body.appendChild(toast);
            
            // Add success style if not present
            if (!document.querySelector('#success-toast-style')) {
                const style = document.createElement('style');
                style.id = 'success-toast-style';
                style.textContent = `.toast-notification.success { background: #27ae60; }`;
                document.head.appendChild(style);
            }
            
            setTimeout(() => hideLoadingToast(toast), 3000);
        }

        // Sentence highlighting and navigation functions
        function highlightSentence(sentenceIndex) {
            // Remove any existing highlights
            unhighlightAllSentences();
            
            // Highlight the target sentence in the content
            const contentSentence = document.getElementById(`content-sentence-${sentenceIndex}`);
            if (contentSentence) {
                contentSentence.classList.add('highlight');
                
                // Auto-scroll to center the sentence in the Document Content section
                const documentSection = document.querySelector('.document-section');
                if (documentSection) {
                    const sentenceRect = contentSentence.getBoundingClientRect();
                    const sectionRect = documentSection.getBoundingClientRect();
                    
                    // Calculate vertical scroll position to center the sentence
                    const sectionCenterY = sectionRect.height / 2;
                    const sentenceRelativeTop = sentenceRect.top - sectionRect.top;
                    const verticalScrollTarget = documentSection.scrollTop + sentenceRelativeTop - sectionCenterY;
                    
                    // Calculate horizontal scroll position to center the sentence
                    const sectionCenterX = sectionRect.width / 2;
                    const sentenceRelativeLeft = sentenceRect.left - sectionRect.left;
                    const horizontalScrollTarget = documentSection.scrollLeft + sentenceRelativeLeft + (sentenceRect.width / 2) - sectionCenterX;
                    
                    // Check if sentence is outside visible area horizontally
                    const isHorizontallyVisible = sentenceRect.left >= sectionRect.left && 
                                                 sentenceRect.right <= sectionRect.right;
                    
                    // Check if sentence is outside visible area vertically
                    const isVerticallyVisible = sentenceRect.top >= sectionRect.top && 
                                               sentenceRect.bottom <= sectionRect.bottom;
                    
                    // Smooth scroll to the target position (both horizontal and vertical)
                    documentSection.scrollTo({
                        top: !isVerticallyVisible ? verticalScrollTarget : documentSection.scrollTop,
                        left: !isHorizontallyVisible ? Math.max(0, horizontalScrollTarget) : documentSection.scrollLeft,
                        behavior: 'smooth'
                    });
                }
            }
            
            // Also highlight in interactive section if it exists
            const interactiveSentence = document.getElementById(`sentence-${sentenceIndex}`);
            if (interactiveSentence) {
                interactiveSentence.classList.add('highlight');
            }
        }
        
        function unhighlightAllSentences() {
            // Remove highlights from content sentences
            document.querySelectorAll('.sentence-highlight.highlight').forEach(sentence => {
                sentence.classList.remove('highlight');
            });
            
            // Remove highlights from interactive sentences
            document.querySelectorAll('.sentence.highlight').forEach(sentence => {
                sentence.classList.remove('highlight');
            });
        }
        
        function highlightFeedbackForSentence(sentenceIndex) {
            // Remove any existing feedback highlights
            document.querySelectorAll('.feedback-item.highlighted').forEach(item => {
                item.classList.remove('highlighted');
            });
            
            // Highlight corresponding feedback items
            document.querySelectorAll(`.feedback-item[data-sentence-index="${sentenceIndex}"]`).forEach(item => {
                item.classList.add('highlighted');
            });
        }
        
        function scrollToSentence(sentenceIndex) {
            // Try content sentence first, then interactive sentence
            let sentenceElement = document.getElementById(`content-sentence-${sentenceIndex}`);
            if (!sentenceElement) {
                sentenceElement = document.getElementById(`sentence-${sentenceIndex}`);
            }
            
            if (sentenceElement) {
                // Use scrollIntoView with both vertical and horizontal centering
                sentenceElement.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center',
                    inline: 'center'  // This handles horizontal scrolling
                });
                
                // Temporarily highlight the sentence
                highlightSentence(sentenceIndex);
                setTimeout(() => {
                    unhighlightAllSentences();
                }, 2000);
            }
        }

        // Add click handlers to content sentences after they're created
        function addContentSentenceHandlers() {
            document.querySelectorAll('.sentence-highlight').forEach((sentence, index) => {
                sentence.addEventListener('click', () => {
                    const sentenceIndex = parseInt(sentence.getAttribute('data-sentence-index'));
                    highlightFeedbackForSentence(sentenceIndex);
                });
            });
        }

        // Helper function to escape HTML special characters
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Function to add sentence highlighting to HTML content
        function addSentenceHighlighting(htmlContent, sentences) {
            let processedContent = htmlContent;
            
            console.log('🎯 Processing sentences for highlighting:', sentences.length);
            
            sentences.forEach((sentenceData, index) => {
                const htmlSegment = sentenceData.html_segment;
                const plainSentence = sentenceData.sentence.trim();
                
                if (!plainSentence) return;
                
                const hasFeedback = sentenceData.feedback && sentenceData.feedback.length > 0;
                const feedbackClass = hasFeedback ? ' has-feedback' : '';
                
                let found = false;
                
                // NEW APPROACH: Smart text-based highlighting that preserves formatting
                // This handles cases where formatting elements are inline with sentence text
                
                // Try to find and highlight the sentence text while preserving formatting
                found = highlightSentenceInFormattedContent(processedContent, plainSentence, index, feedbackClass);
                if (found) {
                    processedContent = found;
                    console.log(`✅ Smart highlight for sentence ${index}`);
                } else {
                    // Fallback: Method 1 - Use HTML segment if available
                    if (htmlSegment && htmlSegment !== 'None' && processedContent.includes(htmlSegment)) {
                        if (!processedContent.includes(`data-sentence-index="${index}"`)) {
                            const replacement = `<span class="sentence-highlight${feedbackClass}" id="content-sentence-${index}" data-sentence-index="${index}">${htmlSegment}</span>`;
                            processedContent = processedContent.replace(htmlSegment, replacement);
                            found = true;
                            console.log(`✅ HTML segment match for sentence ${index}`);
                        }
                    }
                    
                    // Fallback: Method 2 - Direct text matching 
                    if (!found && processedContent.includes(plainSentence)) {
                        if (!processedContent.includes(`data-sentence-index="${index}"`)) {
                            const replacement = `<span class="sentence-highlight${feedbackClass}" id="content-sentence-${index}" data-sentence-index="${index}">${plainSentence}</span>`;
                            processedContent = processedContent.replace(plainSentence, replacement);
                            found = true;
                            console.log(`✅ Plain text match for sentence ${index}`);
                        }
                    }
                    
                    if (!found) {
                        console.warn(`❌ Could not highlight sentence ${index}: "${plainSentence.substring(0, 50)}..."`);
                    }
                }
            });
            
            console.log('🎯 Highlighting complete');
            return processedContent;
        }

        // NEW: Smart highlighting function that preserves formatting within sentences
        function highlightSentenceInFormattedContent(htmlContent, plainSentence, index, feedbackClass) {
            // Create a temporary DOM element to work with the HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // Function to get all text nodes and their positions
            function getTextContent(element) {
                let fullText = '';
                const textNodes = [];
                
                function walk(node) {
                    if (node.nodeType === Node.TEXT_NODE) {
                        const text = node.textContent;
                        textNodes.push({
                            node: node,
                            start: fullText.length,
                            end: fullText.length + text.length,
                            text: text
                        });
                        fullText += text;
                    } else {
                        for (let child of node.childNodes) {
                            walk(child);
                        }
                    }
                }
                
                walk(element);
                return { fullText, textNodes };
            }
            
            try {
                const { fullText, textNodes } = getTextContent(tempDiv);
                
                // Clean up whitespace in both texts for comparison
                const cleanFullText = fullText.replace(/\s+/g, ' ').trim();
                const cleanSentence = plainSentence.replace(/\s+/g, ' ').trim();
                
                // Find the sentence in the full text
                const sentenceStart = cleanFullText.indexOf(cleanSentence);
                
                if (sentenceStart === -1) {
                    return false; // Sentence not found
                }
                
                const sentenceEnd = sentenceStart + cleanSentence.length;
                
                // Find which text nodes contain our sentence
                const affectedNodes = textNodes.filter(nodeInfo => 
                    (nodeInfo.start < sentenceEnd && nodeInfo.end > sentenceStart)
                );
                
                if (affectedNodes.length === 0) {
                    return false;
                }
                
                // For simple cases (sentence contained in single text node), wrap it
                if (affectedNodes.length === 1) {
                    const nodeInfo = affectedNodes[0];
                    const relativeStart = sentenceStart - nodeInfo.start;
                    const relativeEnd = sentenceEnd - nodeInfo.start;
                    
                    if (relativeStart >= 0 && relativeEnd <= nodeInfo.text.length) {
                        const before = nodeInfo.text.substring(0, relativeStart);
                        const sentenceText = nodeInfo.text.substring(relativeStart, relativeEnd);
                        const after = nodeInfo.text.substring(relativeEnd);
                        
                        // Create the highlight span
                        const highlightSpan = document.createElement('span');
                        highlightSpan.className = `sentence-highlight${feedbackClass}`;
                        highlightSpan.id = `content-sentence-${index}`;
                        highlightSpan.setAttribute('data-sentence-index', index);
                        highlightSpan.textContent = sentenceText;
                        
                        // Replace the text node with our new structure
                        const parent = nodeInfo.node.parentNode;
                        
                        if (before) {
                            parent.insertBefore(document.createTextNode(before), nodeInfo.node);
                        }
                        parent.insertBefore(highlightSpan, nodeInfo.node);
                        if (after) {
                            parent.insertBefore(document.createTextNode(after), nodeInfo.node);
                        }
                        parent.removeChild(nodeInfo.node);
                        
                        return tempDiv.innerHTML;
                    }
                }
                
                // For complex cases (sentence spans multiple nodes), fall back to simple approach
                return false;
                
            } catch (error) {
                console.warn('Error in smart highlighting:', error);
                return false;
            }
        }

        // Format AI suggestion (structured output)
        function formatAISuggestion(suggestionText) {
            // Try to parse and format structured AI output
            if (!suggestionText) return '';
            // Split by newlines and look for KEY: value pairs
            const lines = suggestionText.split(/\n|<br\s*\/?>(?=\w+:)/g);
            let html = '';
            lines.forEach(line => {
                const match = line.match(/^([A-Z][A-Z_ \-]+):\s*(.*)$/i);
                if (match) {
                    const key = match[1].replace(/_/g, ' ').replace(/\b([a-z])/g, c => c.toUpperCase());
                    const value = match[2];
                    html += `<div style="margin-bottom:4px;"><strong>${key}:</strong> <span style="color:#333;background:rgba(255,255,255,0.7);padding:2px 4px;border-radius:3px;">${value}</span></div>`;
                } else if (line.trim()) {
                    html += `<div style="margin-bottom:4px;">${line}</div>`;
                }
            });
            return html || suggestionText;
        }

        // Enhanced feedback rendering with AI suggestions and hover highlighting
        function renderFeedbackWithAI(feedback, sentence, sentenceIndex) {
            const feedbackContainer = document.getElementById('feedbackContent');
            
            console.log('renderFeedbackWithAI called with:', feedback, sentence, sentenceIndex);
            
            for (const item of feedback) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback-item p-3 mb-2 border-start';
                feedbackDiv.setAttribute('data-sentence-index', sentenceIndex);
                feedbackDiv.setAttribute('data-order', sentenceIndex); // For sorting
                
                // Add hover functionality to highlight corresponding sentence
                feedbackDiv.addEventListener('mouseenter', () => {
                    highlightSentence(sentenceIndex);
                });
                
                feedbackDiv.addEventListener('mouseleave', () => {
                    unhighlightAllSentences();
                });
                
                // Add click functionality to scroll to sentence
                feedbackDiv.addEventListener('click', (e) => {
                    // Don't trigger if clicking on AI icon
                    if (!e.target.closest('.ai-feedback-icon')) {
                        scrollToSentence(sentenceIndex);
                    }
                });
                
                console.log('Processing feedback item:', item);
                
                feedbackDiv.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="mb-2">
                                <small class="text-muted">Sentence ${sentenceIndex + 1}</small>
                                <i class="fas fa-link ms-2" style="cursor: pointer;" title="Click to view sentence"></i>
                            </div>
                            <strong>Issue:</strong> ${item.message}
                        </div>
                        <button class="ai-feedback-icon" 
                                data-sentence-index="${sentenceIndex}" 
                                data-feedback="${encodeURIComponent(item.message)}" 
                                data-sentence="${encodeURIComponent(sentence)}"
                                data-full-suggestion="${encodeURIComponent(item.full_suggestion || '')}" 
                                title="Get AI suggestions">
                            <i class="fas fa-robot"></i>
                        </button>
                    </div>
                `;
                
                // Insert in the correct order
                const existingItems = Array.from(feedbackContainer.querySelectorAll('.feedback-item[data-order]'));
                let inserted = false;
                
                for (let existingItem of existingItems) {
                    const existingOrder = parseInt(existingItem.getAttribute('data-order'));
                    if (sentenceIndex < existingOrder) {
                        feedbackContainer.insertBefore(feedbackDiv, existingItem);
                        inserted = true;
                        break;
                    }
                }
                
                if (!inserted) {
                    feedbackContainer.appendChild(feedbackDiv);
                }
            }
        }

        async function getAISuggestion(feedback, sentence) {
            try {
                // Safe document type retrieval - fallback to 'technical' if element doesn't exist
                let documentType = 'technical';
                const documentTypeElement = document.getElementById('documentType');
                if (documentTypeElement && documentTypeElement.value) {
                    documentType = documentTypeElement.value;
                }
                
                console.log('=== AI SUGGESTION DEBUG ===');
                console.log('Document type used:', documentType);
                console.log('Raw inputs:', {
                    feedback: feedback,
                    sentence: sentence,
                    feedbackType: typeof feedback,
                    sentenceType: typeof sentence,
                    feedbackLength: feedback?.length,
                    sentenceLength: sentence?.length
                });
                
                // Clean and validate required parameters
                const cleanFeedback = feedback ? feedback.trim() : '';
                const cleanSentence = sentence ? sentence.trim() : '';
                
                console.log('Cleaned inputs:', {
                    cleanFeedback: cleanFeedback,
                    cleanSentence: cleanSentence,
                    cleanFeedbackLength: cleanFeedback.length,
                    cleanSentenceLength: cleanSentence.length
                });
                
                if (!cleanFeedback) {
                    console.error('❌ VALIDATION FAILED - Missing required feedback parameter:', { 
                        feedback: cleanFeedback, 
                        sentence: cleanSentence,
                        feedbackEmpty: !cleanFeedback,
                        sentenceEmpty: !cleanSentence
                    });
                    return null;
                }
                
                // Sentence is optional - AI can provide suggestions even without specific sentence context
                if (!cleanSentence) {
                    console.log('ℹ️ No sentence context provided - AI will use general examples');
                }
                
                // Extract just the core issue description from feedback if it contains structured data
                let coreIssue = cleanFeedback;
                if (cleanFeedback.includes('Issue:')) {
                    const issueMatch = cleanFeedback.match(/Issue:\s*([^\n]+)/);
                    if (issueMatch) {
                        coreIssue = issueMatch[1].trim();
                        console.log('Extracted core issue:', coreIssue);
                    }
                }
                
                const requestData = {
                    feedback: coreIssue,
                    sentence: cleanSentence,
                    document_type: documentType,
                    writing_goals: selectedWritingGoals || ['clarity', 'conciseness']
                };
                
                console.log('Request payload:', requestData);
                
                const response = await fetch('/ai_suggestion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ AI suggestion HTTP success - analyzing response...');
                    console.log('Response type:', typeof result);
                    console.log('Response keys:', Object.keys(result || {}));
                    console.log('Full response object:', result);
                    console.log('Suggestion property exists:', 'suggestion' in result);
                    console.log('Suggestion property value:', result.suggestion);
                    console.log('Suggestion property type:', typeof result.suggestion);
                    console.log('Suggestion property length:', result.suggestion?.length);
                    console.log('Suggestion is truthy:', !!result.suggestion);
                    
                    // Extra validation to ensure we have a valid result
                    if (result && typeof result === 'object' && result.suggestion) {
                        console.log('✅ Valid AI suggestion object confirmed - validation passed');
                        return result;
                    } else {
                        console.error('❌ Invalid AI suggestion response structure - validation failed:');
                        console.error('  - result exists:', !!result);
                        console.error('  - result is object:', typeof result === 'object');
                        console.error('  - suggestion exists:', !!result.suggestion);
                        console.error('  - suggestion value:', result.suggestion);
                        return null;
                    }
                } else {
                    console.error('❌ AI suggestion HTTP error:', response.status);
                    const errorText = await response.text();
                    console.error('Error response body:', errorText);
                    return null;
                }
            } catch (error) {
                console.error('❌ AI suggestion exception:', error);
                console.error('Error stack:', error.stack);
                return null;
            }
        }

        function updateAIPerformance(suggestion) {
            const confidenceMap = {
                'high': '★★★',
                'medium': '★★☆',
                'low': '★☆☆'
            };
            
            document.getElementById('qualityScore').textContent = confidenceMap[suggestion.confidence] || '-';
            document.getElementById('aiMethod').textContent = suggestion.method || '-';
            
            // Show performance indicator
            const indicator = document.createElement('div');
            indicator.className = 'performance-indicator';
            indicator.textContent = `AI Response: ${suggestion.confidence} confidence`;
            document.body.appendChild(indicator);
            
            setTimeout(() => {
                indicator.remove();
            }, 3000);
        }

        // Enhanced content rendering with sentence highlighting
        function renderContent(content, sentences) {
            console.log('🔍 renderContent called with:', {
                content: content ? content.substring(0, 100) + '...' : 'NULL',
                sentencesLength: sentences ? sentences.length : 'NULL',
                sentencesType: typeof sentences
            });
            
            const documentContent = document.getElementById('documentContent');
            const feedbackContent = document.getElementById('feedbackContent');
            const aiFeedbackContent = document.getElementById('aiFeedbackContent');
            
            console.log('🔍 DOM elements found:', {
                documentContent: !!documentContent,
                feedbackContent: !!feedbackContent,
                aiFeedbackContent: !!aiFeedbackContent
            });
            
            // Update dashboard metrics
            updateDocumentMetrics(content, sentences);
            
            // Clear previous content
            documentContent.innerHTML = '<h4>Document Content</h4>';
            feedbackContent.innerHTML = '<h5 class="mb-3">Document Issues</h5>';
            
            // Reset AI feedback tab
            aiFeedbackContent.innerHTML = `
                <h5 class="mb-3">AI-Powered Suggestions</h5>
                <div class="text-muted text-center py-4">
                    <i class="fas fa-robot fa-2x mb-2"></i>
                    <p>Click the AI icon next to any issue to get intelligent suggestions</p>
                </div>
            `;
            
            // Clear AI feedback data
            aiFeedbackData = {};
            
            console.log('🔍 Processing sentences:', sentences ? sentences.length : 'NULL');
            console.log('🔍 Sentences data:', sentences);
            
            // Create enhanced HTML content with highlighted sentences
            const originalContentDiv = document.createElement('div');
            originalContentDiv.className = 'original-content mt-3';
            
            // Process the HTML content to add sentence highlighting
            const enhancedContent = addSentenceHighlighting(content, sentences);
            originalContentDiv.innerHTML = enhancedContent;
            
            // Store sentences for reference
            window.currentSentences = sentences;
            
            // Add the enhanced content to document
            documentContent.appendChild(originalContentDiv);
            
            // Add click handlers to the newly created sentence spans
            setTimeout(() => {
                addContentSentenceHandlers();
            }, 100);
            
            // Process sentences with feedback - immediate rendering
            let feedbackCount = 0;
            
            sentences.forEach((sentenceData, index) => {
                console.log(`Sentence ${index}:`, sentenceData);
                if (sentenceData.feedback && sentenceData.feedback.length > 0) {
                    feedbackCount++;
                    console.log(`Rendering feedback for sentence ${index}:`, sentenceData.feedback);
                    // Render feedback immediately
                    renderFeedbackWithAI(sentenceData.feedback, sentenceData.sentence, index);
                }
            });
            
            // If no feedback found, show a message
            if (feedbackCount === 0) {
                const noIssuesDiv = document.createElement('div');
                noIssuesDiv.className = 'alert alert-success mt-3';
                noIssuesDiv.innerHTML = `
                    <div class="d-flex align-items-center">
                        <i class="fas fa-check-circle me-2"></i>
                        <div>
                            <strong>Great work!</strong> No issues detected in your document.
                            <br><small>The AI analysis found your writing to be clear and well-structured.</small>
                        </div>
                    </div>
                `;
                feedbackContent.appendChild(noIssuesDiv);
                
                // Show document quality summary
                const qualitySummary = document.createElement('div');
                qualitySummary.className = 'card mt-3';
                qualitySummary.style.background = 'rgba(255, 255, 255, 0.1)';
                qualitySummary.innerHTML = `
                    <div class="card-header">
                        <h6><i class="fas fa-chart-line"></i> Document Quality Summary</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <small>Total Sentences:</small>
                                <div class="h5">${sentences.length}</div>
                            </div>
                            <div class="col-6">
                                <small>Quality Score:</small>
                                <div class="h5">✅ Excellent</div>
                            </div>
                        </div>
                    </div>
                `;
                feedbackContent.appendChild(qualitySummary);
            }
            
            // Update smart insights based on document analysis
            updateSmartInsightsFromDocument(sentences);
        }
        // Clean feedback text
        function cleanFeedback(feedback) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = feedback;
            let cleanText = tempDiv.textContent || tempDiv.innerText || '';

           
            const fileExtensions = ['csv', 'pdf', 'docx', 'txt', 'md', 'adoc', 'png', 'jpg', 'jpeg', 'gif'];
            const regex = new RegExp(`[^.!?]*(?<!\\b(?:${fileExtensions.join('|')})\\b)[.!?]`, 'g');
            const match = cleanText.match(regex);
            if (match) {
                cleanText = match[0];
            }

            return cleanText;
        }

        // Dark mode toggle
        document.getElementById('darkModeToggle').addEventListener('change', (e) => {
            document.body.classList.toggle('dark-mode', e.target.checked);
        });

        // AI Suggestion Modal logic
        document.body.addEventListener('click', async function(e) {
            // Removed deprecated ai-suggest-btn handler - now using ai-feedback-icon
            if (e.target.id === 'closeSuggestionModal') {
                document.getElementById('suggestionModal').style.display = 'none';
            }
        });

        // Export functionality
        document.getElementById('exportBtn').addEventListener('click', () => {
    // Gather feedback data
    let csvContent = "Sentence,Feedback\n";
    document.querySelectorAll('.sentence').forEach((sentenceSpan) => {
        const idx = sentenceSpan.dataset.index;
        // Find all feedback for this sentence
        const feedbacks = [];
        document.querySelectorAll(`.feedback-item[data-index="${idx}"]`).forEach(fb => {
            feedbacks.push(fb.innerText.replace(/"/g, '""'));
        });
        if (feedbacks.length) {
            csvContent += `"${sentenceSpan.innerText.replace(/"/g, '""')}","${feedbacks.join('; ')}"\n`;
        }
    });

    // Download as CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'feedback_export.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

        // History functionality
        document.getElementById('historyBtn').addEventListener('click', () => {
            showHistoryModal();
        });

        // Settings functionality
        document.getElementById('settingsBtn').addEventListener('click', () => {
            showSettingsModal();
        });

        // Initialize modal event handlers when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            initializeModalHandlers();
        });

        // If DOM is already loaded, initialize immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeModalHandlers);
        } else {
            initializeModalHandlers();
        }

        function initializeModalHandlers() {
            // Modal close handlers using event delegation
            document.addEventListener('click', function(e) {
                // Close history modal
                if (e.target.id === 'closeHistoryBottomBtn' || e.target.closest('#closeHistoryBottomBtn')) {
                    console.log('Closing history modal');
                    document.getElementById('historyModal').style.display = 'none';
                }
                
                // Close settings modal
                if (e.target.id === 'closeSettingsBottomBtn' || e.target.closest('#closeSettingsBottomBtn')) {
                    console.log('Closing settings modal');
                    document.getElementById('settingsModal').style.display = 'none';
                }
                
                // Close modals when clicking outside
                if (e.target.id === 'historyModal') {
                    document.getElementById('historyModal').style.display = 'none';
                }
                
                if (e.target.id === 'settingsModal') {
                    document.getElementById('settingsModal').style.display = 'none';
                }
                
                // Settings save handlers
                if (e.target.id === 'saveSettingsBtn' || e.target.closest('#saveSettingsBtn')) {
                    saveSettings();
                }
                
                if (e.target.id === 'resetSettingsBtn' || e.target.closest('#resetSettingsBtn')) {
                    resetSettings();
                }
            });
            
            // Also add ESC key support
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const historyModal = document.getElementById('historyModal');
                    const settingsModal = document.getElementById('settingsModal');
                    
                    if (historyModal && historyModal.style.display === 'flex') {
                        historyModal.style.display = 'none';
                    }
                    
                    if (settingsModal && settingsModal.style.display === 'flex') {
                        settingsModal.style.display = 'none';
                    }
                }
            });
        }

        // History Modal Functions
        function showHistoryModal() {
            const modal = document.getElementById('historyModal');
            const loading = document.getElementById('historyLoading');
            const content = document.getElementById('historyContent');
            
            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.innerHTML = '';
            
            // Fetch history data
            fetch('/performance_dashboard')
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    renderHistoryContent(data);
                })
                .catch(error => {
                    loading.style.display = 'none';
                    content.innerHTML = '<div style="color:#e74c3c; text-align:center; padding:2rem;"><i class="fas fa-exclamation-triangle"></i> Failed to load history data.</div>';
                    console.error('Error loading history:', error);
                });
        }

        function renderHistoryContent(data) {
            const content = document.getElementById('historyContent');
            
            if (!data || !data.recent_suggestions || data.recent_suggestions.length === 0) {
                content.innerHTML = `
                    <div style="text-align:center; padding:3rem; color:#666;">
                        <i class="fas fa-history" style="font-size:3rem; margin-bottom:1rem; opacity:0.3;"></i>
                        <h4>No History Yet</h4>
                        <p>Start analyzing documents to see your suggestion history here.</p>
                    </div>
                `;
                return;
            }

            // Overview stats
            const stats = data.overall_stats || {};
            let overviewHtml = `
                <div style="margin-bottom:2rem; padding:1rem; background:#f8f9fa; border-radius:8px;">
                    <h5 style="margin-bottom:1rem; color:#2c3e50;">Overview (Last 30 Days)</h5>
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:1rem;">
                        <div style="text-align:center;">
                            <div style="font-size:1.5rem; font-weight:bold; color:#3498db;">${stats.total_suggestions || 0}</div>
                            <div style="font-size:0.9rem; color:#666;">Total Suggestions</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:1.5rem; font-weight:bold; color:#27ae60;">${stats.avg_rating ? stats.avg_rating.toFixed(1) : 'N/A'}/5</div>
                            <div style="font-size:0.9rem; color:#666;">Avg Rating</div>
                        </div>
                    </div>
                </div>
            `;

            // Recent suggestions
            let historyHtml = `
                <h5 style="margin-bottom:1rem; color:#2c3e50;">Recent Suggestions</h5>
                <div style="max-height:400px; overflow-y:auto;">
            `;

            data.recent_suggestions.slice(0, 20).forEach((suggestion, index) => {
                const date = new Date(suggestion.timestamp).toLocaleDateString();
                const time = new Date(suggestion.timestamp).toLocaleTimeString();
                const rating = suggestion.user_rating ? '★'.repeat(suggestion.user_rating) + '☆'.repeat(5 - suggestion.user_rating) : 'Not rated';
                
                historyHtml += `
                    <div style="border:1px solid #ddd; border-radius:8px; padding:1rem; margin-bottom:1rem; background:white;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem;">
                            <div style="font-weight:bold; color:#2c3e50;">${suggestion.suggestion_method || 'AI'} Suggestion</div>
                            <div style="font-size:0.9rem; color:#666;">${date} ${time}</div>
                        </div>
                        <div style="margin-bottom:0.5rem; color:#666; font-size:0.9rem;">
                            <strong>Context:</strong> "${(suggestion.sentence_context || '').substring(0, 100)}${suggestion.sentence_context && suggestion.sentence_context.length > 100 ? '...' : ''}"
                        </div>
                        <div style="margin-bottom:0.5rem; padding:0.5rem; background:#f8f9fa; border-radius:4px; font-size:0.9rem;">
                            ${suggestion.feedback_text || 'No suggestion text available'}
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.9rem;">
                            <div style="color:#666;">
                                <span style="margin-right:1rem;">📄 ${suggestion.document_type || 'Unknown'}</span>
                                <span>⏱️ ${suggestion.response_time ? (suggestion.response_time * 1000).toFixed(0) + 'ms' : 'N/A'}</span>
                            </div>
                            <div style="color:#f39c12;">${rating}</div>
                        </div>
                        ${suggestion.user_feedback ? `<div style="margin-top:0.5rem; padding:0.5rem; background:#e8f5e8; border-radius:4px; font-size:0.9rem;"><strong>Your feedback:</strong> ${suggestion.user_feedback}</div>` : ''}
                    </div>
                `;
            });

            historyHtml += '</div>';
            content.innerHTML = overviewHtml + historyHtml;
        }

        // Settings Modal Functions
        function showSettingsModal() {
            const modal = document.getElementById('settingsModal');
            const loading = document.getElementById('settingsLoading');
            const content = document.getElementById('settingsContent');
            
            modal.style.display = 'flex';
            loading.style.display = 'block';
            content.innerHTML = '';
            
            // Fetch settings data
            fetch('/ai_config')
                .then(response => response.json())
                .then(data => {
                    loading.style.display = 'none';
                    renderSettingsContent(data);
                })
                .catch(error => {
                    loading.style.display = 'none';
                    content.innerHTML = '<div style="color:#e74c3c; text-align:center; padding:2rem;"><i class="fas fa-exclamation-triangle"></i> Failed to load settings.</div>';
                    console.error('Error loading settings:', error);
                });
        }

        function renderSettingsContent(data) {
            const content = document.getElementById('settingsContent');
            const config = data.suggestion_config || {};
            const flags = data.feature_flags || {};
            
            content.innerHTML = `
                <div style="margin-bottom:2rem;">
                    <h5 style="color:#2c3e50; margin-bottom:1rem;">
                        <i class="fas fa-brain" style="margin-right:8px; color:#3498db;"></i>
                        AI Suggestion Behavior
                    </h5>
                    <div style="display:grid; gap:1rem;">
                        <div>
                            <label style="display:block; margin-bottom:0.5rem; font-weight:500;">Confidence Threshold</label>
                            <input type="range" id="confidenceThreshold" min="0.1" max="1.0" step="0.05" value="${config.min_confidence_threshold || 0.7}" 
                                   style="width:100%;" onchange="updateConfidenceDisplay(this.value)">
                            <div style="display:flex; justify-content:space-between; font-size:0.8rem; color:#666;">
                                <span>More suggestions (0.1)</span>
                                <span id="confidenceValue">${((config.min_confidence_threshold || 0.7) * 100).toFixed(0)}%</span>
                                <span>Fewer, higher quality (1.0)</span>
                            </div>
                        </div>
                        
                        <div>
                            <label style="display:block; margin-bottom:0.5rem; font-weight:500;">Max Suggestions per Issue</label>
                            <select id="maxSuggestions" style="width:100%; padding:0.5rem; border:1px solid #ddd; border-radius:4px;">
                                <option value="1" selected>1 suggestion</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom:2rem;">
                    <h5 style="color:#2c3e50; margin-bottom:1rem;">
                        <i class="fas fa-toggle-on" style="margin-right:8px; color:#27ae60;"></i>
                        Feature Settings
                    </h5>
                    <div style="display:grid; gap:1rem;">
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="includeAlternatives" ${config.include_alternatives ? 'checked' : ''} style="margin-right:0.5rem;">
                            <span>Include alternative suggestions</span>
                            <div style="margin-left:auto; font-size:0.8rem; color:#666;">Provides multiple options for each issue</div>
                        </label>
                        
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="includeExplanations" ${config.include_explanations ? 'checked' : ''} style="margin-right:0.5rem;">
                            <span>Include explanations</span>
                            <div style="margin-left:auto; font-size:0.8rem; color:#666;">Explains why changes are suggested</div>
                        </label>
                        
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="personalizeToUser" ${config.personalize_to_user ? 'checked' : ''} style="margin-right:0.5rem;">
                            <span>Personalize suggestions</span>
                            <div style="margin-left:auto; font-size:0.8rem; color:#666;">Learn from your feedback and preferences</div>
                        </label>
                    </div>
                </div>

                <div>
                    <h5 style="color:#2c3e50; margin-bottom:1rem;">
                        <i class="fas fa-flask" style="margin-right:8px; color:#e67e22;"></i>
                        Advanced Features
                    </h5>
                    <div style="display:grid; gap:1rem;">
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="aiPoweredSuggestions" ${flags.ai_powered_suggestions !== false ? 'checked' : ''} style="margin-right:0.5rem;">
                            <span>AI-Powered Suggestions</span>
                            <div style="margin-left:auto; font-size:0.8rem; color:#666;">Use AI for complex grammar improvements</div>
                        </label>
                        
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="contextAwareAnalysis" ${flags.context_aware_analysis !== false ? 'checked' : ''} style="margin-right:0.5rem;">
                            <span>Context-Aware Analysis</span>
                            <div style="margin-left:auto; font-size:0.8rem; color:#666;">Consider document context for better suggestions</div>
                        </label>
                        
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="learningFromFeedback" ${flags.learning_from_feedback !== false ? 'checked' : ''} style="margin-right:0.5rem;">
                            <span>Learning from Feedback</span>
                            <div style="margin-left:auto; font-size:0.8rem; color:#666;">Improve suggestions based on your feedback</div>
                        </label>
                    </div>
                </div>
            `;
        }

        function updateConfidenceDisplay(value) {
            document.getElementById('confidenceValue').textContent = (value * 100).toFixed(0) + '%';
        }

        function saveSettings() {
            const saveBtn = document.getElementById('saveSettingsBtn');
            const originalText = saveBtn.innerHTML;
            
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
            saveBtn.disabled = true;
            
            const settings = {
                suggestion_config: {
                    min_confidence_threshold: parseFloat(document.getElementById('confidenceThreshold').value),
                    max_suggestions_per_issue: parseInt(document.getElementById('maxSuggestions').value),
                    include_alternatives: document.getElementById('includeAlternatives').checked,
                    include_explanations: document.getElementById('includeExplanations').checked,
                    personalize_to_user: document.getElementById('personalizeToUser').checked
                },
                feature_flags: {
                    ai_powered_suggestions: document.getElementById('aiPoweredSuggestions').checked,
                    context_aware_analysis: document.getElementById('contextAwareAnalysis').checked,
                    learning_from_feedback: document.getElementById('learningFromFeedback').checked
                }
            };
            
            fetch('/ai_config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                saveBtn.style.background = '#27ae60';
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }, 2000);
            })
            .catch(error => {
                saveBtn.innerHTML = '<i class="fas fa-times"></i> Error';
                saveBtn.style.background = '#e74c3c';
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }, 2000);
                console.error('Error saving settings:', error);
            });
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
                const settings = {
                    suggestion_config: {
                        min_confidence_threshold: 0.7,
                        max_suggestions_per_issue: 3,
                        include_alternatives: true,
                        include_explanations: true,
                        personalize_to_user: false
                    },
                    feature_flags: {
                        ai_powered_suggestions: true,
                        context_aware_analysis: true,
                        learning_from_feedback: true
                    }
                };
                
                fetch('/ai_config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                })
                .then(() => {
                    showSettingsModal(); // Reload the modal with new values
                })
                .catch(error => {
                    console.error('Error resetting settings:', error);
                });
            }
        }
    </script>
    <!-- Enhanced Loading Overlay with Circular Progress -->
    <div id="loadingOverlay" style="display:none;">
        <div class="progress-container">
            <div class="progress-title">
                <i class="fas fa-brain progress-icon"></i> Analyzing Document
            </div>
            
            <!-- Circular Progress Indicator -->
            <div class="circular-progress">
                <svg viewBox="0 0 150 150">
                    <defs>
                        <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#FFA500;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#FF6B6B;stop-opacity:1" />
                        </linearGradient>
                        <linearGradient id="completionGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#00FF88;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#00D4AA;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#0099CC;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="track" cx="75" cy="75" r="70"></circle>
                    <circle class="progress-ring" cx="75" cy="75" r="70" id="progressRing"></circle>
                </svg>
                <div class="progress-percentage" id="progressPercentage">0%</div>
            </div>
            
            <!-- Linear Progress Bar -->
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
            
            <div class="progress-message" id="progressMessage">Initializing analysis...</div>
            <div class="progress-stage" id="progressStage">Starting</div>
            
            <!-- Stage Indicators -->
            <div class="stage-indicators">
                <div class="stage-indicator" id="stage1" title="Parsing Document Structure"></div>
                <div class="stage-indicator" id="stage2" title="Segmenting into Sentences"></div>
                <div class="stage-indicator" id="stage3" title="Analyzing Content Quality"></div>
                <div class="stage-indicator" id="stage4" title="Generating Final Report"></div>
            </div>
        </div>
    </div>
    <div id="suggestionModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
    <div style="background:#fff; color:#222; padding:2rem; border-radius:8px; min-width:300px; max-width:90vw; max-height:80vh; overflow:auto; position:relative;">
        <button id="closeSuggestionModal" style="position:absolute; top:10px; right:10px;" class="btn btn-sm btn-secondary">&times;</button>
        <div id="suggestionLoading" style="display:none;">
        <span class="spinner-border spinner-border-sm"></span> Generating suggestion...
        </div>
        <div id="suggestionText"></div>
    </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; color:#222; padding:2rem; border-radius:12px; min-width:800px; max-width:90vw; max-height:80vh; overflow:auto; position:relative;">
            <h3 style="margin-top:0; color:#2c3e50; display:flex; align-items:center;">
                <i class="fas fa-history" style="margin-right:10px; color:#3498db;"></i>
                Suggestion History
            </h3>
            <div id="historyLoading" style="display:none; text-align:center; padding:2rem;">
                <span class="spinner-border spinner-border-sm"></span> Loading history...
            </div>
            <div id="historyContent"></div>
            <div style="margin-top:2rem; padding-top:1rem; border-top:1px solid #eee; text-align:right;">
                <button id="closeHistoryBottomBtn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:#fff; color:#222; padding:2rem; border-radius:12px; min-width:700px; max-width:90vw; max-height:80vh; overflow:auto; position:relative;">
            <h3 style="margin-top:0; color:#2c3e50; display:flex; align-items:center;">
                <i class="fas fa-cog" style="margin-right:10px; color:#e74c3c;"></i>
                AI Assistant Settings
            </h3>
            <div id="settingsLoading" style="display:none; text-align:center; padding:2rem;">
                <span class="spinner-border spinner-border-sm"></span> Loading settings...
            </div>
            <div id="settingsContent"></div>
            <div style="margin-top:2rem; padding-top:1rem; border-top:1px solid #eee; text-align:right;">
                <button id="saveSettingsBtn" class="btn btn-primary" style="margin-right:10px;">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button id="resetSettingsBtn" class="btn btn-outline-secondary" style="margin-right:10px;">
                    <i class="fas fa-undo"></i> Reset to Defaults
                </button>
                <button id="closeSettingsBottomBtn" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>

    <script>
    </script>
</body>
</html>